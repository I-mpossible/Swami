<?xml version='1.0' encoding='UTF-8'?><!DOCTYPE html PUBLIC '-//W3C//DTD XHTML 1.0 Strict//EN' 'http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd'><html xmlns='http://www.w3.org/1999/xhtml' lang='en'><head><meta http-equiv='Content-Type' content='text/html;charset=UTF-8'/><title>org.mozilla.javascript.regexp.NativeRegExpCtor.java</title><link rel='stylesheet' href='../.resources/report.css' type='text/css'/><link rel='stylesheet' href='../.resources/prettify.css' type='text/css'/><link rel='stylesheet' href='../.resources/custom.css' type='text/css'/><script type='text/javascript' src='../.resources/prettify.js'></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><h1>org.mozilla.javascript.regexp.NativeRegExpCtor.java</h1><table class='legend'><tr><td class='nc'>Not Covered</td><td class='ac'>Covered by test suite 1</td><td class='bc'>Covered by test suite 2</td><td class='uc'>Covered by the union test suite</td><td class='apc'>Partially Covered by test suite 1</td><td class='bpc'>Partially Covered by test suite 2</td><td class='upc'>Partially Covered by the union test suite</td></tr></table><pre class='source lang-java linenums'>/* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-
 *
 * This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at http://mozilla.org/MPL/2.0/. */

package org.mozilla.javascript.regexp;

import org.mozilla.javascript.*;

/**
 * This class implements the RegExp constructor native object.
 *
 * Revision History:
 * Implementation in C by Brendan Eich
 * Initial port to Java by Norris Boyd from jsregexp.c version 1.36
 * Merged up to version 1.38, which included Unicode support.
 * Merged bug fixes in version 1.39.
 * Merged JSFUN13_BRANCH changes up to 1.32.2.11
 *
 * @author Brendan Eich
 * @author Norris Boyd
 */
class NativeRegExpCtor extends BaseFunction
{
    static final long serialVersionUID = -5733330028285400526L;

    NativeRegExpCtor()
<span class='uc' id='L29' title='2|2|2 - Total: 2'>    {
</span><span class='uc' id='L30' title='1|1|1 - Total: 1'>    }
</span>
    @Override
    public String getFunctionName()
    {
<span class='uc' id='L35' title='2|2|2 - Total: 2'>        return "RegExp";
</span>    }

    @Override
    public int getLength() {
<span class='uc' id='L40' title='2|2|2 - Total: 2'>        return 2;
</span>    }

    @Override
    public int getArity() {
<span class='uc' id='L45' title='2|2|2 - Total: 2'>        return 2;
</span>    }

    @Override
    public Object call(Context cx, Scriptable scope, Scriptable thisObj,
                       Object[] args)
    {
<span class='upc' id='L52' title='6|6|6 - Total: 8'>        if (args.length > 0 && args[0] instanceof NativeRegExp &&
</span>            (args.length == 1 || args[1] == Undefined.instance))
        {
<span class='uc' id='L55' title='4|4|4 - Total: 4'>            return args[0];
</span>        }
<span class='uc' id='L57' title='6|6|6 - Total: 6'>        return construct(cx, scope, args);
</span>    }

    @Override
    public Scriptable construct(Context cx, Scriptable scope, Object[] args)
    {
<span class='uc' id='L63' title='4|4|4 - Total: 4'>        NativeRegExp re = new NativeRegExp();
</span><span class='uc' id='L64' title='6|6|6 - Total: 6'>        re.compile(cx, scope, args);
</span><span class='uc' id='L65' title='4|4|4 - Total: 4'>        ScriptRuntime.setBuiltinProtoAndParent(re, scope, TopLevel.Builtins.RegExp);
</span><span class='uc' id='L66' title='2|2|2 - Total: 2'>        return re;
</span>    }

    private static RegExpImpl getImpl()
    {
<span class='uc' id='L71' title='2|2|2 - Total: 2'>        Context cx = Context.getCurrentContext();
</span><span class='uc' id='L72' title='4|4|4 - Total: 4'>        return (RegExpImpl) ScriptRuntime.getRegExpProxy(cx);
</span>    }

// #string_id_map#

    private static final int
        Id_multiline     = 1,
        Id_STAR          = 2,  // #string=$*#

        Id_input         = 3,
        Id_UNDERSCORE    = 4,  // #string=$_#

        Id_lastMatch     = 5,
        Id_AMPERSAND     = 6,  // #string=$&#

        Id_lastParen     = 7,
        Id_PLUS          = 8,  // #string=$+#

        Id_leftContext   = 9,
        Id_BACK_QUOTE    = 10, // #string=$`#

        Id_rightContext  = 11,
        Id_QUOTE         = 12, // #string=$'#

        DOLLAR_ID_BASE   = 12;

    private static final int
        Id_DOLLAR_1 = DOLLAR_ID_BASE + 1, // #string=$1#
        Id_DOLLAR_2 = DOLLAR_ID_BASE + 2, // #string=$2#
        Id_DOLLAR_3 = DOLLAR_ID_BASE + 3, // #string=$3#
        Id_DOLLAR_4 = DOLLAR_ID_BASE + 4, // #string=$4#
        Id_DOLLAR_5 = DOLLAR_ID_BASE + 5, // #string=$5#
        Id_DOLLAR_6 = DOLLAR_ID_BASE + 6, // #string=$6#
        Id_DOLLAR_7 = DOLLAR_ID_BASE + 7, // #string=$7#
        Id_DOLLAR_8 = DOLLAR_ID_BASE + 8, // #string=$8#
        Id_DOLLAR_9 = DOLLAR_ID_BASE + 9, // #string=$9#

        MAX_INSTANCE_ID = DOLLAR_ID_BASE + 9;

    @Override
    protected int getMaxInstanceId()
    {
<span class='uc' id='L114' title='5|5|5 - Total: 5'>        return super.getMaxInstanceId() + MAX_INSTANCE_ID;
</span>    }

    @Override
    protected int findInstanceIdInfo(String s) {
        int id;
// #generated# Last update: 2001-05-24 16:09:31 GMT+02:00
<span class='uc' id='L121' title='4|4|4 - Total: 4'>        L0: { id = 0; String X = null; int c;
</span><span class='uc' id='L122' title='6|6|6 - Total: 6'>            L: switch (s.length()) {
</span><span class='upc' id='L123' title='15|15|15 - Total: 16'>            case 2: switch (s.charAt(1)) {
</span><span class='upc' id='L124' title='1|1|1 - Total: 2'>                case '&': if (s.charAt(0)=='$') {id=Id_AMPERSAND; break L0;} break L;
</span><span class='upc' id='L125' title='1|1|1 - Total: 2'>                case '\'': if (s.charAt(0)=='$') {id=Id_QUOTE; break L0;} break L;
</span><span class='upc' id='L126' title='1|1|1 - Total: 2'>                case '*': if (s.charAt(0)=='$') {id=Id_STAR; break L0;} break L;
</span><span class='upc' id='L127' title='1|1|1 - Total: 2'>                case '+': if (s.charAt(0)=='$') {id=Id_PLUS; break L0;} break L;
</span><span class='upc' id='L128' title='1|1|1 - Total: 2'>                case '1': if (s.charAt(0)=='$') {id=Id_DOLLAR_1; break L0;} break L;
</span><span class='upc' id='L129' title='1|1|1 - Total: 2'>                case '2': if (s.charAt(0)=='$') {id=Id_DOLLAR_2; break L0;} break L;
</span><span class='upc' id='L130' title='1|1|1 - Total: 2'>                case '3': if (s.charAt(0)=='$') {id=Id_DOLLAR_3; break L0;} break L;
</span><span class='upc' id='L131' title='1|1|1 - Total: 2'>                case '4': if (s.charAt(0)=='$') {id=Id_DOLLAR_4; break L0;} break L;
</span><span class='upc' id='L132' title='1|1|1 - Total: 2'>                case '5': if (s.charAt(0)=='$') {id=Id_DOLLAR_5; break L0;} break L;
</span><span class='upc' id='L133' title='1|1|1 - Total: 2'>                case '6': if (s.charAt(0)=='$') {id=Id_DOLLAR_6; break L0;} break L;
</span><span class='upc' id='L134' title='1|1|1 - Total: 2'>                case '7': if (s.charAt(0)=='$') {id=Id_DOLLAR_7; break L0;} break L;
</span><span class='upc' id='L135' title='1|1|1 - Total: 2'>                case '8': if (s.charAt(0)=='$') {id=Id_DOLLAR_8; break L0;} break L;
</span><span class='upc' id='L136' title='1|1|1 - Total: 2'>                case '9': if (s.charAt(0)=='$') {id=Id_DOLLAR_9; break L0;} break L;
</span><span class='upc' id='L137' title='1|1|1 - Total: 2'>                case '_': if (s.charAt(0)=='$') {id=Id_UNDERSCORE; break L0;} break L;
</span><span class='upc' id='L138' title='1|1|1 - Total: 2'>                case '`': if (s.charAt(0)=='$') {id=Id_BACK_QUOTE; break L0;} break L;
</span><span class='nc' id='L139' title='0|0|0 - Total: 1'>                } break L;
</span><span class='uc' id='L140' title='5|5|5 - Total: 5'>            case 5: X="input";id=Id_input; break L;
</span><span class='uc' id='L141' title='4|4|4 - Total: 4'>            case 9: c=s.charAt(4);
</span><span class='uc' id='L142' title='2|2|2 - Total: 2'>                if (c=='M') { X="lastMatch";id=Id_lastMatch; }
</span><span class='uc' id='L143' title='2|2|2 - Total: 2'>                else if (c=='P') { X="lastParen";id=Id_lastParen; }
</span><span class='uc' id='L144' title='2|2|2 - Total: 2'>                else if (c=='i') { X="multiline";id=Id_multiline; }
</span>                break L;
<span class='uc' id='L146' title='5|5|5 - Total: 5'>            case 11: X="leftContext";id=Id_leftContext; break L;
</span><span class='uc' id='L147' title='5|5|5 - Total: 5'>            case 12: X="rightContext";id=Id_rightContext; break L;
</span>            }
<span class='uc' id='L149' title='6|6|6 - Total: 6'>            if (X!=null && X!=s && !X.equals(s)) id = 0;
</span>        }
// #/generated#

<span class='uc' id='L153' title='2|2|2 - Total: 2'>        if (id == 0) return super.findInstanceIdInfo(s);
</span>
        int attr;
<span class='uc' id='L156' title='5|5|5 - Total: 5'>        switch (id) {
</span>          case Id_multiline:
<span class='uc' id='L158' title='3|3|3 - Total: 3'>            attr = multilineAttr;
</span><span class='uc' id='L159' title='1|1|1 - Total: 1'>            break;
</span>          case Id_STAR:
<span class='uc' id='L161' title='3|3|3 - Total: 3'>            attr = starAttr;
</span><span class='uc' id='L162' title='1|1|1 - Total: 1'>            break;
</span>          case Id_input:
<span class='uc' id='L164' title='3|3|3 - Total: 3'>            attr = inputAttr;
</span><span class='uc' id='L165' title='1|1|1 - Total: 1'>            break;
</span>          case Id_UNDERSCORE:
<span class='uc' id='L167' title='3|3|3 - Total: 3'>            attr = underscoreAttr;
</span><span class='uc' id='L168' title='1|1|1 - Total: 1'>            break;
</span>          default:
<span class='uc' id='L170' title='2|2|2 - Total: 2'>            attr = PERMANENT | READONLY;
</span>            break;
        }

<span class='uc' id='L174' title='7|7|7 - Total: 7'>        return instanceIdInfo(attr, super.getMaxInstanceId() + id);
</span>    }

// #/string_id_map#

    @Override
    protected String getInstanceIdName(int id)
    {
<span class='uc' id='L182' title='5|5|5 - Total: 5'>        int shifted = id - super.getMaxInstanceId();
</span><span class='upc' id='L183' title='3|3|3 - Total: 4'>        if (1 <= shifted && shifted <= MAX_INSTANCE_ID) {
</span><span class='uc' id='L184' title='13|13|13 - Total: 13'>            switch (shifted) {
</span><span class='uc' id='L185' title='2|2|2 - Total: 2'>                case Id_multiline:    return "multiline";
</span><span class='uc' id='L186' title='2|2|2 - Total: 2'>                case Id_STAR:         return "$*";
</span>
<span class='uc' id='L188' title='2|2|2 - Total: 2'>                case Id_input:        return "input";
</span><span class='uc' id='L189' title='2|2|2 - Total: 2'>                case Id_UNDERSCORE:   return "$_";
</span>
<span class='uc' id='L191' title='2|2|2 - Total: 2'>                case Id_lastMatch:    return "lastMatch";
</span><span class='uc' id='L192' title='2|2|2 - Total: 2'>                case Id_AMPERSAND:    return "$&";
</span>
<span class='uc' id='L194' title='2|2|2 - Total: 2'>                case Id_lastParen:    return "lastParen";
</span><span class='uc' id='L195' title='2|2|2 - Total: 2'>                case Id_PLUS:         return "$+";
</span>
<span class='uc' id='L197' title='2|2|2 - Total: 2'>                case Id_leftContext:  return "leftContext";
</span><span class='uc' id='L198' title='2|2|2 - Total: 2'>                case Id_BACK_QUOTE:   return "$`";
</span>
<span class='uc' id='L200' title='2|2|2 - Total: 2'>                case Id_rightContext: return "rightContext";
</span><span class='uc' id='L201' title='2|2|2 - Total: 2'>                case Id_QUOTE:        return "$'";
</span>            }
            // Must be one of $1..$9, convert to 0..8
<span class='uc' id='L204' title='6|6|6 - Total: 6'>            int substring_number = shifted - DOLLAR_ID_BASE - 1;
</span><span class='uc' id='L205' title='14|14|14 - Total: 14'>            char[] buf = { '$', (char)('1' + substring_number) };
</span><span class='uc' id='L206' title='5|5|5 - Total: 5'>            return new String(buf);
</span>        }
<span class='uc' id='L208' title='4|4|4 - Total: 4'>        return super.getInstanceIdName(id);
</span>    }

    @Override
    protected Object getInstanceIdValue(int id)
    {
<span class='uc' id='L214' title='5|5|5 - Total: 5'>        int shifted = id - super.getMaxInstanceId();
</span><span class='upc' id='L215' title='3|3|3 - Total: 4'>        if (1 <= shifted && shifted <= MAX_INSTANCE_ID) {
</span><span class='uc' id='L216' title='2|2|2 - Total: 2'>            RegExpImpl impl = getImpl();
</span>            Object stringResult;
<span class='uc' id='L218' title='7|7|7 - Total: 7'>            switch (shifted) {
</span>              case Id_multiline:
              case Id_STAR:
<span class='uc' id='L221' title='4|4|4 - Total: 4'>                return ScriptRuntime.wrapBoolean(impl.multiline);
</span>
              case Id_input:
              case Id_UNDERSCORE:
<span class='uc' id='L225' title='3|3|3 - Total: 3'>                stringResult = impl.input;
</span><span class='uc' id='L226' title='1|1|1 - Total: 1'>                break;
</span>
              case Id_lastMatch:
              case Id_AMPERSAND:
<span class='uc' id='L230' title='3|3|3 - Total: 3'>                stringResult = impl.lastMatch;
</span><span class='uc' id='L231' title='1|1|1 - Total: 1'>                break;
</span>
              case Id_lastParen:
              case Id_PLUS:
<span class='uc' id='L235' title='3|3|3 - Total: 3'>                stringResult = impl.lastParen;
</span><span class='uc' id='L236' title='1|1|1 - Total: 1'>                break;
</span>
              case Id_leftContext:
              case Id_BACK_QUOTE:
<span class='uc' id='L240' title='3|3|3 - Total: 3'>                stringResult = impl.leftContext;
</span><span class='uc' id='L241' title='1|1|1 - Total: 1'>                break;
</span>
              case Id_rightContext:
              case Id_QUOTE:
<span class='uc' id='L245' title='3|3|3 - Total: 3'>                stringResult = impl.rightContext;
</span><span class='uc' id='L246' title='1|1|1 - Total: 1'>                break;
</span>
              default:
                {
                    // Must be one of $1..$9, convert to 0..8
<span class='uc' id='L251' title='6|6|6 - Total: 6'>                    int substring_number = shifted - DOLLAR_ID_BASE - 1;
</span><span class='uc' id='L252' title='4|4|4 - Total: 4'>                    stringResult = impl.getParenSubString(substring_number);
</span><span class='uc' id='L253' title='1|1|1 - Total: 1'>                    break;
</span>                }
            }
<span class='uc' id='L256' title='2|2|2 - Total: 2'>            return (stringResult == null) ? "" : stringResult.toString();
</span>        }
<span class='uc' id='L258' title='4|4|4 - Total: 4'>        return super.getInstanceIdValue(id);
</span>    }

    @Override
    protected void setInstanceIdValue(int id, Object value)
    {
<span class='uc' id='L264' title='5|5|5 - Total: 5'>        int shifted = id - super.getMaxInstanceId();
</span><span class='upc' id='L265' title='2|2|2 - Total: 4'>        switch (shifted) {
</span>            case Id_multiline:
            case Id_STAR:
<span class='uc' id='L268' title='4|4|4 - Total: 4'>                getImpl().multiline = ScriptRuntime.toBoolean(value);
</span><span class='uc' id='L269' title='1|1|1 - Total: 1'>                return;
</span>
            case Id_input:
            case Id_UNDERSCORE:
<span class='uc' id='L273' title='4|4|4 - Total: 4'>                getImpl().input = ScriptRuntime.toString(value);
</span><span class='uc' id='L274' title='1|1|1 - Total: 1'>                return;
</span>
            case Id_lastMatch:
            case Id_AMPERSAND:
            case Id_lastParen:
            case Id_PLUS:
            case Id_leftContext:
            case Id_BACK_QUOTE:
            case Id_rightContext:
            case Id_QUOTE:
<span class='nc' id='L284' title='0|0|0 - Total: 1'>                return;
</span>            default:
<span class='nc' id='L286' title='0|0|0 - Total: 6'>                int substring_number = shifted - DOLLAR_ID_BASE - 1;
</span><span class='nc' id='L287' title='0|0|0 - Total: 4'>                if (0 <= substring_number && substring_number <= 8) {
</span><span class='nc' id='L288' title='0|0|0 - Total: 1'>                  return;
</span>                }
        }
<span class='nc' id='L291' title='0|0|0 - Total: 4'>        super.setInstanceIdValue(id, value);
</span><span class='nc' id='L292' title='0|0|0 - Total: 1'>    }
</span>
    @Override
    protected void setInstanceIdAttributes(int id, int attr) {
<span class='nc' id='L296' title='0|0|0 - Total: 5'>        int shifted = id - super.getMaxInstanceId();
</span><span class='nc' id='L297' title='0|0|0 - Total: 6'>        switch (shifted) {
</span>            case Id_multiline:
<span class='nc' id='L299' title='0|0|0 - Total: 3'>                multilineAttr = attr;
</span><span class='nc' id='L300' title='0|0|0 - Total: 1'>                return;
</span>            case Id_STAR:
<span class='nc' id='L302' title='0|0|0 - Total: 3'>                starAttr = attr;
</span><span class='nc' id='L303' title='0|0|0 - Total: 1'>                return;
</span>            case Id_input:
<span class='nc' id='L305' title='0|0|0 - Total: 3'>                inputAttr = attr;
</span><span class='nc' id='L306' title='0|0|0 - Total: 1'>                return;
</span>            case Id_UNDERSCORE:
<span class='nc' id='L308' title='0|0|0 - Total: 3'>                underscoreAttr = attr;
</span><span class='nc' id='L309' title='0|0|0 - Total: 1'>                return;
</span>
            case Id_lastMatch:
            case Id_AMPERSAND:
            case Id_lastParen:
            case Id_PLUS:
            case Id_leftContext:
            case Id_BACK_QUOTE:
            case Id_rightContext:
            case Id_QUOTE:
                // non-configurable + non-writable
<span class='nc' id='L320' title='0|0|0 - Total: 1'>                return;
</span>            default:
<span class='nc' id='L322' title='0|0|0 - Total: 6'>                int substring_number = shifted - DOLLAR_ID_BASE - 1;
</span><span class='nc' id='L323' title='0|0|0 - Total: 4'>                if (0 <= substring_number && substring_number <= 8) {
</span>                  // non-configurable + non-writable
<span class='nc' id='L325' title='0|0|0 - Total: 1'>                  return;
</span>                }
        }
<span class='nc' id='L328' title='0|0|0 - Total: 4'>        super.setInstanceIdAttributes(id, attr);
</span><span class='nc' id='L329' title='0|0|0 - Total: 1'>    }
</span>
<span class='uc' id='L331' title='3|3|3 - Total: 3'>    private int multilineAttr = PERMANENT;
</span><span class='uc' id='L332' title='3|3|3 - Total: 3'>    private int starAttr = PERMANENT;
</span><span class='uc' id='L333' title='3|3|3 - Total: 3'>    private int inputAttr = PERMANENT;
</span><span class='uc' id='L334' title='3|3|3 - Total: 3'>    private int underscoreAttr = PERMANENT;
</span>}
</pre></body></html><table class='legend'><tr><td class='nc'>Not Covered</td><td class='ac'>Covered by test suite 1</td><td class='bc'>Covered by test suite 2</td><td class='uc'>Covered by the union test suite</td><td class='apc'>Partially Covered by test suite 1</td><td class='bpc'>Partially Covered by test suite 2</td><td class='upc'>Partially Covered by the union test suite</td></tr></table>