<?xml version='1.0' encoding='UTF-8'?><!DOCTYPE html PUBLIC '-//W3C//DTD XHTML 1.0 Strict//EN' 'http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd'><html xmlns='http://www.w3.org/1999/xhtml' lang='en'><head><meta http-equiv='Content-Type' content='text/html;charset=UTF-8'/><title>org.mozilla.javascript.optimizer.OptRuntime.java</title><link rel='stylesheet' href='../.resources/report.css' type='text/css'/><link rel='stylesheet' href='../.resources/prettify.css' type='text/css'/><link rel='stylesheet' href='../.resources/custom.css' type='text/css'/><script type='text/javascript' src='../.resources/prettify.js'></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><h1>org.mozilla.javascript.optimizer.OptRuntime.java</h1><table class='legend'><tr><td class='nc'>Not Covered</td><td class='ac'>Covered by test suite 1</td><td class='bc'>Covered by test suite 2</td><td class='uc'>Covered by the union test suite</td><td class='apc'>Partially Covered by test suite 1</td><td class='bpc'>Partially Covered by test suite 2</td><td class='upc'>Partially Covered by the union test suite</td></tr></table><pre class='source lang-java linenums'>/* This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at http://mozilla.org/MPL/2.0/. */


package org.mozilla.javascript.optimizer;

import org.mozilla.javascript.*;

<span class='nc' id='L10' title='0|0|0 - Total: 3'>public final class OptRuntime extends ScriptRuntime
</span>{

<span class='uc' id='L13' title='5|5|5 - Total: 5'>    public static final Double zeroObj = new Double(0.0);
</span><span class='uc' id='L14' title='5|5|5 - Total: 5'>    public static final Double oneObj = new Double(1.0);
</span><span class='uc' id='L15' title='6|6|6 - Total: 6'>    public static final Double minusOneObj = new Double(-1.0);
</span>
    /**
     * Implement ....() call shrinking optimizer code.
     */
    public static Object call0(Callable fun, Scriptable thisObj,
                               Context cx, Scriptable scope)
    {
<span class='uc' id='L23' title='7|7|7 - Total: 7'>        return fun.call(cx, scope, thisObj, ScriptRuntime.emptyArgs);
</span>    }

    /**
     * Implement ....(arg) call shrinking optimizer code.
     */
    public static Object call1(Callable fun, Scriptable thisObj, Object arg0,
                               Context cx, Scriptable scope)
    {
<span class='uc' id='L32' title='12|12|12 - Total: 12'>        return fun.call(cx, scope, thisObj, new Object[] { arg0 } );
</span>    }

    /**
     * Implement ....(arg0, arg1) call shrinking optimizer code.
     */
    public static Object call2(Callable fun, Scriptable thisObj,
                               Object arg0, Object arg1,
                               Context cx, Scriptable scope)
    {
<span class='uc' id='L42' title='16|16|16 - Total: 16'>        return fun.call(cx, scope, thisObj, new Object[] { arg0, arg1 });
</span>    }

    /**
     * Implement ....(arg0, arg1, ...) call shrinking optimizer code.
     */
    public static Object callN(Callable fun, Scriptable thisObj,
                               Object[] args,
                               Context cx, Scriptable scope)
    {
<span class='uc' id='L52' title='7|7|7 - Total: 7'>        return fun.call(cx, scope, thisObj, args);
</span>    }

    /**
     * Implement name(args) call shrinking optimizer code.
     */
    public static Object callName(Object[] args, String name,
                                  Context cx, Scriptable scope)
    {
<span class='uc' id='L61' title='5|5|5 - Total: 5'>        Callable f = getNameFunctionAndThis(name, cx, scope);
</span><span class='uc' id='L62' title='3|3|3 - Total: 3'>        Scriptable thisObj = lastStoredScriptable(cx);
</span><span class='uc' id='L63' title='7|7|7 - Total: 7'>        return f.call(cx, scope, thisObj, args);
</span>    }

    /**
     * Implement name() call shrinking optimizer code.
     */
    public static Object callName0(String name,
                                   Context cx, Scriptable scope)
    {
<span class='uc' id='L72' title='5|5|5 - Total: 5'>        Callable f = getNameFunctionAndThis(name, cx, scope);
</span><span class='uc' id='L73' title='3|3|3 - Total: 3'>        Scriptable thisObj = lastStoredScriptable(cx);
</span><span class='uc' id='L74' title='7|7|7 - Total: 7'>        return f.call(cx, scope, thisObj, ScriptRuntime.emptyArgs);
</span>    }

    /**
     * Implement x.property() call shrinking optimizer code.
     */
    public static Object callProp0(Object value, String property,
                                   Context cx, Scriptable scope)
    {
<span class='uc' id='L83' title='6|6|6 - Total: 6'>        Callable f = getPropFunctionAndThis(value, property, cx, scope);
</span><span class='uc' id='L84' title='3|3|3 - Total: 3'>        Scriptable thisObj = lastStoredScriptable(cx);
</span><span class='uc' id='L85' title='7|7|7 - Total: 7'>        return f.call(cx, scope, thisObj, ScriptRuntime.emptyArgs);
</span>    }

    public static Object add(Object val1, double val2)
    {
<span class='uc' id='L90' title='2|2|2 - Total: 2'>        if (val1 instanceof Scriptable)
</span><span class='uc' id='L91' title='5|5|5 - Total: 5'>            val1 = ((Scriptable) val1).getDefaultValue(null);
</span><span class='uc' id='L92' title='2|2|2 - Total: 2'>        if (!(val1 instanceof CharSequence))
</span><span class='uc' id='L93' title='6|6|6 - Total: 6'>            return wrapDouble(toNumber(val1) + val2);
</span><span class='uc' id='L94' title='8|8|8 - Total: 8'>        return new ConsString((CharSequence)val1, toString(val2));
</span>    }

    public static Object add(double val1, Object val2)
    {
<span class='uc' id='L99' title='2|2|2 - Total: 2'>        if (val2 instanceof Scriptable)
</span><span class='uc' id='L100' title='5|5|5 - Total: 5'>            val2 = ((Scriptable) val2).getDefaultValue(null);
</span><span class='uc' id='L101' title='2|2|2 - Total: 2'>        if (!(val2 instanceof CharSequence))
</span><span class='uc' id='L102' title='6|6|6 - Total: 6'>            return wrapDouble(toNumber(val2) + val1);
</span><span class='uc' id='L103' title='8|8|8 - Total: 8'>        return new ConsString(toString(val1), (CharSequence)val2);
</span>    }

    /**
     * @deprecated Use {@link #elemIncrDecr(Object, double, Context, Scriptable, int)} instead
     */
    @Deprecated
    public static Object elemIncrDecr(Object obj, double index,
                                      Context cx, int incrDecrMask)
    {
<span class='nc' id='L113' title='0|0|0 - Total: 8'>        return elemIncrDecr(obj, index, cx, getTopCallScope(cx), incrDecrMask);
</span>    }

    public static Object elemIncrDecr(Object obj, double index,
                                      Context cx, Scriptable scope,
                                      int incrDecrMask)
    {
<span class='nc' id='L120' title='0|0|0 - Total: 10'>        return ScriptRuntime.elemIncrDecr(obj, new Double(index), cx, scope,
</span>                                          incrDecrMask);
    }

    public static Object[] padStart(Object[] currentArgs, int count) {
<span class='nc' id='L125' title='0|0|0 - Total: 6'>        Object[] result = new Object[currentArgs.length + count];
</span><span class='nc' id='L126' title='0|0|0 - Total: 7'>        System.arraycopy(currentArgs, 0, result, count, currentArgs.length);
</span><span class='nc' id='L127' title='0|0|0 - Total: 2'>        return result;
</span>    }

    public static void initFunction(NativeFunction fn, int functionType,
                                    Scriptable scope, Context cx)
    {
<span class='uc' id='L133' title='6|6|6 - Total: 6'>        ScriptRuntime.initFunction(cx, scope, fn, functionType, false);
</span><span class='uc' id='L134' title='1|1|1 - Total: 1'>    }
</span>
    public static Function bindThis(NativeFunction fn, Context cx, Scriptable scope, Scriptable thisObj)
    {
<span class='uc' id='L138' title='8|8|8 - Total: 8'>        return new ArrowFunction(cx, scope, fn, thisObj);
</span>    }

    public static Object callSpecial(Context cx, Callable fun,
                                     Scriptable thisObj, Object[] args,
                                     Scriptable scope,
                                     Scriptable callerThis, int callType,
                                     String fileName, int lineNumber)
    {
<span class='uc' id='L147' title='11|11|11 - Total: 11'>        return ScriptRuntime.callSpecial(cx, fun, thisObj, args, scope,
</span>                                         callerThis, callType,
                                         fileName, lineNumber);
    }

    public static Object newObjectSpecial(Context cx, Object fun,
                                          Object[] args, Scriptable scope,
                                          Scriptable callerThis, int callType)
    {
<span class='nc' id='L156' title='0|0|0 - Total: 7'>        return ScriptRuntime.newSpecial(cx, fun, args, scope, callType);
</span>    }

    public static Double wrapDouble(double num)
    {
<span class='uc' id='L161' title='2|2|2 - Total: 2'>        if (num == 0.0) {
</span><span class='uc' id='L162' title='2|2|2 - Total: 2'>            if (1 / num > 0) {
</span>                // +0.0
<span class='uc' id='L164' title='2|2|2 - Total: 2'>                return zeroObj;
</span>            }
<span class='uc' id='L166' title='2|2|2 - Total: 2'>        } else if (num == 1.0) {
</span><span class='uc' id='L167' title='2|2|2 - Total: 2'>            return oneObj;
</span><span class='uc' id='L168' title='2|2|2 - Total: 2'>        } else if (num == -1.0) {
</span><span class='uc' id='L169' title='2|2|2 - Total: 2'>            return minusOneObj;
</span><span class='uc' id='L170' title='2|2|2 - Total: 2'>        } else if (num != num) {
</span><span class='uc' id='L171' title='2|2|2 - Total: 2'>            return NaNobj;
</span>        }
<span class='uc' id='L173' title='5|5|5 - Total: 5'>        return new Double(num);
</span>    }

    static String encodeIntArray(int[] array)
    {
        // XXX: this extremely inefficient for small integers
<span class='upc' id='L179' title='1|1|1 - Total: 2'>        if (array == null) { return null; }
</span><span class='uc' id='L180' title='3|3|3 - Total: 3'>        int n = array.length;
</span><span class='uc' id='L181' title='7|7|7 - Total: 7'>        char[] buffer = new char[1 + n * 2];
</span><span class='uc' id='L182' title='4|4|4 - Total: 4'>        buffer[0] = 1;
</span><span class='uc' id='L183' title='2|2|2 - Total: 2'>        for (int i = 0; i != n; ++i) {
</span><span class='uc' id='L184' title='4|4|4 - Total: 4'>            int value = array[i];
</span><span class='uc' id='L185' title='6|6|6 - Total: 6'>            int shift = 1 + i * 2;
</span><span class='uc' id='L186' title='7|7|7 - Total: 7'>            buffer[shift] = (char)(value >>> 16);
</span><span class='uc' id='L187' title='7|7|7 - Total: 7'>            buffer[shift + 1] = (char)value;
</span>        }
<span class='uc' id='L189' title='5|5|5 - Total: 5'>        return new String(buffer);
</span>    }

    private static int[] decodeIntArray(String str, int arraySize)
    {
        // XXX: this extremely inefficient for small integers
<span class='uc' id='L195' title='2|2|2 - Total: 2'>        if (arraySize == 0) {
</span><span class='upc' id='L196' title='1|1|1 - Total: 2'>            if (str != null) throw new IllegalArgumentException();
</span><span class='uc' id='L197' title='2|2|2 - Total: 2'>            return null;
</span>        }
<span class='upc' id='L199' title='1|1|1 - Total: 4'>        if (str.length() != 1 + arraySize * 2 && str.charAt(0) != 1) {
</span><span class='nc' id='L200' title='0|0|0 - Total: 4'>            throw new IllegalArgumentException();
</span>        }
<span class='uc' id='L202' title='3|3|3 - Total: 3'>        int[] array = new int[arraySize];
</span><span class='uc' id='L203' title='2|2|2 - Total: 2'>        for (int i = 0; i != arraySize; ++i) {
</span><span class='uc' id='L204' title='6|6|6 - Total: 6'>            int shift = 1 + i * 2;
</span><span class='uc' id='L205' title='14|14|14 - Total: 14'>            array[i] = (str.charAt(shift) << 16) | str.charAt(shift + 1);
</span>        }
<span class='uc' id='L207' title='2|2|2 - Total: 2'>        return array;
</span>    }

    public static Scriptable newArrayLiteral(Object[] objects,
                                             String encodedInts,
                                             int skipCount,
                                             Context cx,
                                             Scriptable scope)
    {
<span class='uc' id='L216' title='4|4|4 - Total: 4'>        int[] skipIndexces = decodeIntArray(encodedInts, skipCount);
</span><span class='uc' id='L217' title='6|6|6 - Total: 6'>        return newArrayLiteral(objects, skipIndexces, cx, scope);
</span>    }

    public static void main(final Script script, final String[] args)
    {
<span class='nc' id='L222' title='0|0|0 - Total: 8'>        ContextFactory.getGlobal().call(new ContextAction() {
</span>            public Object run(Context cx)
            {
                ScriptableObject global = getGlobal(cx);

                // get the command line arguments and define "arguments"
                // array in the top-level object
                Object[] argsCopy = new Object[args.length];
                System.arraycopy(args, 0, argsCopy, 0, args.length);
                Scriptable argsObj = cx.newArray(global, argsCopy);
                global.defineProperty("arguments", argsObj,
                                      ScriptableObject.DONTENUM);
                script.exec(cx, global);
                return null;
            }
        });
<span class='nc' id='L238' title='0|0|0 - Total: 1'>    }
</span>
    public static void throwStopIteration(Object obj) {
<span class='uc' id='L241' title='4|4|4 - Total: 4'>        throw new JavaScriptException(
</span><span class='uc' id='L242' title='5|5|5 - Total: 5'>            NativeIterator.getStopIterationObject((Scriptable)obj), "", 0);
</span>    }

    public static Scriptable createNativeGenerator(NativeFunction funObj,
                                                   Scriptable scope,
                                                   Scriptable thisObj,
                                                   int maxLocals,
                                                   int maxStack)
    {
<span class='uc' id='L251' title='12|12|12 - Total: 12'>        return new NativeGenerator(scope, funObj,
</span>                new GeneratorState(thisObj, maxLocals, maxStack));
    }

    public static Object[] getGeneratorStackState(Object obj) {
<span class='uc' id='L256' title='3|3|3 - Total: 3'>        GeneratorState rgs = (GeneratorState) obj;
</span><span class='uc' id='L257' title='2|2|2 - Total: 2'>        if (rgs.stackState == null)
</span><span class='uc' id='L258' title='5|5|5 - Total: 5'>            rgs.stackState = new Object[rgs.maxStack];
</span><span class='uc' id='L259' title='3|3|3 - Total: 3'>        return rgs.stackState;
</span>    }

    public static Object[] getGeneratorLocalsState(Object obj) {
<span class='uc' id='L263' title='3|3|3 - Total: 3'>        GeneratorState rgs = (GeneratorState) obj;
</span><span class='uc' id='L264' title='2|2|2 - Total: 2'>        if (rgs.localsState == null)
</span><span class='uc' id='L265' title='5|5|5 - Total: 5'>            rgs.localsState = new Object[rgs.maxLocals];
</span><span class='uc' id='L266' title='3|3|3 - Total: 3'>        return rgs.localsState;
</span>    }

    public static class GeneratorState {
        static final String CLASS_NAME =
            "org/mozilla/javascript/optimizer/OptRuntime$GeneratorState";

        public int resumptionPoint;
        static final String resumptionPoint_NAME = "resumptionPoint";
        static final String resumptionPoint_TYPE = "I";

        public Scriptable thisObj;
        static final String thisObj_NAME = "thisObj";
        static final String thisObj_TYPE =
            "Lorg/mozilla/javascript/Scriptable;";

        Object[] stackState;
        Object[] localsState;
        int maxLocals;
        int maxStack;

        GeneratorState(Scriptable thisObj, int maxLocals, int maxStack) {
            this.thisObj = thisObj;
            this.maxLocals = maxLocals;
            this.maxStack = maxStack;
        }
    }
}
</pre></body></html><table class='legend'><tr><td class='nc'>Not Covered</td><td class='ac'>Covered by test suite 1</td><td class='bc'>Covered by test suite 2</td><td class='uc'>Covered by the union test suite</td><td class='apc'>Partially Covered by test suite 1</td><td class='bpc'>Partially Covered by test suite 2</td><td class='upc'>Partially Covered by the union test suite</td></tr></table>