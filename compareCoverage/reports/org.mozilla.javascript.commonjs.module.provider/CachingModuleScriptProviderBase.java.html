<?xml version='1.0' encoding='UTF-8'?><!DOCTYPE html PUBLIC '-//W3C//DTD XHTML 1.0 Strict//EN' 'http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd'><html xmlns='http://www.w3.org/1999/xhtml' lang='en'><head><meta http-equiv='Content-Type' content='text/html;charset=UTF-8'/><title>org.mozilla.javascript.commonjs.module.provider.CachingModuleScriptProviderBase.java</title><link rel='stylesheet' href='../.resources/report.css' type='text/css'/><link rel='stylesheet' href='../.resources/prettify.css' type='text/css'/><link rel='stylesheet' href='../.resources/custom.css' type='text/css'/><script type='text/javascript' src='../.resources/prettify.js'></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><h1>org.mozilla.javascript.commonjs.module.provider.CachingModuleScriptProviderBase.java</h1><table class='legend'><tr><td class='nc'>Not Covered</td><td class='ac'>Covered by test suite 1</td><td class='bc'>Covered by test suite 2</td><td class='uc'>Covered by the union test suite</td><td class='apc'>Partially Covered by test suite 1</td><td class='bpc'>Partially Covered by test suite 2</td><td class='upc'>Partially Covered by the union test suite</td></tr></table><pre class='source lang-java linenums'>/* This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at http://mozilla.org/MPL/2.0/. */

package org.mozilla.javascript.commonjs.module.provider;

import java.io.Reader;
import java.io.Serializable;
import java.net.URI;

import org.mozilla.javascript.Context;
import org.mozilla.javascript.Scriptable;
import org.mozilla.javascript.commonjs.module.ModuleScript;
import org.mozilla.javascript.commonjs.module.ModuleScriptProvider;

/**
 * Abstract base class that implements caching of loaded module scripts. It
 * uses a {@link ModuleSourceProvider} to obtain the source text of the
 * scripts. It supports a cache revalidation mechanism based on validator
 * objects returned from the {@link ModuleSourceProvider}. Instances of this
 * class and its subclasses are thread safe (and written to perform decently
 * under concurrent access).
 * @author Attila Szegedi
 * @version $Id: CachingModuleScriptProviderBase.java,v 1.3 2011/04/07 20:26:12 hannes%helma.at Exp $
 */
public abstract class CachingModuleScriptProviderBase
implements ModuleScriptProvider, Serializable
{
    private static final long serialVersionUID = 1L;

    private static final int loadConcurrencyLevel =
<span class='bc' id='L32' title='0|5|5 - Total: 5'>        Runtime.getRuntime().availableProcessors() * 8;
</span>    private static final int loadLockShift;
    private static final int loadLockMask;
    private static final int loadLockCount;
    static {
<span class='bc' id='L37' title='0|2|2 - Total: 2'>        int sshift = 0;
</span><span class='bc' id='L38' title='0|2|2 - Total: 2'>        int ssize = 1;
</span><span class='bc' id='L39' title='0|2|2 - Total: 2'>        while (ssize < loadConcurrencyLevel) {
</span><span class='bc' id='L40' title='0|1|1 - Total: 1'>            ++sshift;
</span><span class='bc' id='L41' title='0|5|5 - Total: 5'>            ssize <<= 1;
</span>        }
<span class='bc' id='L43' title='0|4|4 - Total: 4'>        loadLockShift = 32 - sshift;
</span><span class='bc' id='L44' title='0|4|4 - Total: 4'>        loadLockMask = ssize - 1;
</span><span class='bc' id='L45' title='0|2|2 - Total: 2'>        loadLockCount = ssize;
</span><span class='bc' id='L46' title='0|1|1 - Total: 1'>    }
</span><span class='bc' id='L47' title='0|4|4 - Total: 4'>    private final Object[] loadLocks = new Object[loadLockCount]; {
</span><span class='bc' id='L48' title='0|2|2 - Total: 2'>        for(int i = 0; i < loadLocks.length; ++i) {
</span><span class='bc' id='L49' title='0|7|7 - Total: 7'>            loadLocks[i] = new Object();
</span>        }
    }

    private final ModuleSourceProvider moduleSourceProvider;

    /**
     * Creates a new module script provider with the specified source.
     * @param moduleSourceProvider provider for modules' source code
     */
    protected CachingModuleScriptProviderBase(
<span class='bc' id='L60' title='0|2|2 - Total: 2'>            ModuleSourceProvider moduleSourceProvider) {
</span><span class='bc' id='L61' title='0|3|3 - Total: 3'>        this.moduleSourceProvider = moduleSourceProvider;
</span><span class='bc' id='L62' title='0|1|1 - Total: 1'>    }
</span>
    public ModuleScript getModuleScript(Context cx, String moduleId,
            URI moduleUri, URI baseUri, Scriptable paths) throws Exception
    {
<span class='bc' id='L67' title='0|4|4 - Total: 4'>        final CachedModuleScript cachedModule1 = getLoadedModule(moduleId);
</span><span class='bc' id='L68' title='0|3|3 - Total: 3'>        final Object validator1 = getValidator(cachedModule1);
</span><span class='bc' id='L69' title='0|2|2 - Total: 2'>        final ModuleSource moduleSource = (moduleUri == null)
</span><span class='bc' id='L70' title='0|7|7 - Total: 7'>                ? moduleSourceProvider.loadSource(moduleId, paths, validator1)
</span><span class='bc' id='L71' title='0|2|2 - Total: 2'>                : moduleSourceProvider.loadSource(moduleUri, baseUri, validator1);
</span><span class='bc' id='L72' title='0|2|2 - Total: 2'>        if(moduleSource == ModuleSourceProvider.NOT_MODIFIED) {
</span><span class='bc' id='L73' title='0|3|3 - Total: 3'>            return cachedModule1.getModule();
</span>        }
<span class='bc' id='L75' title='0|2|2 - Total: 2'>        if(moduleSource == null) {
</span><span class='bc' id='L76' title='0|2|2 - Total: 2'>            return null;
</span>        }
<span class='bc' id='L78' title='0|3|3 - Total: 3'>        final Reader reader = moduleSource.getReader();
</span>        try {
<span class='bc' id='L80' title='0|3|3 - Total: 3'>            final int idHash = moduleId.hashCode();
</span><span class='bc' id='L81' title='0|11|11 - Total: 11'>            synchronized(loadLocks[(idHash >>> loadLockShift) & loadLockMask]) {
</span><span class='bc' id='L82' title='0|4|4 - Total: 4'>                final CachedModuleScript cachedModule2 = getLoadedModule(moduleId);
</span><span class='bpc' id='L83' title='0|1|1 - Total: 2'>                if(cachedModule2 != null) {
</span><span class='nc' id='L84' title='0|0|0 - Total: 2'>                    if(!equal(validator1, getValidator(cachedModule2))) {
</span><span class='nc' id='L85' title='0|0|0 - Total: 7'>                        return cachedModule2.getModule();
</span>                    }
                }
<span class='bc' id='L88' title='0|3|3 - Total: 3'>                final URI sourceUri = moduleSource.getUri();
</span><span class='bc' id='L89' title='0|5|5 - Total: 5'>                final ModuleScript moduleScript = new ModuleScript(
</span><span class='bc' id='L90' title='0|6|6 - Total: 6'>                        cx.compileReader(reader, sourceUri.toString(), 1,
</span><span class='bc' id='L91' title='0|1|1 - Total: 1'>                                moduleSource.getSecurityDomain()),
</span><span class='bc' id='L92' title='0|3|3 - Total: 3'>                        sourceUri, moduleSource.getBase());
</span><span class='bc' id='L93' title='0|5|5 - Total: 5'>                putLoadedModule(moduleId, moduleScript,
</span><span class='bc' id='L94' title='0|1|1 - Total: 1'>                        moduleSource.getValidator());
</span><span class='bc' id='L95' title='0|6|6 - Total: 6'>                return moduleScript;
</span><span class='nc' id='L96' title='0|0|0 - Total: 5'>            }
</span>        }
        finally {
<span class='bpc' id='L99' title='0|2|2 - Total: 7'>            reader.close();
</span><span class='nc' id='L100' title='0|0|0 - Total: 2'>        }
</span>    }

    /**
     * Store a loaded module script for later retrieval using
     * {@link #getLoadedModule(String)}.
     * @param moduleId the ID of the module
     * @param moduleScript the module script
     * @param validator the validator for the module's source text entity
     */
    protected abstract void putLoadedModule(String moduleId,
            ModuleScript moduleScript, Object validator);

    /**
     * Retrieves an already loaded moduleScript stored using
     * {@link #putLoadedModule(String, ModuleScript, Object)}.
     * @param moduleId the ID of the module
     * @return a cached module script, or null if the module is not loaded.
     */
    protected abstract CachedModuleScript getLoadedModule(String moduleId);

    /**
     * Instances of this class represent a loaded and cached module script.
     * @author Attila Szegedi
     * @version $Id: CachingModuleScriptProviderBase.java,v 1.3 2011/04/07 20:26:12 hannes%helma.at Exp $
     */
    public static class CachedModuleScript {
        private final ModuleScript moduleScript;
        private final Object validator;

        /**
         * Creates a new cached module script.
         * @param moduleScript the module script itself
         * @param validator a validator for the moduleScript's source text
         * entity.
         */
        public CachedModuleScript(ModuleScript moduleScript, Object validator) {
            this.moduleScript = moduleScript;
            this.validator = validator;
        }

        /**
         * Returns the module script.
         * @return the module script.
         */
        ModuleScript getModule() {
            return moduleScript;
        }

        /**
         * Returns the validator for the module script's source text entity.
         * @return the validator for the module script's source text entity.
         */
        Object getValidator() {
            return validator;
        }
    }

    private static Object getValidator(CachedModuleScript cachedModule) {
<span class='bc' id='L159' title='0|2|2 - Total: 2'>        return cachedModule == null ? null : cachedModule.getValidator();
</span>    }

    private static boolean equal(Object o1, Object o2) {
<span class='nc' id='L163' title='0|0|0 - Total: 4'>        return o1 == null ? o2 == null : o1.equals(o2);
</span>    }

    /**
     * Returns the internal concurrency level utilized by caches in this JVM.
     * @return the internal concurrency level utilized by caches in this JVM.
     */
    protected static int getConcurrencyLevel() {
<span class='bc' id='L171' title='0|2|2 - Total: 2'>        return loadLockCount;
</span>    }
}
</pre></body></html><table class='legend'><tr><td class='nc'>Not Covered</td><td class='ac'>Covered by test suite 1</td><td class='bc'>Covered by test suite 2</td><td class='uc'>Covered by the union test suite</td><td class='apc'>Partially Covered by test suite 1</td><td class='bpc'>Partially Covered by test suite 2</td><td class='upc'>Partially Covered by the union test suite</td></tr></table>