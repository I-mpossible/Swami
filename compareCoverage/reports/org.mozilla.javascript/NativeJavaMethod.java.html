<?xml version='1.0' encoding='UTF-8'?><!DOCTYPE html PUBLIC '-//W3C//DTD XHTML 1.0 Strict//EN' 'http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd'><html xmlns='http://www.w3.org/1999/xhtml' lang='en'><head><meta http-equiv='Content-Type' content='text/html;charset=UTF-8'/><title>org.mozilla.javascript.NativeJavaMethod.java</title><link rel='stylesheet' href='../.resources/report.css' type='text/css'/><link rel='stylesheet' href='../.resources/prettify.css' type='text/css'/><link rel='stylesheet' href='../.resources/custom.css' type='text/css'/><script type='text/javascript' src='../.resources/prettify.js'></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><h1>org.mozilla.javascript.NativeJavaMethod.java</h1><table class='legend'><tr><td class='nc'>Not Covered</td><td class='ac'>Covered by test suite 1</td><td class='bc'>Covered by test suite 2</td><td class='uc'>Covered by the union test suite</td><td class='apc'>Partially Covered by test suite 1</td><td class='bpc'>Partially Covered by test suite 2</td><td class='upc'>Partially Covered by the union test suite</td></tr></table><pre class='source lang-java linenums'>/* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-
 *
 * This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at http://mozilla.org/MPL/2.0/. */

package org.mozilla.javascript;

import java.lang.reflect.*;
import java.util.Arrays;
import java.util.concurrent.CopyOnWriteArrayList;

/**
 * This class reflects Java methods into the JavaScript environment and
 * handles overloading of methods.
 *
 * @author Mike Shaver
 * @see NativeJavaArray
 * @see NativeJavaPackage
 * @see NativeJavaClass
 */

public class NativeJavaMethod extends BaseFunction
{
    static final long serialVersionUID = -3440381785576412928L;

    NativeJavaMethod(MemberBox[] methods)
<span class='uc' id='L28' title='2|2|2 - Total: 2'>    {
</span><span class='uc' id='L29' title='6|6|6 - Total: 6'>        this.functionName = methods[0].getName();
</span><span class='uc' id='L30' title='3|3|3 - Total: 3'>        this.methods = methods;
</span><span class='uc' id='L31' title='1|1|1 - Total: 1'>    }
</span>
    NativeJavaMethod(MemberBox[] methods, String name)
<span class='uc' id='L34' title='2|2|2 - Total: 2'>    {
</span><span class='uc' id='L35' title='3|3|3 - Total: 3'>        this.functionName = name;
</span><span class='uc' id='L36' title='3|3|3 - Total: 3'>        this.methods = methods;
</span><span class='uc' id='L37' title='1|1|1 - Total: 1'>    }
</span>
    NativeJavaMethod(MemberBox method, String name)
<span class='uc' id='L40' title='2|2|2 - Total: 2'>    {
</span><span class='uc' id='L41' title='3|3|3 - Total: 3'>        this.functionName = name;
</span><span class='uc' id='L42' title='8|8|8 - Total: 8'>        this.methods = new MemberBox[] { method };
</span><span class='uc' id='L43' title='1|1|1 - Total: 1'>    }
</span>
    public NativeJavaMethod(Method method, String name)
    {
<span class='nc' id='L47' title='0|0|0 - Total: 7'>        this(new MemberBox(method), name);
</span><span class='nc' id='L48' title='0|0|0 - Total: 1'>    }
</span>
    @Override
    public String getFunctionName()
    {
<span class='nc' id='L53' title='0|0|0 - Total: 3'>        return functionName;
</span>    }

    static String scriptSignature(Object[] values)
    {
<span class='uc' id='L58' title='4|4|4 - Total: 4'>        StringBuilder sig = new StringBuilder();
</span><span class='uc' id='L59' title='2|2|2 - Total: 2'>        for (int i = 0; i != values.length; ++i) {
</span><span class='uc' id='L60' title='4|4|4 - Total: 4'>            Object value = values[i];
</span>
            String s;
<span class='upc' id='L63' title='1|1|1 - Total: 2'>            if (value == null) {
</span><span class='nc' id='L64' title='0|0|0 - Total: 3'>                s = "null";
</span><span class='upc' id='L65' title='1|1|1 - Total: 2'>            } else if (value instanceof Boolean) {
</span><span class='nc' id='L66' title='0|0|0 - Total: 3'>                s = "boolean";
</span><span class='upc' id='L67' title='1|1|1 - Total: 2'>            } else if (value instanceof String) {
</span><span class='nc' id='L68' title='0|0|0 - Total: 3'>                s = "string";
</span><span class='upc' id='L69' title='1|1|1 - Total: 2'>            } else if (value instanceof Number) {
</span><span class='nc' id='L70' title='0|0|0 - Total: 3'>                s = "number";
</span><span class='upc' id='L71' title='1|1|1 - Total: 2'>            } else if (value instanceof Scriptable) {
</span><span class='upc' id='L72' title='1|1|1 - Total: 2'>                if (value instanceof Undefined) {
</span><span class='nc' id='L73' title='0|0|0 - Total: 3'>                    s = "undefined";
</span><span class='upc' id='L74' title='1|1|1 - Total: 2'>                } else if (value instanceof Wrapper) {
</span><span class='nc' id='L75' title='0|0|0 - Total: 4'>                    Object wrapped = ((Wrapper)value).unwrap();
</span><span class='nc' id='L76' title='0|0|0 - Total: 4'>                    s = wrapped.getClass().getName();
</span><span class='upc' id='L77' title='1|1|1 - Total: 2'>                } else if (value instanceof Function) {
</span><span class='uc' id='L78' title='3|3|3 - Total: 3'>                    s = "function";
</span>                } else {
<span class='nc' id='L80' title='0|0|0 - Total: 3'>                    s = "object";
</span>                }
            } else {
<span class='nc' id='L83' title='0|0|0 - Total: 4'>                s = JavaMembers.javaSignature(value.getClass());
</span>            }

<span class='upc' id='L86' title='1|1|1 - Total: 2'>            if (i != 0) {
</span><span class='nc' id='L87' title='0|0|0 - Total: 4'>                sig.append(',');
</span>            }
<span class='uc' id='L89' title='4|4|4 - Total: 4'>            sig.append(s);
</span>        }
<span class='uc' id='L91' title='3|3|3 - Total: 3'>        return sig.toString();
</span>    }

    @Override
    String decompile(int indent, int flags)
    {
<span class='nc' id='L97' title='0|0|0 - Total: 4'>        StringBuilder sb = new StringBuilder();
</span><span class='nc' id='L98' title='0|0|0 - Total: 2'>        boolean justbody = (0 != (flags & Decompiler.ONLY_BODY_FLAG));
</span><span class='nc' id='L99' title='0|0|0 - Total: 2'>        if (!justbody) {
</span><span class='nc' id='L100' title='0|0|0 - Total: 4'>            sb.append("function ");
</span><span class='nc' id='L101' title='0|0|0 - Total: 5'>            sb.append(getFunctionName());
</span><span class='nc' id='L102' title='0|0|0 - Total: 4'>            sb.append("() {");
</span>        }
<span class='nc' id='L104' title='0|0|0 - Total: 4'>        sb.append("/*\n");
</span><span class='nc' id='L105' title='0|0|0 - Total: 5'>        sb.append(toString());
</span><span class='nc' id='L106' title='0|0|0 - Total: 2'>        sb.append(justbody ? "*/\n" : "*/}\n");
</span><span class='nc' id='L107' title='0|0|0 - Total: 3'>        return sb.toString();
</span>    }

    @Override
    public String toString()
    {
<span class='nc' id='L113' title='0|0|0 - Total: 4'>        StringBuilder sb = new StringBuilder();
</span><span class='nc' id='L114' title='0|0|0 - Total: 2'>        for (int i = 0, N = methods.length; i != N; ++i) {
</span>            // Check member type, we also use this for overloaded constructors
<span class='nc' id='L116' title='0|0|0 - Total: 2'>            if (methods[i].isMethod()) {
</span><span class='nc' id='L117' title='0|0|0 - Total: 6'>                Method method = methods[i].method();
</span><span class='nc' id='L118' title='0|0|0 - Total: 6'>                sb.append(JavaMembers.javaSignature(method.getReturnType()));
</span><span class='nc' id='L119' title='0|0|0 - Total: 4'>                sb.append(' ');
</span><span class='nc' id='L120' title='0|0|0 - Total: 5'>                sb.append(method.getName());
</span><span class='nc' id='L121' title='0|0|0 - Total: 1'>            } else {
</span><span class='nc' id='L122' title='0|0|0 - Total: 8'>                sb.append(methods[i].getName());
</span>            }
<span class='nc' id='L124' title='0|0|0 - Total: 9'>            sb.append(JavaMembers.liveConnectSignature(methods[i].argTypes));
</span><span class='nc' id='L125' title='0|0|0 - Total: 4'>            sb.append('\n');
</span>        }
<span class='nc' id='L127' title='0|0|0 - Total: 3'>        return sb.toString();
</span>    }

    @Override
    public Object call(Context cx, Scriptable scope, Scriptable thisObj,
                       Object[] args)
    {
        // Find a method that matches the types given.
<span class='upc' id='L135' title='1|1|1 - Total: 2'>        if (methods.length == 0) {
</span><span class='nc' id='L136' title='0|0|0 - Total: 5'>            throw new RuntimeException("No methods defined for call");
</span>        }

<span class='uc' id='L139' title='5|5|5 - Total: 5'>        int index = findCachedFunction(cx, args);
</span><span class='upc' id='L140' title='1|1|1 - Total: 2'>        if (index < 0) {
</span><span class='nc' id='L141' title='0|0|0 - Total: 7'>            Class<?> c = methods[0].method().getDeclaringClass();
</span><span class='nc' id='L142' title='0|0|0 - Total: 14'>            String sig = c.getName() + '.' + getFunctionName() + '(' +
</span><span class='nc' id='L143' title='0|0|0 - Total: 6'>                         scriptSignature(args) + ')';
</span><span class='nc' id='L144' title='0|0|0 - Total: 4'>            throw Context.reportRuntimeError1("msg.java.no_such_method", sig);
</span>        }

<span class='uc' id='L147' title='5|5|5 - Total: 5'>        MemberBox meth = methods[index];
</span><span class='uc' id='L148' title='3|3|3 - Total: 3'>        Class<?>[] argTypes = meth.argTypes;
</span>
<span class='uc' id='L150' title='2|2|2 - Total: 2'>        if (meth.vararg) {
</span>            // marshall the explicit parameters
<span class='uc' id='L152' title='4|4|4 - Total: 4'>            Object[] newArgs = new Object[argTypes.length];
</span><span class='uc' id='L153' title='2|2|2 - Total: 2'>            for (int i = 0; i < argTypes.length-1; i++) {
</span><span class='uc' id='L154' title='10|10|10 - Total: 10'>                newArgs[i] = Context.jsToJava(args[i], argTypes[i]);
</span>            }

            Object varArgs;

            // Handle special situation where a single variable parameter
            // is given and it is a Java or ECMA array or is null.
<span class='upc' id='L161' title='5|5|5 - Total: 8'>            if (args.length == argTypes.length &&
</span>                (args[args.length-1] == null ||
                 args[args.length-1] instanceof NativeArray ||
                 args[args.length-1] instanceof NativeJavaArray))
            {
                // convert the ECMA array into a native array
<span class='uc' id='L167' title='15|15|15 - Total: 15'>                varArgs = Context.jsToJava(args[args.length-1],
</span>                                           argTypes[argTypes.length - 1]);
            } else {
                // marshall the variable parameters
<span class='uc' id='L171' title='6|6|6 - Total: 6'>                Class<?> componentType = argTypes[argTypes.length - 1].
</span><span class='uc' id='L172' title='2|2|2 - Total: 2'>                                         getComponentType();
</span><span class='uc' id='L173' title='10|10|10 - Total: 10'>                varArgs = Array.newInstance(componentType,
</span>                                            args.length - argTypes.length + 1);
<span class='uc' id='L175' title='2|2|2 - Total: 2'>                for (int i = 0; i < Array.getLength(varArgs); i++) {
</span><span class='uc' id='L176' title='11|11|11 - Total: 11'>                    Object value = Context.jsToJava(args[argTypes.length-1 + i],
</span>                                                    componentType);
<span class='uc' id='L178' title='4|4|4 - Total: 4'>                    Array.set(varArgs, i, value);
</span>                }
            }

            // add varargs
<span class='uc' id='L183' title='7|7|7 - Total: 7'>            newArgs[argTypes.length-1] = varArgs;
</span>            // replace the original args with the new one
<span class='uc' id='L185' title='2|2|2 - Total: 2'>            args = newArgs;
</span><span class='uc' id='L186' title='1|1|1 - Total: 1'>        } else {
</span>            // First, we marshall the args.
<span class='uc' id='L188' title='2|2|2 - Total: 2'>            Object[] origArgs = args;
</span><span class='uc' id='L189' title='2|2|2 - Total: 2'>            for (int i = 0; i < args.length; i++) {
</span><span class='uc' id='L190' title='4|4|4 - Total: 4'>                Object arg = args[i];
</span><span class='uc' id='L191' title='6|6|6 - Total: 6'>                Object coerced = Context.jsToJava(arg, argTypes[i]);
</span><span class='uc' id='L192' title='2|2|2 - Total: 2'>                if (coerced != arg) {
</span><span class='uc' id='L193' title='2|2|2 - Total: 2'>                    if (origArgs == args) {
</span><span class='uc' id='L194' title='4|4|4 - Total: 4'>                        args = args.clone();
</span>                    }
<span class='uc' id='L196' title='4|4|4 - Total: 4'>                    args[i] = coerced;
</span>                }
            }
        }
        Object javaObject;
<span class='uc' id='L201' title='2|2|2 - Total: 2'>        if (meth.isStatic()) {
</span><span class='uc' id='L202' title='3|3|3 - Total: 3'>            javaObject = null;  // don't need an object
</span>        } else {
<span class='uc' id='L204' title='2|2|2 - Total: 2'>            Scriptable o = thisObj;
</span><span class='uc' id='L205' title='3|3|3 - Total: 3'>            Class<?> c = meth.getDeclaringClass();
</span>            for (;;) {
<span class='upc' id='L207' title='1|1|1 - Total: 2'>                if (o == null) {
</span><span class='nc' id='L208' title='0|0|0 - Total: 4'>                    throw Context.reportRuntimeError3(
</span><span class='nc' id='L209' title='0|0|0 - Total: 2'>                        "msg.nonjava.method", getFunctionName(),
</span><span class='nc' id='L210' title='0|0|0 - Total: 3'>                        ScriptRuntime.toString(thisObj), c.getName());
</span>                }
<span class='upc' id='L212' title='1|1|1 - Total: 2'>                if (o instanceof Wrapper) {
</span><span class='uc' id='L213' title='4|4|4 - Total: 4'>                    javaObject = ((Wrapper)o).unwrap();
</span><span class='upc' id='L214' title='1|1|1 - Total: 2'>                    if (c.isInstance(javaObject)) {
</span><span class='uc' id='L215' title='1|1|1 - Total: 1'>                        break;
</span>                    }
                }
<span class='nc' id='L218' title='0|0|0 - Total: 4'>                o = o.getPrototype();
</span>            }
        }
        if (debug) {
            printDebug("Calling ", meth, args);
        }

<span class='uc' id='L225' title='5|5|5 - Total: 5'>        Object retval = meth.invoke(javaObject, args);
</span><span class='uc' id='L226' title='4|4|4 - Total: 4'>        Class<?> staticType = meth.method().getReturnType();
</span>
        if (debug) {
            Class<?> actualType = (retval == null) ? null
                                                : retval.getClass();
            System.err.println(" ----- Returned " + retval +
                               " actual = " + actualType +
                               " expect = " + staticType);
        }

<span class='uc' id='L236' title='8|8|8 - Total: 8'>        Object wrapped = cx.getWrapFactory().wrap(cx, scope,
</span>                                                  retval, staticType);
        if (debug) {
            Class<?> actualType = (wrapped == null) ? null
                                                 : wrapped.getClass();
            System.err.println(" ----- Wrapped as " + wrapped +
                               " class = " + actualType);
        }

<span class='uc' id='L245' title='4|4|4 - Total: 4'>        if (wrapped == null && staticType == Void.TYPE) {
</span><span class='uc' id='L246' title='2|2|2 - Total: 2'>            wrapped = Undefined.instance;
</span>        }
<span class='uc' id='L248' title='2|2|2 - Total: 2'>        return wrapped;
</span>    }

    int findCachedFunction(Context cx, Object[] args) {
<span class='uc' id='L252' title='2|2|2 - Total: 2'>        if (methods.length > 1) {
</span><span class='uc' id='L253' title='2|2|2 - Total: 2'>            if (overloadCache != null) {
</span><span class='uc' id='L254' title='2|2|2 - Total: 2'>                for (ResolvedOverload ovl : overloadCache) {
</span><span class='uc' id='L255' title='2|2|2 - Total: 2'>                    if (ovl.matches(args)) {
</span><span class='uc' id='L256' title='3|3|3 - Total: 3'>                        return ovl.index;
</span>                    }
<span class='uc' id='L258' title='2|2|2 - Total: 2'>                }
</span>            } else {
<span class='uc' id='L260' title='5|5|5 - Total: 5'>                overloadCache = new CopyOnWriteArrayList<ResolvedOverload>();
</span>            }
<span class='uc' id='L262' title='6|6|6 - Total: 6'>            int index = findFunction(cx, methods, args);
</span>            // As a sanity measure, don't let the lookup cache grow longer
            // than twice the number of overloaded methods
<span class='upc' id='L265' title='1|1|1 - Total: 2'>            if (overloadCache.size() < methods.length * 2) {
</span><span class='uc' id='L266' title='5|5|5 - Total: 5'>                synchronized (overloadCache) {
</span><span class='uc' id='L267' title='6|6|6 - Total: 6'>                    ResolvedOverload ovl = new ResolvedOverload(args, index);
</span><span class='upc' id='L268' title='1|1|1 - Total: 2'>                    if (!overloadCache.contains(ovl)) {
</span><span class='uc' id='L269' title='5|5|5 - Total: 5'>                        overloadCache.add(0, ovl);
</span>                    }
<span class='upc' id='L271' title='3|3|3 - Total: 8'>                }
</span>            }
<span class='uc' id='L273' title='2|2|2 - Total: 2'>            return index;
</span>        }
<span class='uc' id='L275' title='6|6|6 - Total: 6'>        return findFunction(cx, methods, args);
</span>    }

    /**
     * Find the index of the correct function to call given the set of methods
     * or constructors and the arguments.
     * If no function can be found to call, return -1.
     */
    static int findFunction(Context cx,
                            MemberBox[] methodsOrCtors, Object[] args)
    {
<span class='upc' id='L286' title='1|1|1 - Total: 2'>        if (methodsOrCtors.length == 0) {
</span><span class='nc' id='L287' title='0|0|0 - Total: 2'>            return -1;
</span><span class='uc' id='L288' title='2|2|2 - Total: 2'>        } else if (methodsOrCtors.length == 1) {
</span><span class='uc' id='L289' title='4|4|4 - Total: 4'>            MemberBox member = methodsOrCtors[0];
</span><span class='uc' id='L290' title='3|3|3 - Total: 3'>            Class<?>[] argTypes = member.argTypes;
</span><span class='uc' id='L291' title='3|3|3 - Total: 3'>            int alength = argTypes.length;
</span>
<span class='uc' id='L293' title='2|2|2 - Total: 2'>            if (member.vararg) {
</span><span class='uc' id='L294' title='1|1|1 - Total: 1'>                alength--;
</span><span class='upc' id='L295' title='1|1|1 - Total: 2'>                if ( alength > args.length) {
</span><span class='nc' id='L296' title='0|0|0 - Total: 2'>                    return -1;
</span>                }
            } else {
<span class='upc' id='L299' title='1|1|1 - Total: 2'>                if (alength != args.length) {
</span><span class='nc' id='L300' title='0|0|0 - Total: 2'>                    return -1;
</span>                }
            }
<span class='uc' id='L303' title='2|2|2 - Total: 2'>            for (int j = 0; j != alength; ++j) {
</span><span class='upc' id='L304' title='1|1|1 - Total: 2'>                if (!NativeJavaObject.canConvert(args[j], argTypes[j])) {
</span>                    if (debug) printDebug("Rejecting (args can't convert) ",
                                          member, args);
<span class='nc' id='L307' title='0|0|0 - Total: 2'>                    return -1;
</span>                }
            }
            if (debug) printDebug("Found ", member, args);
<span class='uc' id='L311' title='2|2|2 - Total: 2'>            return 0;
</span>        }

<span class='uc' id='L314' title='2|2|2 - Total: 2'>        int firstBestFit = -1;
</span><span class='uc' id='L315' title='2|2|2 - Total: 2'>        int[] extraBestFits = null;
</span><span class='uc' id='L316' title='2|2|2 - Total: 2'>        int extraBestFitsCount = 0;
</span>
      search:
<span class='uc' id='L319' title='2|2|2 - Total: 2'>        for (int i = 0; i < methodsOrCtors.length; i++) {
</span><span class='uc' id='L320' title='4|4|4 - Total: 4'>            MemberBox member = methodsOrCtors[i];
</span><span class='uc' id='L321' title='3|3|3 - Total: 3'>            Class<?>[] argTypes = member.argTypes;
</span><span class='uc' id='L322' title='3|3|3 - Total: 3'>            int alength = argTypes.length;
</span><span class='uc' id='L323' title='2|2|2 - Total: 2'>            if (member.vararg) {
</span><span class='uc' id='L324' title='1|1|1 - Total: 1'>                alength--;
</span><span class='upc' id='L325' title='1|1|1 - Total: 2'>                if ( alength > args.length) {
</span><span class='nc' id='L326' title='0|0|0 - Total: 1'>                    continue search;
</span>                }
            } else {
<span class='uc' id='L329' title='2|2|2 - Total: 2'>                if (alength != args.length) {
</span><span class='uc' id='L330' title='1|1|1 - Total: 1'>                    continue search;
</span>                }
            }
<span class='uc' id='L333' title='2|2|2 - Total: 2'>            for (int j = 0; j < alength; j++) {
</span><span class='uc' id='L334' title='2|2|2 - Total: 2'>                if (!NativeJavaObject.canConvert(args[j], argTypes[j])) {
</span>                    if (debug) printDebug("Rejecting (args can't convert) ",
                                          member, args);
<span class='uc' id='L337' title='1|1|1 - Total: 1'>                    continue search;
</span>                }
            }
<span class='uc' id='L340' title='2|2|2 - Total: 2'>            if (firstBestFit < 0) {
</span>                if (debug) printDebug("Found first applicable ", member, args);
<span class='uc' id='L342' title='3|3|3 - Total: 3'>                firstBestFit = i;
</span>            } else {
                // Compare with all currently fit methods.
                // The loop starts from -1 denoting firstBestFit and proceed
                // until extraBestFitsCount to avoid extraBestFits allocation
                // in the most common case of no ambiguity
<span class='uc' id='L348' title='2|2|2 - Total: 2'>                int betterCount = 0; // number of times member was prefered over
</span>                                     // best fits
<span class='uc' id='L350' title='2|2|2 - Total: 2'>                int worseCount = 0;  // number of times best fits were prefered
</span>                                     // over member
<span class='uc' id='L352' title='2|2|2 - Total: 2'>                for (int j = -1; j != extraBestFitsCount; ++j) {
</span>                    int bestFitIndex;
<span class='uc' id='L354' title='2|2|2 - Total: 2'>                    if (j == -1) {
</span><span class='uc' id='L355' title='3|3|3 - Total: 3'>                        bestFitIndex = firstBestFit;
</span>                    } else {
<span class='uc' id='L357' title='4|4|4 - Total: 4'>                        bestFitIndex = extraBestFits[j];
</span>                    }
<span class='uc' id='L359' title='4|4|4 - Total: 4'>                    MemberBox bestFit = methodsOrCtors[bestFitIndex];
</span><span class='uc' id='L360' title='2|2|2 - Total: 2'>                    if (cx.hasFeature(Context.FEATURE_ENHANCED_JAVA_ACCESS) &&
</span><span class='uc' id='L361' title='5|5|5 - Total: 5'>                        (bestFit.member().getModifiers() & Modifier.PUBLIC) !=
</span><span class='upc' id='L362' title='1|1|1 - Total: 2'>                            (member.member().getModifiers() & Modifier.PUBLIC))
</span>                    {
                        // When FEATURE_ENHANCED_JAVA_ACCESS gives us access
                        // to non-public members, continue to prefer public
                        // methods in overloading
<span class='nc' id='L367' title='0|0|0 - Total: 2'>                        if ((bestFit.member().getModifiers() & Modifier.PUBLIC) == 0)
</span><span class='nc' id='L368' title='0|0|0 - Total: 2'>                            ++betterCount;
</span>                        else
<span class='nc' id='L370' title='0|0|0 - Total: 2'>                            ++worseCount;
</span>                    } else {
<span class='uc' id='L372' title='10|10|10 - Total: 10'>                        int preference = preferSignature(args, argTypes,
</span>                                                         member.vararg,
                                                         bestFit.argTypes,
                                                         bestFit.vararg );
<span class='uc' id='L376' title='2|2|2 - Total: 2'>                        if (preference == PREFERENCE_AMBIGUOUS) {
</span><span class='uc' id='L377' title='1|1|1 - Total: 1'>                            break;
</span><span class='uc' id='L378' title='2|2|2 - Total: 2'>                        } else if (preference == PREFERENCE_FIRST_ARG) {
</span><span class='uc' id='L379' title='2|2|2 - Total: 2'>                            ++betterCount;
</span><span class='upc' id='L380' title='1|1|1 - Total: 2'>                        } else if (preference == PREFERENCE_SECOND_ARG) {
</span><span class='uc' id='L381' title='2|2|2 - Total: 2'>                            ++worseCount;
</span>                        } else {
<span class='nc' id='L383' title='0|0|0 - Total: 2'>                            if (preference != PREFERENCE_EQUAL) Kit.codeBug();
</span>                            // This should not happen in theory
                            // but on some JVMs, Class.getMethods will return all
                            // static methods of the class hierarchy, even if
                            // a derived class's parameters match exactly.
                            // We want to call the derived class's method.
<span class='nc' id='L389' title='0|0|0 - Total: 2'>                            if (bestFit.isStatic() &&
</span><span class='nc' id='L390' title='0|0|0 - Total: 2'>                                bestFit.getDeclaringClass().isAssignableFrom(
</span><span class='nc' id='L391' title='0|0|0 - Total: 1'>                                       member.getDeclaringClass()))
</span>                            {
                                // On some JVMs, Class.getMethods will return all
                                // static methods of the class hierarchy, even if
                                // a derived class's parameters match exactly.
                                // We want to call the derived class's method.
                                if (debug) printDebug(
                                    "Substituting (overridden static)",
                                    member, args);
<span class='nc' id='L400' title='0|0|0 - Total: 2'>                                if (j == -1) {
</span><span class='nc' id='L401' title='0|0|0 - Total: 3'>                                    firstBestFit = i;
</span>                                } else {
<span class='nc' id='L403' title='0|0|0 - Total: 5'>                                    extraBestFits[j] = i;
</span>                                }
                            } else {
                                if (debug) printDebug(
                                    "Ignoring same signature member ",
                                    member, args);
                            }
                            continue search;
                        }
                    }
                }
<span class='uc' id='L414' title='2|2|2 - Total: 2'>                if (betterCount == 1 + extraBestFitsCount) {
</span>                    // member was prefered over all best fits
                    if (debug) printDebug(
                        "New first applicable ", member, args);
<span class='uc' id='L418' title='2|2|2 - Total: 2'>                    firstBestFit = i;
</span><span class='uc' id='L419' title='3|3|3 - Total: 3'>                    extraBestFitsCount = 0;
</span><span class='uc' id='L420' title='2|2|2 - Total: 2'>                } else if (worseCount == 1 + extraBestFitsCount) {
</span>                    // all best fits were prefered over member, ignore it
                    if (debug) printDebug(
                        "Rejecting (all current bests better) ", member, args);
                } else {
                    // some ambiguity was present, add member to best fit set
                    if (debug) printDebug(
                        "Added to best fit set ", member, args);
<span class='uc' id='L428' title='2|2|2 - Total: 2'>                    if (extraBestFits == null) {
</span>                        // Allocate maximum possible array
<span class='uc' id='L430' title='6|6|6 - Total: 6'>                        extraBestFits = new int[methodsOrCtors.length - 1];
</span>                    }
<span class='uc' id='L432' title='4|4|4 - Total: 4'>                    extraBestFits[extraBestFitsCount] = i;
</span><span class='uc' id='L433' title='1|1|1 - Total: 1'>                    ++extraBestFitsCount;
</span>                }
            }
        }

<span class='upc' id='L438' title='1|1|1 - Total: 2'>        if (firstBestFit < 0) {
</span>            // Nothing was found
<span class='nc' id='L440' title='0|0|0 - Total: 2'>            return -1;
</span><span class='uc' id='L441' title='2|2|2 - Total: 2'>        } else if (extraBestFitsCount == 0) {
</span>            // single best fit
<span class='uc' id='L443' title='2|2|2 - Total: 2'>            return firstBestFit;
</span>        }

        // report remaining ambiguity
<span class='uc' id='L447' title='4|4|4 - Total: 4'>        StringBuilder buf = new StringBuilder();
</span><span class='uc' id='L448' title='2|2|2 - Total: 2'>        for (int j = -1; j != extraBestFitsCount; ++j) {
</span>            int bestFitIndex;
<span class='uc' id='L450' title='2|2|2 - Total: 2'>            if (j == -1) {
</span><span class='uc' id='L451' title='3|3|3 - Total: 3'>                bestFitIndex = firstBestFit;
</span>            } else {
<span class='uc' id='L453' title='4|4|4 - Total: 4'>                bestFitIndex = extraBestFits[j];
</span>            }
<span class='uc' id='L455' title='4|4|4 - Total: 4'>            buf.append("\n    ");
</span><span class='uc' id='L456' title='7|7|7 - Total: 7'>            buf.append(methodsOrCtors[bestFitIndex].toJavaDeclaration());
</span>        }

<span class='uc' id='L459' title='4|4|4 - Total: 4'>        MemberBox firstFitMember = methodsOrCtors[firstBestFit];
</span><span class='uc' id='L460' title='3|3|3 - Total: 3'>        String memberName = firstFitMember.getName();
</span><span class='uc' id='L461' title='4|4|4 - Total: 4'>        String memberClass = firstFitMember.getDeclaringClass().getName();
</span>
<span class='upc' id='L463' title='1|1|1 - Total: 2'>        if (methodsOrCtors[0].isCtor()) {
</span><span class='nc' id='L464' title='0|0|0 - Total: 5'>            throw Context.reportRuntimeError3(
</span>                "msg.constructor.ambiguous",
<span class='nc' id='L466' title='0|0|0 - Total: 3'>                memberName, scriptSignature(args), buf.toString());
</span>        } else {
<span class='uc' id='L468' title='6|6|6 - Total: 6'>            throw Context.reportRuntimeError4(
</span>                "msg.method.ambiguous", memberClass,
<span class='uc' id='L470' title='3|3|3 - Total: 3'>                memberName, scriptSignature(args), buf.toString());
</span>        }
    }

    /** Types are equal */
    private static final int PREFERENCE_EQUAL      = 0;
    private static final int PREFERENCE_FIRST_ARG  = 1;
    private static final int PREFERENCE_SECOND_ARG = 2;
    /** No clear "easy" conversion */
    private static final int PREFERENCE_AMBIGUOUS  = 3;

    /**
     * Determine which of two signatures is the closer fit.
     * Returns one of PREFERENCE_EQUAL, PREFERENCE_FIRST_ARG,
     * PREFERENCE_SECOND_ARG, or PREFERENCE_AMBIGUOUS.
     */
    private static int preferSignature(Object[] args,
                                       Class<?>[] sig1,
                                       boolean vararg1,
                                       Class<?>[] sig2,
                                       boolean vararg2 )
    {
<span class='uc' id='L492' title='2|2|2 - Total: 2'>        int totalPreference = 0;
</span><span class='uc' id='L493' title='2|2|2 - Total: 2'>        for (int j = 0; j < args.length; j++) {
</span><span class='upc' id='L494' title='1|1|1 - Total: 4'>            Class<?> type1 = vararg1 && j >= sig1.length ? sig1[sig1.length-1] : sig1[j];
</span><span class='uc' id='L495' title='4|4|4 - Total: 4'>            Class<?> type2 = vararg2 && j >= sig2.length ? sig2[sig2.length-1] : sig2[j];
</span><span class='uc' id='L496' title='2|2|2 - Total: 2'>            if (type1 == type2) {
</span><span class='uc' id='L497' title='1|1|1 - Total: 1'>                continue;
</span>            }
<span class='uc' id='L499' title='4|4|4 - Total: 4'>            Object arg = args[j];
</span>
            // Determine which of type1, type2 is easier to convert from arg.

<span class='uc' id='L503' title='4|4|4 - Total: 4'>            int rank1 = NativeJavaObject.getConversionWeight(arg, type1);
</span><span class='uc' id='L504' title='4|4|4 - Total: 4'>            int rank2 = NativeJavaObject.getConversionWeight(arg, type2);
</span>
            int preference;
<span class='uc' id='L507' title='2|2|2 - Total: 2'>            if (rank1 < rank2) {
</span><span class='uc' id='L508' title='3|3|3 - Total: 3'>                preference = PREFERENCE_FIRST_ARG;
</span><span class='uc' id='L509' title='2|2|2 - Total: 2'>            } else if (rank1 > rank2) {
</span><span class='uc' id='L510' title='3|3|3 - Total: 3'>                preference = PREFERENCE_SECOND_ARG;
</span>            } else {
                // Equal ranks
<span class='upc' id='L513' title='1|1|1 - Total: 2'>                if (rank1 == NativeJavaObject.CONVERSION_NONTRIVIAL) {
</span><span class='nc' id='L514' title='0|0|0 - Total: 2'>                    if (type1.isAssignableFrom(type2)) {
</span><span class='nc' id='L515' title='0|0|0 - Total: 3'>                        preference = PREFERENCE_SECOND_ARG;
</span><span class='nc' id='L516' title='0|0|0 - Total: 2'>                    } else if (type2.isAssignableFrom(type1)) {
</span><span class='nc' id='L517' title='0|0|0 - Total: 3'>                        preference = PREFERENCE_FIRST_ARG;
</span>                    } else {
<span class='nc' id='L519' title='0|0|0 - Total: 3'>                        preference = PREFERENCE_AMBIGUOUS;
</span>                    }
                } else {
<span class='uc' id='L522' title='2|2|2 - Total: 2'>                    preference = PREFERENCE_AMBIGUOUS;
</span>                }
            }

<span class='uc' id='L526' title='4|4|4 - Total: 4'>            totalPreference |= preference;
</span>
<span class='uc' id='L528' title='2|2|2 - Total: 2'>            if (totalPreference == PREFERENCE_AMBIGUOUS) {
</span><span class='uc' id='L529' title='1|1|1 - Total: 1'>                break;
</span>            }
        }
<span class='uc' id='L532' title='2|2|2 - Total: 2'>        return totalPreference;
</span>    }


    private static final boolean debug = false;

    private static void printDebug(String msg, MemberBox member,
                                   Object[] args)
    {
        if (debug) {
            StringBuilder sb = new StringBuilder();
            sb.append(" ----- ");
            sb.append(msg);
            sb.append(member.getDeclaringClass().getName());
            sb.append('.');
            if (member.isMethod()) {
                sb.append(member.getName());
            }
            sb.append(JavaMembers.liveConnectSignature(member.argTypes));
            sb.append(" for arguments (");
            sb.append(scriptSignature(args));
            sb.append(')');
            System.out.println(sb);
        }
<span class='nc' id='L556' title='0|0|0 - Total: 1'>    }
</span>
    MemberBox[] methods;
    private String functionName;
    private transient CopyOnWriteArrayList<ResolvedOverload> overloadCache;
}

class ResolvedOverload {
    final Class<?>[] types;
    final int index;

    ResolvedOverload(Object[] args, int index) {
        this.index = index;
        types = new Class<?>[args.length];
        for (int i = 0, l = args.length; i < l; i++) {
            Object arg = args[i];
            if (arg instanceof Wrapper)
                arg = ((Wrapper)arg).unwrap();
            types[i] = arg == null ? null : arg.getClass();
        }
    }

    boolean matches(Object[] args) {
        if (args.length != types.length) {
            return false;
        }
        for (int i = 0, l = args.length; i < l; i++) {
            Object arg = args[i];
            if (arg instanceof Wrapper)
                arg = ((Wrapper)arg).unwrap();
            if (arg == null) {
                if (types[i] != null) return false;
            } else if (arg.getClass() != types[i]) {
                return false;
            }
        }
        return true;
    }

    @Override
    public boolean equals(Object other) {
        if (!(other instanceof ResolvedOverload)) {
            return false;
        }
        ResolvedOverload ovl = (ResolvedOverload) other;
        return Arrays.equals(types, ovl.types) && index == ovl.index;
    }

    @Override
    public int hashCode() {
        return Arrays.hashCode(types);
    }
}
</pre></body></html><table class='legend'><tr><td class='nc'>Not Covered</td><td class='ac'>Covered by test suite 1</td><td class='bc'>Covered by test suite 2</td><td class='uc'>Covered by the union test suite</td><td class='apc'>Partially Covered by test suite 1</td><td class='bpc'>Partially Covered by test suite 2</td><td class='upc'>Partially Covered by the union test suite</td></tr></table>