<?xml version='1.0' encoding='UTF-8'?><!DOCTYPE html PUBLIC '-//W3C//DTD XHTML 1.0 Strict//EN' 'http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd'><html xmlns='http://www.w3.org/1999/xhtml' lang='en'><head><meta http-equiv='Content-Type' content='text/html;charset=UTF-8'/><title>org.mozilla.javascript.NativeArray.java</title><link rel='stylesheet' href='../.resources/report.css' type='text/css'/><link rel='stylesheet' href='../.resources/prettify.css' type='text/css'/><link rel='stylesheet' href='../.resources/custom.css' type='text/css'/><script type='text/javascript' src='../.resources/prettify.js'></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><h1>org.mozilla.javascript.NativeArray.java</h1><table class='legend'><tr><td class='nc'>Not Covered</td><td class='ac'>Covered by test suite 1</td><td class='bc'>Covered by test suite 2</td><td class='uc'>Covered by the union test suite</td><td class='apc'>Partially Covered by test suite 1</td><td class='bpc'>Partially Covered by test suite 2</td><td class='upc'>Partially Covered by the union test suite</td></tr></table><pre class='source lang-java linenums'>/* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-
 *
 * This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at http://mozilla.org/MPL/2.0/. */

package org.mozilla.javascript;

import org.mozilla.javascript.regexp.NativeRegExp;

import java.util.Arrays;
import java.util.Collection;
import java.util.Comparator;
import java.util.Iterator;
import java.util.List;
import java.util.ListIterator;
import java.util.NoSuchElementException;

import static org.mozilla.javascript.ScriptRuntimeES6.requireObjectCoercible;

/**
 * This class implements the Array native object.
 * @author Norris Boyd
 * @author Mike McCabe
 */
public class NativeArray extends IdScriptableObject implements List
{
    static final long serialVersionUID = 7331366857676127338L;

    /*
     * Optimization possibilities and open issues:
     * - Long vs. double schizophrenia.  I suspect it might be better
     * to use double throughout.
     *
     * - Functions that need a new Array call "new Array" in the
     * current scope rather than using a hardwired constructor;
     * "Array" could be redefined.  It turns out that js calls the
     * equivalent of "new Array" in the current scope, except that it
     * always gets at least an object back, even when Array == null.
     */

<span class='bc' id='L42' title='0|2|2 - Total: 2'>    private static final Object ARRAY_TAG = "Array";
</span><span class='bc' id='L43' title='0|3|3 - Total: 3'>    private static final Integer NEGATIVE_ONE = Integer.valueOf(-1);
</span>
    static void init(Scriptable scope, boolean sealed)
    {
<span class='bc' id='L47' title='0|5|5 - Total: 5'>        NativeArray obj = new NativeArray(0);
</span><span class='bc' id='L48' title='0|6|6 - Total: 6'>        obj.exportAsJSClass(MAX_PROTOTYPE_ID, scope, sealed);
</span><span class='bc' id='L49' title='0|1|1 - Total: 1'>    }
</span>
    static int getMaximumInitialCapacity() {
<span class='nc' id='L52' title='0|0|0 - Total: 2'>        return maximumInitialCapacity;
</span>    }

    static void setMaximumInitialCapacity(int maximumInitialCapacity) {
<span class='bc' id='L56' title='0|2|2 - Total: 2'>        NativeArray.maximumInitialCapacity = maximumInitialCapacity;
</span><span class='bc' id='L57' title='0|1|1 - Total: 1'>    }
</span>
    public NativeArray(long lengthArg)
<span class='bc' id='L60' title='0|2|2 - Total: 2'>    {
</span><span class='bc' id='L61' title='0|2|2 - Total: 2'>        denseOnly = lengthArg <= maximumInitialCapacity;
</span><span class='bc' id='L62' title='0|2|2 - Total: 2'>        if (denseOnly) {
</span><span class='bc' id='L63' title='0|3|3 - Total: 3'>            int intLength = (int) lengthArg;
</span><span class='bc' id='L64' title='0|2|2 - Total: 2'>            if (intLength < DEFAULT_INITIAL_CAPACITY)
</span><span class='bc' id='L65' title='0|2|2 - Total: 2'>                intLength = DEFAULT_INITIAL_CAPACITY;
</span><span class='bc' id='L66' title='0|4|4 - Total: 4'>            dense = new Object[intLength];
</span><span class='bc' id='L67' title='0|4|4 - Total: 4'>            Arrays.fill(dense, Scriptable.NOT_FOUND);
</span>        }
<span class='bc' id='L69' title='0|3|3 - Total: 3'>        length = lengthArg;
</span><span class='bc' id='L70' title='0|1|1 - Total: 1'>    }
</span>
    public NativeArray(Object[] array)
<span class='bc' id='L73' title='0|2|2 - Total: 2'>    {
</span><span class='bc' id='L74' title='0|3|3 - Total: 3'>        denseOnly = true;
</span><span class='bc' id='L75' title='0|3|3 - Total: 3'>        dense = array;
</span><span class='bc' id='L76' title='0|5|5 - Total: 5'>        length = array.length;
</span><span class='bc' id='L77' title='0|1|1 - Total: 1'>    }
</span>
    @Override
    public String getClassName()
    {
<span class='bc' id='L82' title='0|2|2 - Total: 2'>        return "Array";
</span>    }

    private static final int
        Id_length        =  1,
        MAX_INSTANCE_ID  =  1;

    @Override
    protected int getMaxInstanceId()
    {
<span class='bc' id='L92' title='0|2|2 - Total: 2'>        return MAX_INSTANCE_ID;
</span>    }

    @Override
    protected void setInstanceIdAttributes(int id, int attr) {
<span class='nc' id='L97' title='0|0|0 - Total: 2'>        if (id == Id_length) {
</span><span class='nc' id='L98' title='0|0|0 - Total: 3'>            lengthAttr = attr;
</span>        }
<span class='nc' id='L100' title='0|0|0 - Total: 1'>    }
</span>
    @Override
    protected int findInstanceIdInfo(String s)
    {
<span class='bc' id='L105' title='0|2|2 - Total: 2'>        if (s.equals("length")) {
</span><span class='bc' id='L106' title='0|5|5 - Total: 5'>            return instanceIdInfo(lengthAttr, Id_length);
</span>        }
<span class='bc' id='L108' title='0|4|4 - Total: 4'>        return super.findInstanceIdInfo(s);
</span>    }

    @Override
    protected String getInstanceIdName(int id)
    {
<span class='bpc' id='L114' title='0|1|1 - Total: 2'>        if (id == Id_length) { return "length"; }
</span><span class='nc' id='L115' title='0|0|0 - Total: 4'>        return super.getInstanceIdName(id);
</span>    }

    @Override
    protected Object getInstanceIdValue(int id)
    {
<span class='bpc' id='L121' title='0|1|1 - Total: 2'>        if (id == Id_length) {
</span><span class='bc' id='L122' title='0|5|5 - Total: 5'>            return ScriptRuntime.wrapNumber(length);
</span>        }
<span class='nc' id='L124' title='0|0|0 - Total: 4'>        return super.getInstanceIdValue(id);
</span>    }

    @Override
    protected void setInstanceIdValue(int id, Object value)
    {
<span class='bpc' id='L130' title='0|1|1 - Total: 2'>        if (id == Id_length) {
</span><span class='bc' id='L131' title='0|4|4 - Total: 4'>            setLength(value); return;
</span>        }
<span class='nc' id='L133' title='0|0|0 - Total: 4'>        super.setInstanceIdValue(id, value);
</span><span class='nc' id='L134' title='0|0|0 - Total: 1'>    }
</span>
    @Override
    protected void fillConstructorProperties(IdFunctionObject ctor)
    {
<span class='bc' id='L139' title='0|7|7 - Total: 7'>        addIdFunctionProperty(ctor, ARRAY_TAG, ConstructorId_join,
</span>                "join", 1);
<span class='bc' id='L141' title='0|7|7 - Total: 7'>        addIdFunctionProperty(ctor, ARRAY_TAG, ConstructorId_reverse,
</span>                "reverse", 0);
<span class='bc' id='L143' title='0|7|7 - Total: 7'>        addIdFunctionProperty(ctor, ARRAY_TAG, ConstructorId_sort,
</span>                "sort", 1);
<span class='bc' id='L145' title='0|7|7 - Total: 7'>        addIdFunctionProperty(ctor, ARRAY_TAG, ConstructorId_push,
</span>                "push", 1);
<span class='bc' id='L147' title='0|7|7 - Total: 7'>        addIdFunctionProperty(ctor, ARRAY_TAG, ConstructorId_pop,
</span>                "pop", 0);
<span class='bc' id='L149' title='0|7|7 - Total: 7'>        addIdFunctionProperty(ctor, ARRAY_TAG, ConstructorId_shift,
</span>                "shift", 0);
<span class='bc' id='L151' title='0|7|7 - Total: 7'>        addIdFunctionProperty(ctor, ARRAY_TAG, ConstructorId_unshift,
</span>                "unshift", 1);
<span class='bc' id='L153' title='0|7|7 - Total: 7'>        addIdFunctionProperty(ctor, ARRAY_TAG, ConstructorId_splice,
</span>                "splice", 2);
<span class='bc' id='L155' title='0|7|7 - Total: 7'>        addIdFunctionProperty(ctor, ARRAY_TAG, ConstructorId_concat,
</span>                "concat", 1);
<span class='bc' id='L157' title='0|7|7 - Total: 7'>        addIdFunctionProperty(ctor, ARRAY_TAG, ConstructorId_slice,
</span>                "slice", 2);
<span class='bc' id='L159' title='0|7|7 - Total: 7'>        addIdFunctionProperty(ctor, ARRAY_TAG, ConstructorId_indexOf,
</span>                "indexOf", 1);
<span class='bc' id='L161' title='0|7|7 - Total: 7'>        addIdFunctionProperty(ctor, ARRAY_TAG, ConstructorId_lastIndexOf,
</span>                "lastIndexOf", 1);
<span class='bc' id='L163' title='0|7|7 - Total: 7'>        addIdFunctionProperty(ctor, ARRAY_TAG, ConstructorId_every,
</span>                "every", 1);
<span class='bc' id='L165' title='0|7|7 - Total: 7'>        addIdFunctionProperty(ctor, ARRAY_TAG, ConstructorId_filter,
</span>                "filter", 1);
<span class='bc' id='L167' title='0|7|7 - Total: 7'>        addIdFunctionProperty(ctor, ARRAY_TAG, ConstructorId_forEach,
</span>                "forEach", 1);
<span class='bc' id='L169' title='0|7|7 - Total: 7'>        addIdFunctionProperty(ctor, ARRAY_TAG, ConstructorId_map,
</span>                "map", 1);
<span class='bc' id='L171' title='0|7|7 - Total: 7'>        addIdFunctionProperty(ctor, ARRAY_TAG, ConstructorId_some,
</span>                "some", 1);
<span class='bc' id='L173' title='0|7|7 - Total: 7'>        addIdFunctionProperty(ctor, ARRAY_TAG, ConstructorId_find,
</span>                "find", 1);
<span class='bc' id='L175' title='0|7|7 - Total: 7'>        addIdFunctionProperty(ctor, ARRAY_TAG, ConstructorId_findIndex,
</span>                "findIndex", 1);
<span class='bc' id='L177' title='0|7|7 - Total: 7'>        addIdFunctionProperty(ctor, ARRAY_TAG, ConstructorId_reduce,
</span>                "reduce", 1);
<span class='bc' id='L179' title='0|7|7 - Total: 7'>        addIdFunctionProperty(ctor, ARRAY_TAG, ConstructorId_reduceRight,
</span>                "reduceRight", 1);
<span class='bc' id='L181' title='0|7|7 - Total: 7'>        addIdFunctionProperty(ctor, ARRAY_TAG, ConstructorId_isArray,
</span>                "isArray", 1);
<span class='bc' id='L183' title='0|3|3 - Total: 3'>        super.fillConstructorProperties(ctor);
</span><span class='bc' id='L184' title='0|1|1 - Total: 1'>    }
</span>
    @Override
    protected void initPrototypeId(int id)
    {
<span class='bc' id='L189' title='0|2|2 - Total: 2'>        if (id == SymbolId_iterator) {
</span><span class='bc' id='L190' title='0|8|8 - Total: 8'>            initPrototypeMethod(ARRAY_TAG, id, SymbolKey.ITERATOR, "[Symbol.iterator]", 0);
</span><span class='bc' id='L191' title='0|1|1 - Total: 1'>            return;
</span>        }

<span class='bc' id='L194' title='0|2|2 - Total: 2'>        String s, fnName = null;
</span>        int arity;
<span class='bpc' id='L196' title='0|25|25 - Total: 26'>        switch (id) {
</span><span class='bc' id='L197' title='0|5|5 - Total: 5'>          case Id_constructor:    arity=1; s="constructor";    break;
</span><span class='bc' id='L198' title='0|5|5 - Total: 5'>          case Id_toString:       arity=0; s="toString";       break;
</span><span class='bc' id='L199' title='0|5|5 - Total: 5'>          case Id_toLocaleString: arity=0; s="toLocaleString"; break;
</span><span class='bc' id='L200' title='0|5|5 - Total: 5'>          case Id_toSource:       arity=0; s="toSource";       break;
</span><span class='bc' id='L201' title='0|5|5 - Total: 5'>          case Id_join:           arity=1; s="join";           break;
</span><span class='bc' id='L202' title='0|5|5 - Total: 5'>          case Id_reverse:        arity=0; s="reverse";        break;
</span><span class='bc' id='L203' title='0|5|5 - Total: 5'>          case Id_sort:           arity=1; s="sort";           break;
</span><span class='bc' id='L204' title='0|5|5 - Total: 5'>          case Id_push:           arity=1; s="push";           break;
</span><span class='bc' id='L205' title='0|5|5 - Total: 5'>          case Id_pop:            arity=0; s="pop";            break;
</span><span class='bc' id='L206' title='0|5|5 - Total: 5'>          case Id_shift:          arity=0; s="shift";          break;
</span><span class='bc' id='L207' title='0|5|5 - Total: 5'>          case Id_unshift:        arity=1; s="unshift";        break;
</span><span class='bc' id='L208' title='0|5|5 - Total: 5'>          case Id_splice:         arity=2; s="splice";         break;
</span><span class='bc' id='L209' title='0|5|5 - Total: 5'>          case Id_concat:         arity=1; s="concat";         break;
</span><span class='bc' id='L210' title='0|5|5 - Total: 5'>          case Id_slice:          arity=2; s="slice";          break;
</span><span class='bc' id='L211' title='0|5|5 - Total: 5'>          case Id_indexOf:        arity=1; s="indexOf";        break;
</span><span class='bc' id='L212' title='0|5|5 - Total: 5'>          case Id_lastIndexOf:    arity=1; s="lastIndexOf";    break;
</span><span class='bc' id='L213' title='0|5|5 - Total: 5'>          case Id_every:          arity=1; s="every";          break;
</span><span class='bc' id='L214' title='0|5|5 - Total: 5'>          case Id_filter:         arity=1; s="filter";         break;
</span><span class='bc' id='L215' title='0|5|5 - Total: 5'>          case Id_forEach:        arity=1; s="forEach";        break;
</span><span class='bc' id='L216' title='0|5|5 - Total: 5'>          case Id_map:            arity=1; s="map";            break;
</span><span class='bc' id='L217' title='0|5|5 - Total: 5'>          case Id_some:           arity=1; s="some";           break;
</span><span class='bc' id='L218' title='0|5|5 - Total: 5'>          case Id_find:           arity=1; s="find";           break;
</span><span class='bc' id='L219' title='0|5|5 - Total: 5'>          case Id_findIndex:      arity=1; s="findIndex";      break;
</span><span class='bc' id='L220' title='0|5|5 - Total: 5'>          case Id_reduce:         arity=1; s="reduce";         break;
</span><span class='bc' id='L221' title='0|5|5 - Total: 5'>          case Id_reduceRight:    arity=1; s="reduceRight";    break;
</span><span class='nc' id='L222' title='0|0|0 - Total: 6'>          default: throw new IllegalArgumentException(String.valueOf(id));
</span>        }

<span class='bc' id='L225' title='0|8|8 - Total: 8'>        initPrototypeMethod(ARRAY_TAG, id, s, fnName, arity);
</span><span class='bc' id='L226' title='0|1|1 - Total: 1'>    }
</span>
    @Override
    public Object execIdCall(IdFunctionObject f, Context cx, Scriptable scope,
                             Scriptable thisObj, Object[] args)
    {
<span class='bpc' id='L232' title='0|1|1 - Total: 2'>        if (!f.hasTag(ARRAY_TAG)) {
</span><span class='nc' id='L233' title='0|0|0 - Total: 8'>            return super.execIdCall(f, cx, scope, thisObj, args);
</span>        }
<span class='bc' id='L235' title='0|3|3 - Total: 3'>        int id = f.methodId();
</span>      again:
        for (;;) {
<span class='bpc' id='L238' title='0|21|21 - Total: 22'>            switch (id) {
</span>              case ConstructorId_join:
              case ConstructorId_reverse:
              case ConstructorId_sort:
              case ConstructorId_push:
              case ConstructorId_pop:
              case ConstructorId_shift:
              case ConstructorId_unshift:
              case ConstructorId_splice:
              case ConstructorId_concat:
              case ConstructorId_slice:
              case ConstructorId_indexOf:
              case ConstructorId_lastIndexOf:
              case ConstructorId_every:
              case ConstructorId_filter:
              case ConstructorId_forEach:
              case ConstructorId_map:
              case ConstructorId_some:
              case ConstructorId_find:
              case ConstructorId_findIndex:
              case ConstructorId_reduce:
              case ConstructorId_reduceRight: {
                // this is a small trick; we will handle all the ConstructorId_xxx calls
                // the same way the object calls are processed
                // so we adjust the args, inverting the id and
                // restarting the method selection
                // Attention: the implementations have to be aware of this
<span class='bpc' id='L265' title='0|1|1 - Total: 2'>                if (args.length > 0) {
</span><span class='bc' id='L266' title='0|7|7 - Total: 7'>                    thisObj = ScriptRuntime.toObject(cx, scope, args[0]);
</span><span class='bc' id='L267' title='0|6|6 - Total: 6'>                    Object[] newArgs = new Object[args.length-1];
</span><span class='bc' id='L268' title='0|2|2 - Total: 2'>                    for (int i=0; i < newArgs.length; i++)
</span><span class='bc' id='L269' title='0|8|8 - Total: 8'>                        newArgs[i] = args[i+1];
</span><span class='bc' id='L270' title='0|2|2 - Total: 2'>                    args = newArgs;
</span>                }
<span class='bc' id='L272' title='0|3|3 - Total: 3'>                id = -id;
</span><span class='bc' id='L273' title='0|1|1 - Total: 1'>                continue again;
</span>              }

              case ConstructorId_isArray:
<span class='bc' id='L277' title='0|4|4 - Total: 4'>                return args.length > 0 && js_isArray(args[0]);
</span>
              case Id_constructor: {
<span class='bc' id='L280' title='0|2|2 - Total: 2'>                boolean inNewExpr = (thisObj == null);
</span><span class='bc' id='L281' title='0|2|2 - Total: 2'>                if (!inNewExpr) {
</span>                    // IdFunctionObject.construct will set up parent, proto
<span class='bc' id='L283' title='0|6|6 - Total: 6'>                    return f.construct(cx, scope, args);
</span>                }
<span class='bc' id='L285' title='0|5|5 - Total: 5'>                return jsConstructor(cx, scope, args);
</span>              }

              case Id_toString:
<span class='bc' id='L289' title='0|7|7 - Total: 7'>                return toStringHelper(cx, scope, thisObj,
</span><span class='bc' id='L290' title='0|2|2 - Total: 2'>                    cx.hasFeature(Context.FEATURE_TO_STRING_AS_SOURCE), false);
</span>
              case Id_toLocaleString:
<span class='bc' id='L293' title='0|7|7 - Total: 7'>                return toStringHelper(cx, scope, thisObj, false, true);
</span>
              case Id_toSource:
<span class='bc' id='L296' title='0|7|7 - Total: 7'>                return toStringHelper(cx, scope, thisObj, true, false);
</span>
              case Id_join:
<span class='bc' id='L299' title='0|5|5 - Total: 5'>                return js_join(cx, thisObj, args);
</span>
              case Id_reverse:
<span class='bc' id='L302' title='0|5|5 - Total: 5'>                return js_reverse(cx, thisObj, args);
</span>
              case Id_sort:
<span class='bc' id='L305' title='0|6|6 - Total: 6'>                return js_sort(cx, scope, thisObj, args);
</span>
              case Id_push:
<span class='bc' id='L308' title='0|5|5 - Total: 5'>                return js_push(cx, thisObj, args);
</span>
              case Id_pop:
<span class='bc' id='L311' title='0|5|5 - Total: 5'>                return js_pop(cx, thisObj, args);
</span>
              case Id_shift:
<span class='bc' id='L314' title='0|5|5 - Total: 5'>                return js_shift(cx, thisObj, args);
</span>
              case Id_unshift:
<span class='bc' id='L317' title='0|5|5 - Total: 5'>                return js_unshift(cx, thisObj, args);
</span>
              case Id_splice:
<span class='bc' id='L320' title='0|6|6 - Total: 6'>                return js_splice(cx, scope, thisObj, args);
</span>
              case Id_concat:
<span class='bc' id='L323' title='0|6|6 - Total: 6'>                return js_concat(cx, scope, thisObj, args);
</span>
              case Id_slice:
<span class='bc' id='L326' title='0|6|6 - Total: 6'>                return js_slice(cx, thisObj, args);
</span>
              case Id_indexOf:
<span class='bc' id='L329' title='0|5|5 - Total: 5'>                return js_indexOf(cx, thisObj, args);
</span>
              case Id_lastIndexOf:
<span class='bc' id='L332' title='0|5|5 - Total: 5'>                return js_lastIndexOf(cx, thisObj, args);
</span>
              case Id_every:
              case Id_filter:
              case Id_forEach:
              case Id_map:
              case Id_some:
              case Id_find:
              case Id_findIndex:
<span class='bc' id='L341' title='0|7|7 - Total: 7'>                return iterativeMethod(cx, f, scope, thisObj, args);
</span>              case Id_reduce:
              case Id_reduceRight:
<span class='bc' id='L344' title='0|7|7 - Total: 7'>                return reduceMethod(cx, id, scope, thisObj, args);
</span>
              case SymbolId_iterator:
<span class='bc' id='L347' title='0|6|6 - Total: 6'>                return new NativeArrayIterator(scope, thisObj);
</span>            }
<span class='nc' id='L349' title='0|0|0 - Total: 13'>            throw new IllegalArgumentException("Array.prototype has no method: " + f.getFunctionName());
</span>        }
    }

    @Override
    public Object get(int index, Scriptable start)
    {
<span class='bc' id='L356' title='0|4|4 - Total: 4'>        if (!denseOnly && isGetterOrSetter(null, index, false))
</span><span class='bc' id='L357' title='0|5|5 - Total: 5'>            return super.get(index, start);
</span><span class='bc' id='L358' title='0|6|6 - Total: 6'>        if (dense != null && 0 <= index && index < dense.length)
</span><span class='bc' id='L359' title='0|5|5 - Total: 5'>            return dense[index];
</span><span class='bc' id='L360' title='0|5|5 - Total: 5'>        return super.get(index, start);
</span>    }

    @Override
    public boolean has(int index, Scriptable start)
    {
<span class='bc' id='L366' title='0|4|4 - Total: 4'>        if (!denseOnly && isGetterOrSetter(null, index, false))
</span><span class='bc' id='L367' title='0|5|5 - Total: 5'>            return super.has(index, start);
</span><span class='bc' id='L368' title='0|6|6 - Total: 6'>        if (dense != null && 0 <= index && index < dense.length)
</span><span class='bc' id='L369' title='0|2|2 - Total: 2'>            return dense[index] != NOT_FOUND;
</span><span class='bc' id='L370' title='0|5|5 - Total: 5'>        return super.has(index, start);
</span>    }

    private static long toArrayIndex(Object id) {
<span class='bc' id='L374' title='0|2|2 - Total: 2'>        if (id instanceof String) {
</span><span class='bc' id='L375' title='0|4|4 - Total: 4'>            return toArrayIndex((String)id);
</span><span class='bc' id='L376' title='0|2|2 - Total: 2'>        } else if (id instanceof Number) {
</span><span class='bc' id='L377' title='0|5|5 - Total: 5'>            return toArrayIndex(((Number)id).doubleValue());
</span>        }
<span class='bc' id='L379' title='0|2|2 - Total: 2'>        return -1;
</span>    }

    // if id is an array index (ECMA 15.4.0), return the number,
    // otherwise return -1L
    private static long toArrayIndex(String id)
    {
<span class='bc' id='L386' title='0|4|4 - Total: 4'>        long index = toArrayIndex(ScriptRuntime.toNumber(id));
</span>        // Assume that ScriptRuntime.toString(index) is the same
        // as java.lang.Long.toString(index) for long
<span class='bc' id='L389' title='0|2|2 - Total: 2'>        if (Long.toString(index).equals(id)) {
</span><span class='bc' id='L390' title='0|2|2 - Total: 2'>            return index;
</span>        }
<span class='bc' id='L392' title='0|2|2 - Total: 2'>        return -1;
</span>    }

    private static long toArrayIndex(double d) {
<span class='bc' id='L396' title='0|2|2 - Total: 2'>        if (d == d) {
</span><span class='bc' id='L397' title='0|3|3 - Total: 3'>            long index = ScriptRuntime.toUint32(d);
</span><span class='bc' id='L398' title='0|4|4 - Total: 4'>            if (index == d && index != 4294967295L) {
</span><span class='bc' id='L399' title='0|2|2 - Total: 2'>                return index;
</span>            }
        }
<span class='bc' id='L402' title='0|2|2 - Total: 2'>        return -1;
</span>    }

    private static int toDenseIndex(Object id) {
<span class='bc' id='L406' title='0|3|3 - Total: 3'>      long index = toArrayIndex(id);
</span><span class='bpc' id='L407' title='0|3|3 - Total: 4'>      return 0 <= index && index < Integer.MAX_VALUE ? (int) index : -1;
</span>    }

    @Override
    public void put(String id, Scriptable start, Object value)
    {
<span class='bc' id='L413' title='0|5|5 - Total: 5'>        super.put(id, start, value);
</span><span class='bc' id='L414' title='0|2|2 - Total: 2'>        if (start == this) {
</span>            // If the object is sealed, super will throw exception
<span class='bc' id='L416' title='0|3|3 - Total: 3'>            long index = toArrayIndex(id);
</span><span class='bc' id='L417' title='0|2|2 - Total: 2'>            if (index >= length) {
</span><span class='bc' id='L418' title='0|5|5 - Total: 5'>                length = index + 1;
</span><span class='bc' id='L419' title='0|3|3 - Total: 3'>                denseOnly = false;
</span>            }
        }
<span class='bc' id='L422' title='0|1|1 - Total: 1'>    }
</span>
    private boolean ensureCapacity(int capacity)
    {
<span class='bc' id='L426' title='0|2|2 - Total: 2'>        if (capacity > dense.length) {
</span><span class='bpc' id='L427' title='0|1|1 - Total: 2'>            if (capacity > MAX_PRE_GROW_SIZE) {
</span><span class='nc' id='L428' title='0|0|0 - Total: 3'>                denseOnly = false;
</span><span class='nc' id='L429' title='0|0|0 - Total: 2'>                return false;
</span>            }
<span class='bc' id='L431' title='0|10|10 - Total: 10'>            capacity = Math.max(capacity, (int)(dense.length * GROW_FACTOR));
</span><span class='bc' id='L432' title='0|3|3 - Total: 3'>            Object[] newDense = new Object[capacity];
</span><span class='bc' id='L433' title='0|9|9 - Total: 9'>            System.arraycopy(dense, 0, newDense, 0, dense.length);
</span><span class='bc' id='L434' title='0|8|8 - Total: 8'>            Arrays.fill(newDense, dense.length, newDense.length,
</span>                        Scriptable.NOT_FOUND);
<span class='bc' id='L436' title='0|3|3 - Total: 3'>            dense = newDense;
</span>        }
<span class='bc' id='L438' title='0|2|2 - Total: 2'>        return true;
</span>    }

    @Override
    public void put(int index, Scriptable start, Object value)
    {
<span class='bpc' id='L444' title='0|9|9 - Total: 10'>        if (start == this && !isSealed() && dense != null && 0 <= index &&
</span><span class='bc' id='L445' title='0|2|2 - Total: 2'>            (denseOnly || !isGetterOrSetter(null, index, true)))
</span>        {
<span class='bpc' id='L447' title='0|1|1 - Total: 4'>            if (!isExtensible() && this.length <= index) {
</span><span class='nc' id='L448' title='0|0|0 - Total: 1'>                return;
</span><span class='bc' id='L449' title='0|2|2 - Total: 2'>            } else if (index < dense.length) {
</span><span class='bc' id='L450' title='0|5|5 - Total: 5'>                dense[index] = value;
</span><span class='bc' id='L451' title='0|2|2 - Total: 2'>                if (this.length <= index)
</span><span class='bc' id='L452' title='0|6|6 - Total: 6'>                    this.length = (long)index + 1;
</span><span class='bc' id='L453' title='0|1|1 - Total: 1'>                return;
</span><span class='bc' id='L454' title='0|4|4 - Total: 4'>            } else if (denseOnly && index < dense.length * GROW_FACTOR &&
</span><span class='bpc' id='L455' title='0|1|1 - Total: 2'>                       ensureCapacity(index+1))
</span>            {
<span class='bc' id='L457' title='0|5|5 - Total: 5'>                dense[index] = value;
</span><span class='bc' id='L458' title='0|6|6 - Total: 6'>                this.length = (long)index + 1;
</span><span class='bc' id='L459' title='0|1|1 - Total: 1'>                return;
</span>            } else {
<span class='bc' id='L461' title='0|3|3 - Total: 3'>                denseOnly = false;
</span>            }
        }
<span class='bc' id='L464' title='0|5|5 - Total: 5'>        super.put(index, start, value);
</span><span class='bpc' id='L465' title='0|3|3 - Total: 4'>        if (start == this && (lengthAttr & READONLY) == 0) {
</span>            // only set the array length if given an array index (ECMA 15.4.0)
<span class='bc' id='L467' title='0|2|2 - Total: 2'>            if (this.length <= index) {
</span>                // avoid overflowing index!
<span class='bc' id='L469' title='0|6|6 - Total: 6'>                this.length = (long)index + 1;
</span>            }
        }
<span class='bc' id='L472' title='0|1|1 - Total: 1'>    }
</span>
    @Override
    public void delete(int index)
    {
<span class='bpc' id='L477' title='0|4|4 - Total: 6'>        if (dense != null && 0 <= index && index < dense.length &&
</span><span class='bpc' id='L478' title='0|5|5 - Total: 6'>            !isSealed() && (denseOnly || !isGetterOrSetter(null, index, true)))
</span>        {
<span class='bc' id='L480' title='0|6|6 - Total: 6'>            dense[index] = NOT_FOUND;
</span>        } else {
<span class='bc' id='L482' title='0|3|3 - Total: 3'>            super.delete(index);
</span>        }
<span class='bc' id='L484' title='0|1|1 - Total: 1'>    }
</span>
    @Override
    public Object[] getIds(boolean nonEnumerable, boolean getSymbols)
    {
<span class='bc' id='L489' title='0|5|5 - Total: 5'>        Object[] superIds = super.getIds(nonEnumerable, getSymbols);
</span><span class='bc' id='L490' title='0|2|2 - Total: 2'>        if (dense == null) { return superIds; }
</span><span class='bc' id='L491' title='0|4|4 - Total: 4'>        int N = dense.length;
</span><span class='bc' id='L492' title='0|3|3 - Total: 3'>        long currentLength = length;
</span><span class='bc' id='L493' title='0|2|2 - Total: 2'>        if (N > currentLength) {
</span><span class='bc' id='L494' title='0|3|3 - Total: 3'>            N = (int)currentLength;
</span>        }
<span class='bc' id='L496' title='0|2|2 - Total: 2'>        if (N == 0) { return superIds; }
</span><span class='bc' id='L497' title='0|3|3 - Total: 3'>        int superLength = superIds.length;
</span><span class='bc' id='L498' title='0|5|5 - Total: 5'>        Object[] ids = new Object[N + superLength];
</span>
<span class='bc' id='L500' title='0|2|2 - Total: 2'>        int presentCount = 0;
</span><span class='bc' id='L501' title='0|2|2 - Total: 2'>        for (int i = 0; i != N; ++i) {
</span>            // Replace existing elements by their indexes
<span class='bc' id='L503' title='0|2|2 - Total: 2'>            if (dense[i] != NOT_FOUND) {
</span><span class='bc' id='L504' title='0|5|5 - Total: 5'>                ids[presentCount] = Integer.valueOf(i);
</span><span class='bc' id='L505' title='0|1|1 - Total: 1'>                ++presentCount;
</span>            }
        }
<span class='bc' id='L508' title='0|2|2 - Total: 2'>        if (presentCount != N) {
</span>            // dense contains deleted elems, need to shrink the result
<span class='bc' id='L510' title='0|5|5 - Total: 5'>            Object[] tmp = new Object[presentCount + superLength];
</span><span class='bc' id='L511' title='0|6|6 - Total: 6'>            System.arraycopy(ids, 0, tmp, 0, presentCount);
</span><span class='bc' id='L512' title='0|2|2 - Total: 2'>            ids = tmp;
</span>        }
<span class='bc' id='L514' title='0|6|6 - Total: 6'>        System.arraycopy(superIds, 0, ids, presentCount, superLength);
</span><span class='bc' id='L515' title='0|2|2 - Total: 2'>        return ids;
</span>    }

    public Integer[] getIndexIds() {
<span class='bc' id='L519' title='0|3|3 - Total: 3'>      Object[] ids = getIds();
</span><span class='bc' id='L520' title='0|6|6 - Total: 6'>      java.util.List<Integer> indices = new java.util.ArrayList<Integer>(ids.length);
</span><span class='bc' id='L521' title='0|2|2 - Total: 2'>      for (Object id : ids) {
</span><span class='bc' id='L522' title='0|3|3 - Total: 3'>        int int32Id = ScriptRuntime.toInt32(id);
</span><span class='bc' id='L523' title='0|4|4 - Total: 4'>        if (int32Id >= 0 && ScriptRuntime.toString(int32Id).equals(ScriptRuntime.toString(id))) {
</span><span class='bc' id='L524' title='0|5|5 - Total: 5'>          indices.add(int32Id);
</span>        }
      }
<span class='bc' id='L527' title='0|7|7 - Total: 7'>      return indices.toArray(new Integer[indices.size()]);
</span>    }

    @Override
    public Object getDefaultValue(Class<?> hint)
    {
<span class='bc' id='L533' title='0|2|2 - Total: 2'>        if (hint == ScriptRuntime.NumberClass) {
</span><span class='bc' id='L534' title='0|2|2 - Total: 2'>            Context cx = Context.getContext();
</span><span class='bc' id='L535' title='0|2|2 - Total: 2'>            if (cx.getLanguageVersion() == Context.VERSION_1_2)
</span><span class='bc' id='L536' title='0|4|4 - Total: 4'>                return Long.valueOf(length);
</span>        }
<span class='bc' id='L538' title='0|4|4 - Total: 4'>        return super.getDefaultValue(hint);
</span>    }

    private ScriptableObject defaultIndexPropertyDescriptor(Object value) {
<span class='bc' id='L542' title='0|3|3 - Total: 3'>      Scriptable scope = getParentScope();
</span><span class='bpc' id='L543' title='0|1|1 - Total: 2'>      if (scope == null) scope = this;
</span><span class='bc' id='L544' title='0|4|4 - Total: 4'>      ScriptableObject desc = new NativeObject();
</span><span class='bc' id='L545' title='0|4|4 - Total: 4'>      ScriptRuntime.setBuiltinProtoAndParent(desc, scope, TopLevel.Builtins.Object);
</span><span class='bc' id='L546' title='0|5|5 - Total: 5'>      desc.defineProperty("value", value, EMPTY);
</span><span class='bc' id='L547' title='0|6|6 - Total: 6'>      desc.defineProperty("writable", true, EMPTY);
</span><span class='bc' id='L548' title='0|6|6 - Total: 6'>      desc.defineProperty("enumerable", true, EMPTY);
</span><span class='bc' id='L549' title='0|6|6 - Total: 6'>      desc.defineProperty("configurable", true, EMPTY);
</span><span class='bc' id='L550' title='0|2|2 - Total: 2'>      return desc;
</span>    }

    @Override
    public int getAttributes(int index) {
<span class='nc' id='L555' title='0|0|0 - Total: 8'>        if (dense != null && index >= 0 && index < dense.length
</span>                && dense[index] != NOT_FOUND) {
<span class='nc' id='L557' title='0|0|0 - Total: 2'>            return EMPTY;
</span>        }
<span class='nc' id='L559' title='0|0|0 - Total: 4'>        return super.getAttributes(index);
</span>    }

    @Override
    protected ScriptableObject getOwnPropertyDescriptor(Context cx, Object id) {
<span class='bc' id='L564' title='0|2|2 - Total: 2'>      if (dense != null) {
</span><span class='bc' id='L565' title='0|3|3 - Total: 3'>        int index = toDenseIndex(id);
</span><span class='bpc' id='L566' title='0|5|5 - Total: 6'>        if (0 <= index && index < dense.length && dense[index] != NOT_FOUND) {
</span><span class='bc' id='L567' title='0|5|5 - Total: 5'>          Object value = dense[index];
</span><span class='bc' id='L568' title='0|4|4 - Total: 4'>          return defaultIndexPropertyDescriptor(value);
</span>        }
      }
<span class='bc' id='L571' title='0|5|5 - Total: 5'>      return super.getOwnPropertyDescriptor(cx, id);
</span>    }

    @Override
    protected void defineOwnProperty(Context cx, Object id,
                                     ScriptableObject desc,
                                     boolean checkValid) {
<span class='bc' id='L578' title='0|2|2 - Total: 2'>      if (dense != null) {
</span><span class='bc' id='L579' title='0|3|3 - Total: 3'>        Object[] values = dense;
</span><span class='bc' id='L580' title='0|3|3 - Total: 3'>        dense = null;
</span><span class='bc' id='L581' title='0|3|3 - Total: 3'>        denseOnly = false;
</span><span class='bc' id='L582' title='0|2|2 - Total: 2'>        for (int i = 0; i < values.length; i++) {
</span><span class='bc' id='L583' title='0|2|2 - Total: 2'>          if (values[i] != NOT_FOUND) {
</span><span class='bc' id='L584' title='0|7|7 - Total: 7'>            put(i, this, values[i]);
</span>          }
        }
      }
<span class='bc' id='L588' title='0|3|3 - Total: 3'>      long index = toArrayIndex(id);
</span><span class='bc' id='L589' title='0|2|2 - Total: 2'>      if (index >= length) {
</span><span class='bc' id='L590' title='0|5|5 - Total: 5'>        length = index + 1;
</span>      }
<span class='bc' id='L592' title='0|6|6 - Total: 6'>      super.defineOwnProperty(cx, id, desc, checkValid);
</span><span class='bc' id='L593' title='0|1|1 - Total: 1'>    }
</span>
    /**
     * See ECMA 15.4.1,2
     */
    private static Object jsConstructor(Context cx, Scriptable scope,
                                        Object[] args)
    {
<span class='bc' id='L601' title='0|2|2 - Total: 2'>        if (args.length == 0)
</span><span class='bc' id='L602' title='0|5|5 - Total: 5'>            return new NativeArray(0);
</span>
        // Only use 1 arg as first element for version 1.2; for
        // any other version (including 1.3) follow ECMA and use it as
        // a length.
<span class='bc' id='L607' title='0|2|2 - Total: 2'>        if (cx.getLanguageVersion() == Context.VERSION_1_2) {
</span><span class='bc' id='L608' title='0|5|5 - Total: 5'>            return new NativeArray(args);
</span>        } else {
<span class='bc' id='L610' title='0|4|4 - Total: 4'>            Object arg0 = args[0];
</span><span class='bc' id='L611' title='0|4|4 - Total: 4'>            if (args.length > 1 || !(arg0 instanceof Number)) {
</span><span class='bc' id='L612' title='0|5|5 - Total: 5'>                return new NativeArray(args);
</span>            } else {
<span class='bc' id='L614' title='0|3|3 - Total: 3'>                long len = ScriptRuntime.toUint32(arg0);
</span><span class='bpc' id='L615' title='0|1|1 - Total: 2'>                if (len != ((Number)arg0).doubleValue()) {
</span><span class='nc' id='L616' title='0|0|0 - Total: 3'>                    String msg = ScriptRuntime.getMessage0("msg.arraylength.bad");
</span><span class='nc' id='L617' title='0|0|0 - Total: 4'>                    throw ScriptRuntime.constructError("RangeError", msg);
</span>                }
<span class='bc' id='L619' title='0|5|5 - Total: 5'>                return new NativeArray(len);
</span>            }
        }
    }

    public long getLength() {
<span class='bc' id='L625' title='0|3|3 - Total: 3'>        return length;
</span>    }

    /** @deprecated Use {@link #getLength()} instead. */
    @Deprecated
    public long jsGet_length() {
<span class='nc' id='L631' title='0|0|0 - Total: 3'>        return getLength();
</span>    }

    /**
     * Change the value of the internal flag that determines whether all
     * storage is handed by a dense backing array rather than an associative
     * store.
     * @param denseOnly new value for denseOnly flag
     * @throws IllegalArgumentException if an attempt is made to enable
     *   denseOnly after it was disabled; NativeArray code is not written
     *   to handle switching back to a dense representation
     */
    void setDenseOnly(boolean denseOnly) {
<span class='bpc' id='L644' title='0|1|1 - Total: 4'>        if (denseOnly && !this.denseOnly)
</span><span class='nc' id='L645' title='0|0|0 - Total: 4'>            throw new IllegalArgumentException();
</span><span class='bc' id='L646' title='0|3|3 - Total: 3'>        this.denseOnly = denseOnly;
</span><span class='bc' id='L647' title='0|1|1 - Total: 1'>    }
</span>
    private void setLength(Object val) {
        /* XXX do we satisfy this?
         * 15.4.5.1 [[Put]](P, V):
         * 1. Call the [[CanPut]] method of A with name P.
         * 2. If Result(1) is false, return.
         * ?
         */
<span class='bpc' id='L656' title='0|1|1 - Total: 2'>        if ((lengthAttr & READONLY) != 0) {
</span><span class='nc' id='L657' title='0|0|0 - Total: 1'>            return;
</span>        }

<span class='bc' id='L660' title='0|3|3 - Total: 3'>        double d = ScriptRuntime.toNumber(val);
</span><span class='bc' id='L661' title='0|3|3 - Total: 3'>        long longVal = ScriptRuntime.toUint32(d);
</span><span class='bc' id='L662' title='0|2|2 - Total: 2'>        if (longVal != d) {
</span><span class='bc' id='L663' title='0|3|3 - Total: 3'>            String msg = ScriptRuntime.getMessage0("msg.arraylength.bad");
</span><span class='bc' id='L664' title='0|4|4 - Total: 4'>            throw ScriptRuntime.constructError("RangeError", msg);
</span>        }

<span class='bc' id='L667' title='0|2|2 - Total: 2'>        if (denseOnly) {
</span><span class='bc' id='L668' title='0|2|2 - Total: 2'>            if (longVal < length) {
</span>                // downcast okay because denseOnly
<span class='bc' id='L670' title='0|9|9 - Total: 9'>                Arrays.fill(dense, (int) longVal, dense.length, NOT_FOUND);
</span><span class='bc' id='L671' title='0|3|3 - Total: 3'>                length = longVal;
</span><span class='bc' id='L672' title='0|1|1 - Total: 1'>                return;
</span><span class='bpc' id='L673' title='0|3|3 - Total: 4'>            } else if (longVal < MAX_PRE_GROW_SIZE &&
</span>                       longVal < (length * GROW_FACTOR) &&
<span class='bpc' id='L675' title='0|1|1 - Total: 2'>                       ensureCapacity((int)longVal))
</span>            {
<span class='bc' id='L677' title='0|3|3 - Total: 3'>                length = longVal;
</span><span class='bc' id='L678' title='0|1|1 - Total: 1'>                return;
</span>            } else {
<span class='bc' id='L680' title='0|3|3 - Total: 3'>                denseOnly = false;
</span>            }
        }
<span class='bc' id='L683' title='0|2|2 - Total: 2'>        if (longVal < length) {
</span>            // remove all properties between longVal and length
<span class='bc' id='L685' title='0|2|2 - Total: 2'>            if (length - longVal > 0x1000) {
</span>                // assume that the representation is sparse
<span class='bc' id='L687' title='0|3|3 - Total: 3'>                Object[] e = getIds(); // will only find in object itself
</span><span class='bc' id='L688' title='0|2|2 - Total: 2'>                for (int i=0; i < e.length; i++) {
</span><span class='bc' id='L689' title='0|4|4 - Total: 4'>                    Object id = e[i];
</span><span class='bc' id='L690' title='0|2|2 - Total: 2'>                    if (id instanceof String) {
</span>                        // > MAXINT will appear as string
<span class='bc' id='L692' title='0|3|3 - Total: 3'>                        String strId = (String)id;
</span><span class='bc' id='L693' title='0|3|3 - Total: 3'>                        long index = toArrayIndex(strId);
</span><span class='bc' id='L694' title='0|2|2 - Total: 2'>                        if (index >= longVal)
</span><span class='bc' id='L695' title='0|3|3 - Total: 3'>                            delete(strId);
</span><span class='bc' id='L696' title='0|1|1 - Total: 1'>                    } else {
</span><span class='bc' id='L697' title='0|4|4 - Total: 4'>                        int index = ((Integer)id).intValue();
</span><span class='bpc' id='L698' title='0|1|1 - Total: 2'>                        if (index >= longVal)
</span><span class='bc' id='L699' title='0|3|3 - Total: 3'>                            delete(index);
</span>                    }
                }
<span class='bc' id='L702' title='0|1|1 - Total: 1'>            } else {
</span>                // assume a dense representation
<span class='bc' id='L704' title='0|2|2 - Total: 2'>                for (long i = longVal; i < length; i++) {
</span><span class='bc' id='L705' title='0|3|3 - Total: 3'>                    deleteElem(this, i);
</span>                }
            }
        }
<span class='bc' id='L709' title='0|3|3 - Total: 3'>        length = longVal;
</span><span class='bc' id='L710' title='0|1|1 - Total: 1'>    }
</span>
    /* Support for generic Array-ish objects.  Most of the Array
     * functions try to be generic; anything that has a length
     * property is assumed to be an array.
     * getLengthProperty returns 0 if obj does not have the length property
     * or its value is not convertible to a number.
     */
    static long getLengthProperty(Context cx, Scriptable obj) {
        // These will both give numeric lengths within Uint32 range.
<span class='bc' id='L720' title='0|2|2 - Total: 2'>        if (obj instanceof NativeString) {
</span><span class='bc' id='L721' title='0|5|5 - Total: 5'>            return ((NativeString)obj).getLength();
</span><span class='bc' id='L722' title='0|2|2 - Total: 2'>        } else if (obj instanceof NativeArray) {
</span><span class='bc' id='L723' title='0|4|4 - Total: 4'>            return ((NativeArray)obj).getLength();
</span>        }
<span class='bc' id='L725' title='0|4|4 - Total: 4'>        Object len = ScriptableObject.getProperty(obj, "length");
</span><span class='bc' id='L726' title='0|2|2 - Total: 2'>        if (len == Scriptable.NOT_FOUND) {
</span>            // toUint32(undefined) == 0
<span class='bc' id='L728' title='0|2|2 - Total: 2'>            return 0;
</span>        }
<span class='bc' id='L730' title='0|3|3 - Total: 3'>        return ScriptRuntime.toUint32(len);
</span>    }

    private static Object setLengthProperty(Context cx, Scriptable target,
                                            long length)
    {
<span class='bc' id='L736' title='0|4|4 - Total: 4'>        Object len = ScriptRuntime.wrapNumber(length);
</span><span class='bc' id='L737' title='0|4|4 - Total: 4'>        ScriptableObject.putProperty(target, "length", len);
</span><span class='bc' id='L738' title='0|2|2 - Total: 2'>        return len;
</span>    }

    /* Utility functions to encapsulate index > Integer.MAX_VALUE
     * handling.  Also avoids unnecessary object creation that would
     * be necessary to use the general ScriptRuntime.get/setElem
     * functions... though this is probably premature optimization.
     */
    private static void deleteElem(Scriptable target, long index) {
<span class='bc' id='L747' title='0|3|3 - Total: 3'>        int i = (int)index;
</span><span class='bc' id='L748' title='0|2|2 - Total: 2'>        if (i == index) { target.delete(i); }
</span><span class='bc' id='L749' title='0|4|4 - Total: 4'>        else { target.delete(Long.toString(index)); }
</span><span class='bc' id='L750' title='0|1|1 - Total: 1'>    }
</span>
    private static Object getElem(Context cx, Scriptable target, long index)
    {
<span class='bc' id='L754' title='0|4|4 - Total: 4'>        Object elem = getRawElem(target, index);
</span><span class='bc' id='L755' title='0|2|2 - Total: 2'>        return (elem != Scriptable.NOT_FOUND ? elem : Undefined.instance);
</span>    }

    // same as getElem, but without converting NOT_FOUND to undefined
    private static Object getRawElem(Scriptable target, long index) {
<span class='bc' id='L760' title='0|2|2 - Total: 2'>        if (index > Integer.MAX_VALUE) {
</span><span class='bc' id='L761' title='0|5|5 - Total: 5'>            return ScriptableObject.getProperty(target, Long.toString(index));
</span>        } else {
<span class='bc' id='L763' title='0|5|5 - Total: 5'>            return ScriptableObject.getProperty(target, (int)index);
</span>        }
    }

    private static void defineElem(Context cx, Scriptable target, long index,
                                   Object value)
    {
<span class='bpc' id='L770' title='0|1|1 - Total: 2'>        if (index > Integer.MAX_VALUE) {
</span><span class='nc' id='L771' title='0|0|0 - Total: 3'>            String id = Long.toString(index);
</span><span class='nc' id='L772' title='0|0|0 - Total: 5'>            target.put(id, target, value);
</span><span class='nc' id='L773' title='0|0|0 - Total: 1'>        } else {
</span><span class='bc' id='L774' title='0|6|6 - Total: 6'>            target.put((int)index, target, value);
</span>        }
<span class='bc' id='L776' title='0|1|1 - Total: 1'>    }
</span>
    private static void setElem(Context cx, Scriptable target, long index,
                                Object value)
    {
<span class='bc' id='L781' title='0|2|2 - Total: 2'>        if (index > Integer.MAX_VALUE) {
</span><span class='bc' id='L782' title='0|3|3 - Total: 3'>            String id = Long.toString(index);
</span><span class='bc' id='L783' title='0|4|4 - Total: 4'>            ScriptableObject.putProperty(target, id, value);
</span><span class='bc' id='L784' title='0|1|1 - Total: 1'>        } else {
</span><span class='bc' id='L785' title='0|5|5 - Total: 5'>            ScriptableObject.putProperty(target, (int)index, value);
</span>        }
<span class='bc' id='L787' title='0|1|1 - Total: 1'>    }
</span>
    // Similar as setElem(), but triggers deleteElem() if value is NOT_FOUND
    private static void setRawElem(Context cx, Scriptable target, long index,
                                   Object value) {
<span class='bc' id='L792' title='0|2|2 - Total: 2'>        if (value == NOT_FOUND) {
</span><span class='bc' id='L793' title='0|4|4 - Total: 4'>            deleteElem(target, index);
</span>        } else {
<span class='bc' id='L795' title='0|5|5 - Total: 5'>            setElem(cx, target, index, value);
</span>        }
<span class='bc' id='L797' title='0|1|1 - Total: 1'>    }
</span>
    private static String toStringHelper(Context cx, Scriptable scope,
                                         Scriptable thisObj,
                                         boolean toSource, boolean toLocale)
    {
        /* It's probably redundant to handle long lengths in this
         * function; StringBuilders are limited to 2^31 in java.
         */

<span class='bc' id='L807' title='0|4|4 - Total: 4'>        long length = getLengthProperty(cx, thisObj);
</span>
<span class='bc' id='L809' title='0|5|5 - Total: 5'>        StringBuilder result = new StringBuilder(256);
</span>
        // whether to return '4,unquoted,5' or '[4, "quoted", 5]'
        String separator;

<span class='bc' id='L814' title='0|2|2 - Total: 2'>        if (toSource) {
</span><span class='bc' id='L815' title='0|4|4 - Total: 4'>            result.append('[');
</span><span class='bc' id='L816' title='0|3|3 - Total: 3'>            separator = ", ";
</span>        } else {
<span class='bc' id='L818' title='0|2|2 - Total: 2'>            separator = ",";
</span>        }

<span class='bc' id='L821' title='0|2|2 - Total: 2'>        boolean haslast = false;
</span><span class='bc' id='L822' title='0|2|2 - Total: 2'>        long i = 0;
</span>
        boolean toplevel, iterating;
<span class='bc' id='L825' title='0|2|2 - Total: 2'>        if (cx.iterating == null) {
</span><span class='bc' id='L826' title='0|2|2 - Total: 2'>            toplevel = true;
</span><span class='bc' id='L827' title='0|2|2 - Total: 2'>            iterating = false;
</span><span class='bc' id='L828' title='0|7|7 - Total: 7'>            cx.iterating = new ObjToIntMap(31);
</span>        } else {
<span class='bc' id='L830' title='0|2|2 - Total: 2'>            toplevel = false;
</span><span class='bc' id='L831' title='0|5|5 - Total: 5'>            iterating = cx.iterating.has(thisObj);
</span>        }

        // Make sure cx.iterating is set to null when done
        // so we don't leak memory
        try {
<span class='bc' id='L837' title='0|2|2 - Total: 2'>            if (!iterating) {
</span><span class='bc' id='L838' title='0|5|5 - Total: 5'>                cx.iterating.put(thisObj, 0); // stop recursion.
</span>                // make toSource print null and undefined values in recent versions
<span class='bc' id='L840' title='0|2|2 - Total: 2'>                boolean skipUndefinedAndNull = !toSource
</span><span class='bc' id='L841' title='0|2|2 - Total: 2'>                        || cx.getLanguageVersion() < Context.VERSION_1_5;
</span><span class='bc' id='L842' title='0|2|2 - Total: 2'>                for (i = 0; i < length; i++) {
</span><span class='bc' id='L843' title='0|2|2 - Total: 2'>                    if (i > 0) result.append(separator);
</span><span class='bc' id='L844' title='0|4|4 - Total: 4'>                    Object elem = getRawElem(thisObj, i);
</span><span class='bc' id='L845' title='0|8|8 - Total: 8'>                    if (elem == NOT_FOUND || (skipUndefinedAndNull &&
</span>                            (elem == null || elem == Undefined.instance))) {
<span class='bc' id='L847' title='0|2|2 - Total: 2'>                        haslast = false;
</span><span class='bc' id='L848' title='0|1|1 - Total: 1'>                        continue;
</span>                    }
<span class='bc' id='L850' title='0|2|2 - Total: 2'>                    haslast = true;
</span>
<span class='bc' id='L852' title='0|2|2 - Total: 2'>                    if (toSource) {
</span><span class='bc' id='L853' title='0|8|8 - Total: 8'>                        result.append(ScriptRuntime.uneval(cx, scope, elem));
</span>
<span class='bc' id='L855' title='0|2|2 - Total: 2'>                    } else if (elem instanceof String) {
</span><span class='bc' id='L856' title='0|3|3 - Total: 3'>                        String s = (String)elem;
</span><span class='bpc' id='L857' title='0|1|1 - Total: 2'>                        if (toSource) {
</span><span class='nc' id='L858' title='0|0|0 - Total: 4'>                            result.append('\"');
</span><span class='nc' id='L859' title='0|0|0 - Total: 5'>                            result.append(ScriptRuntime.escapeString(s));
</span><span class='nc' id='L860' title='0|0|0 - Total: 5'>                            result.append('\"');
</span>                        } else {
<span class='bc' id='L862' title='0|4|4 - Total: 4'>                            result.append(s);
</span>                        }

<span class='bc' id='L865' title='0|1|1 - Total: 1'>                    } else {
</span><span class='bc' id='L866' title='0|2|2 - Total: 2'>                        if (toLocale) {
</span>                            Callable fun;
                            Scriptable funThis;
<span class='bc' id='L869' title='0|6|6 - Total: 6'>                            fun = ScriptRuntime.getPropFunctionAndThis(
</span>                                      elem, "toLocaleString", cx, scope);
<span class='bc' id='L871' title='0|3|3 - Total: 3'>                            funThis = ScriptRuntime.lastStoredScriptable(cx);
</span><span class='bc' id='L872' title='0|7|7 - Total: 7'>                            elem = fun.call(cx, scope, funThis,
</span>                                            ScriptRuntime.emptyArgs);
                        }
<span class='bc' id='L875' title='0|5|5 - Total: 5'>                        result.append(ScriptRuntime.toString(elem));
</span>                    }
                }
            }
        } finally {
<span class='bpc' id='L880' title='0|2|2 - Total: 4'>            if (toplevel) {
</span><span class='bpc' id='L881' title='0|4|4 - Total: 7'>                cx.iterating = null;
</span>            }
<span class='nc' id='L883' title='0|0|0 - Total: 2'>        }
</span>
<span class='bc' id='L885' title='0|2|2 - Total: 2'>        if (toSource) {
</span>            //for [,,].length behavior; we want toString to be symmetric.
<span class='bc' id='L887' title='0|4|4 - Total: 4'>            if (!haslast && i > 0)
</span><span class='bc' id='L888' title='0|5|5 - Total: 5'>                result.append(", ]");
</span>            else
<span class='bc' id='L890' title='0|4|4 - Total: 4'>                result.append(']');
</span>        }
<span class='bc' id='L892' title='0|3|3 - Total: 3'>        return result.toString();
</span>    }

    /**
     * See ECMA 15.4.4.3
     */
    private static String js_join(Context cx, Scriptable thisObj,
                                  Object[] args)
    {
<span class='bc' id='L901' title='0|4|4 - Total: 4'>        long llength = getLengthProperty(cx, thisObj);
</span><span class='bc' id='L902' title='0|3|3 - Total: 3'>        int length = (int)llength;
</span><span class='bpc' id='L903' title='0|1|1 - Total: 2'>        if (llength != length) {
</span><span class='nc' id='L904' title='0|0|0 - Total: 4'>            throw Context.reportRuntimeError1(
</span><span class='nc' id='L905' title='0|0|0 - Total: 1'>                "msg.arraylength.too.big", String.valueOf(llength));
</span>        }
        // if no args, use "," as separator
<span class='bc' id='L908' title='0|4|4 - Total: 4'>        String separator = (args.length < 1 || args[0] == Undefined.instance)
</span>                           ? ","
<span class='bc' id='L910' title='0|2|2 - Total: 2'>                           : ScriptRuntime.toString(args[0]);
</span><span class='bc' id='L911' title='0|2|2 - Total: 2'>        if (thisObj instanceof NativeArray) {
</span><span class='bc' id='L912' title='0|3|3 - Total: 3'>            NativeArray na = (NativeArray) thisObj;
</span><span class='bc' id='L913' title='0|2|2 - Total: 2'>            if (na.denseOnly) {
</span><span class='bc' id='L914' title='0|4|4 - Total: 4'>                StringBuilder sb = new StringBuilder();
</span><span class='bc' id='L915' title='0|2|2 - Total: 2'>                for (int i = 0; i < length; i++) {
</span><span class='bc' id='L916' title='0|2|2 - Total: 2'>                    if (i != 0) {
</span><span class='bc' id='L917' title='0|4|4 - Total: 4'>                        sb.append(separator);
</span>                    }
<span class='bpc' id='L919' title='0|1|1 - Total: 2'>                    if (i < na.dense.length) {
</span><span class='bc' id='L920' title='0|5|5 - Total: 5'>                        Object temp = na.dense[i];
</span><span class='bc' id='L921' title='0|6|6 - Total: 6'>                        if (temp != null && temp != Undefined.instance &&
</span>                            temp != Scriptable.NOT_FOUND)
                        {
<span class='bc' id='L924' title='0|5|5 - Total: 5'>                            sb.append(ScriptRuntime.toString(temp));
</span>                        }
                    }
                }
<span class='bc' id='L928' title='0|3|3 - Total: 3'>                return sb.toString();
</span>            }
        }
<span class='bpc' id='L931' title='0|1|1 - Total: 2'>        if (length == 0) {
</span><span class='nc' id='L932' title='0|0|0 - Total: 2'>            return "";
</span>        }
<span class='bc' id='L934' title='0|3|3 - Total: 3'>        String[] buf = new String[length];
</span><span class='bc' id='L935' title='0|2|2 - Total: 2'>        int total_size = 0;
</span><span class='bc' id='L936' title='0|2|2 - Total: 2'>        for (int i = 0; i != length; i++) {
</span><span class='bc' id='L937' title='0|6|6 - Total: 6'>            Object temp = getElem(cx, thisObj, i);
</span><span class='bc' id='L938' title='0|4|4 - Total: 4'>            if (temp != null && temp != Undefined.instance) {
</span><span class='bc' id='L939' title='0|3|3 - Total: 3'>                String str = ScriptRuntime.toString(temp);
</span><span class='bc' id='L940' title='0|5|5 - Total: 5'>                total_size += str.length();
</span><span class='bc' id='L941' title='0|4|4 - Total: 4'>                buf[i] = str;
</span>            }
        }
<span class='bc' id='L944' title='0|9|9 - Total: 9'>        total_size += (length - 1) * separator.length();
</span><span class='bc' id='L945' title='0|5|5 - Total: 5'>        StringBuilder sb = new StringBuilder(total_size);
</span><span class='bc' id='L946' title='0|2|2 - Total: 2'>        for (int i = 0; i != length; i++) {
</span><span class='bc' id='L947' title='0|2|2 - Total: 2'>            if (i != 0) {
</span><span class='bc' id='L948' title='0|4|4 - Total: 4'>                sb.append(separator);
</span>            }
<span class='bc' id='L950' title='0|4|4 - Total: 4'>            String str = buf[i];
</span><span class='bc' id='L951' title='0|2|2 - Total: 2'>            if (str != null) {
</span>                // str == null for undefined or null
<span class='bc' id='L953' title='0|4|4 - Total: 4'>                sb.append(str);
</span>            }
        }
<span class='bc' id='L956' title='0|3|3 - Total: 3'>        return sb.toString();
</span>    }

    /**
     * See ECMA 15.4.4.4
     */
    private static Scriptable js_reverse(Context cx, Scriptable thisObj,
                                         Object[] args)
    {
<span class='bc' id='L965' title='0|2|2 - Total: 2'>        if (thisObj instanceof NativeArray) {
</span><span class='bc' id='L966' title='0|3|3 - Total: 3'>            NativeArray na = (NativeArray) thisObj;
</span><span class='bc' id='L967' title='0|2|2 - Total: 2'>            if (na.denseOnly) {
</span><span class='bc' id='L968' title='0|2|2 - Total: 2'>                for (int i=0, j=((int)na.length)-1; i < j; i++,j--) {
</span><span class='bc' id='L969' title='0|5|5 - Total: 5'>                    Object temp = na.dense[i];
</span><span class='bc' id='L970' title='0|8|8 - Total: 8'>                    na.dense[i] = na.dense[j];
</span><span class='bc' id='L971' title='0|5|5 - Total: 5'>                    na.dense[j] = temp;
</span>                }
<span class='bc' id='L973' title='0|2|2 - Total: 2'>                return thisObj;
</span>            }
        }
<span class='bc' id='L976' title='0|4|4 - Total: 4'>        long len = getLengthProperty(cx, thisObj);
</span>
<span class='bc' id='L978' title='0|4|4 - Total: 4'>        long half = len / 2;
</span><span class='bc' id='L979' title='0|2|2 - Total: 2'>        for(long i=0; i < half; i++) {
</span><span class='bc' id='L980' title='0|6|6 - Total: 6'>            long j = len - i - 1;
</span><span class='bc' id='L981' title='0|4|4 - Total: 4'>            Object temp1 = getRawElem(thisObj, i);
</span><span class='bc' id='L982' title='0|4|4 - Total: 4'>            Object temp2 = getRawElem(thisObj, j);
</span><span class='bc' id='L983' title='0|5|5 - Total: 5'>            setRawElem(cx, thisObj, i, temp2);
</span><span class='bc' id='L984' title='0|5|5 - Total: 5'>            setRawElem(cx, thisObj, j, temp1);
</span>        }
<span class='bc' id='L986' title='0|2|2 - Total: 2'>        return thisObj;
</span>    }

    /**
     * See ECMA 15.4.4.5
     */
    private static Scriptable js_sort(final Context cx, final Scriptable scope,
            final Scriptable thisObj, final Object[] args)
    {
        final Comparator<Object> comparator;
<span class='bc' id='L996' title='0|4|4 - Total: 4'>        if (args.length > 0 && Undefined.instance != args[0]) {
</span><span class='bc' id='L997' title='0|4|4 - Total: 4'>            final Callable jsCompareFunction = ScriptRuntime
</span><span class='bc' id='L998' title='0|2|2 - Total: 2'>                    .getValueFunctionAndThis(args[0], cx);
</span><span class='bc' id='L999' title='0|3|3 - Total: 3'>            final Scriptable funThis = ScriptRuntime.lastStoredScriptable(cx);
</span><span class='bc' id='L1000' title='0|3|3 - Total: 3'>            final Object[] cmpBuf = new Object[2]; // Buffer for cmp arguments
</span><span class='bc' id='L1001' title='0|12|12 - Total: 12'>            comparator = new ElementComparator(
</span>                new Comparator<Object>() {
                  public int compare(final Object x, final Object y) {
                    // This comparator is invoked only for non-undefined objects
                    cmpBuf[0] = x;
                    cmpBuf[1] = y;
                    Object ret = jsCompareFunction.call(cx, scope, funThis,
                        cmpBuf);
                    final double d = ScriptRuntime.toNumber(ret);
                    if (d < 0) {
                      return -1;
                    } else if (d > 0) {
                      return +1;
                    }
                    return 0; // ??? double and 0???
                  }
                });
<span class='bc' id='L1018' title='0|1|1 - Total: 1'>        } else {
</span><span class='bc' id='L1019' title='0|2|2 - Total: 2'>            comparator = DEFAULT_COMPARATOR;
</span>        }

<span class='bc' id='L1022' title='0|4|4 - Total: 4'>        long llength = getLengthProperty(cx, thisObj);
</span><span class='bc' id='L1023' title='0|3|3 - Total: 3'>        final int length = (int) llength;
</span><span class='bpc' id='L1024' title='0|1|1 - Total: 2'>        if (llength != length) {
</span><span class='nc' id='L1025' title='0|0|0 - Total: 4'>            throw Context.reportRuntimeError1(
</span><span class='nc' id='L1026' title='0|0|0 - Total: 1'>                "msg.arraylength.too.big", String.valueOf(llength));
</span>        }
        // copy the JS array into a working array, so it can be
        // sorted cheaply.
<span class='bc' id='L1030' title='0|3|3 - Total: 3'>        final Object[] working = new Object[length];
</span><span class='bc' id='L1031' title='0|2|2 - Total: 2'>        for (int i = 0; i != length; ++i) {
</span><span class='bc' id='L1032' title='0|7|7 - Total: 7'>            working[i] = getRawElem(thisObj, i);
</span>        }

<span class='bc' id='L1035' title='0|3|3 - Total: 3'>        Sorting.hybridSort(working, comparator);
</span>
        // copy the working array back into thisObj
<span class='bc' id='L1038' title='0|2|2 - Total: 2'>        for (int i = 0; i < length; ++i) {
</span><span class='bc' id='L1039' title='0|8|8 - Total: 8'>            setRawElem(cx, thisObj, i, working[i]);
</span>        }

<span class='bc' id='L1042' title='0|2|2 - Total: 2'>        return thisObj;
</span>    }

    private static Object js_push(Context cx, Scriptable thisObj,
                                  Object[] args)
    {
<span class='bc' id='L1048' title='0|2|2 - Total: 2'>        if (thisObj instanceof NativeArray) {
</span><span class='bc' id='L1049' title='0|3|3 - Total: 3'>            NativeArray na = (NativeArray) thisObj;
</span><span class='bc' id='L1050' title='0|2|2 - Total: 2'>            if (na.denseOnly &&
</span><span class='bpc' id='L1051' title='0|1|1 - Total: 2'>                na.ensureCapacity((int) na.length + args.length))
</span>            {
<span class='bc' id='L1053' title='0|2|2 - Total: 2'>                for (int i = 0; i < args.length; i++) {
</span><span class='bc' id='L1054' title='0|14|14 - Total: 14'>                    na.dense[(int)na.length++] = args[i];
</span>                }
<span class='bc' id='L1056' title='0|5|5 - Total: 5'>                return ScriptRuntime.wrapNumber(na.length);
</span>            }
        }
<span class='bc' id='L1059' title='0|4|4 - Total: 4'>        long length = getLengthProperty(cx, thisObj);
</span><span class='bc' id='L1060' title='0|2|2 - Total: 2'>        for (int i = 0; i < args.length; i++) {
</span><span class='bc' id='L1061' title='0|10|10 - Total: 10'>            setElem(cx, thisObj, length + i, args[i]);
</span>        }

<span class='bc' id='L1064' title='0|6|6 - Total: 6'>        length += args.length;
</span><span class='bc' id='L1065' title='0|5|5 - Total: 5'>        Object lengthObj = setLengthProperty(cx, thisObj, length);
</span>
        /*
         * If JS1.2, follow Perl4 by returning the last thing pushed.
         * Otherwise, return the new array length.
         */
<span class='bpc' id='L1071' title='0|1|1 - Total: 2'>        if (cx.getLanguageVersion() == Context.VERSION_1_2)
</span>            // if JS1.2 && no arguments, return undefined.
<span class='nc' id='L1073' title='0|0|0 - Total: 2'>            return args.length == 0
</span>                ? Undefined.instance
                : args[args.length - 1];

        else
<span class='bc' id='L1078' title='0|2|2 - Total: 2'>            return lengthObj;
</span>    }

    private static Object js_pop(Context cx, Scriptable thisObj,
                                 Object[] args)
    {
        Object result;
<span class='bc' id='L1085' title='0|2|2 - Total: 2'>        if (thisObj instanceof NativeArray) {
</span><span class='bc' id='L1086' title='0|3|3 - Total: 3'>            NativeArray na = (NativeArray) thisObj;
</span><span class='bc' id='L1087' title='0|4|4 - Total: 4'>            if (na.denseOnly && na.length > 0) {
</span><span class='bc' id='L1088' title='0|6|6 - Total: 6'>                na.length--;
</span><span class='bc' id='L1089' title='0|7|7 - Total: 7'>                result = na.dense[(int)na.length];
</span><span class='bc' id='L1090' title='0|7|7 - Total: 7'>                na.dense[(int)na.length] = NOT_FOUND;
</span><span class='bc' id='L1091' title='0|2|2 - Total: 2'>                return result;
</span>            }
        }
<span class='bc' id='L1094' title='0|4|4 - Total: 4'>        long length = getLengthProperty(cx, thisObj);
</span><span class='bc' id='L1095' title='0|2|2 - Total: 2'>        if (length > 0) {
</span><span class='bc' id='L1096' title='0|4|4 - Total: 4'>            length--;
</span>
            // Get the to-be-deleted property's value.
<span class='bc' id='L1099' title='0|5|5 - Total: 5'>            result = getElem(cx, thisObj, length);
</span>
            // We need to delete the last property, because 'thisObj' may not
            // have setLength which does that for us.
<span class='bc' id='L1103' title='0|4|4 - Total: 4'>            deleteElem(thisObj, length);
</span>        } else {
<span class='bc' id='L1105' title='0|2|2 - Total: 2'>            result = Undefined.instance;
</span>        }
        // necessary to match js even when length < 0; js pop will give a
        // length property to any target it is called on.
<span class='bc' id='L1109' title='0|5|5 - Total: 5'>        setLengthProperty(cx, thisObj, length);
</span>
<span class='bc' id='L1111' title='0|2|2 - Total: 2'>        return result;
</span>    }

    private static Object js_shift(Context cx, Scriptable thisObj,
                                   Object[] args)
    {
<span class='bc' id='L1117' title='0|2|2 - Total: 2'>        if (thisObj instanceof NativeArray) {
</span><span class='bc' id='L1118' title='0|3|3 - Total: 3'>            NativeArray na = (NativeArray) thisObj;
</span><span class='bc' id='L1119' title='0|4|4 - Total: 4'>            if (na.denseOnly && na.length > 0) {
</span><span class='bc' id='L1120' title='0|6|6 - Total: 6'>                na.length--;
</span><span class='bc' id='L1121' title='0|5|5 - Total: 5'>                Object result = na.dense[0];
</span><span class='bc' id='L1122' title='0|10|10 - Total: 10'>                System.arraycopy(na.dense, 1, na.dense, 0, (int)na.length);
</span><span class='bc' id='L1123' title='0|7|7 - Total: 7'>                na.dense[(int)na.length] = NOT_FOUND;
</span><span class='bc' id='L1124' title='0|2|2 - Total: 2'>                return result == NOT_FOUND ? Undefined.instance : result;
</span>            }
        }
        Object result;
<span class='bc' id='L1128' title='0|4|4 - Total: 4'>        long length = getLengthProperty(cx, thisObj);
</span><span class='bc' id='L1129' title='0|2|2 - Total: 2'>        if (length > 0) {
</span><span class='bc' id='L1130' title='0|2|2 - Total: 2'>            long i = 0;
</span><span class='bc' id='L1131' title='0|4|4 - Total: 4'>            length--;
</span>
            // Get the to-be-deleted property's value.
<span class='bc' id='L1134' title='0|5|5 - Total: 5'>            result = getElem(cx, thisObj, i);
</span>
            /*
             * Slide down the array above the first element.  Leave i
             * set to point to the last element.
             */
<span class='bpc' id='L1140' title='0|1|1 - Total: 2'>            if (length > 0) {
</span><span class='bc' id='L1141' title='0|2|2 - Total: 2'>                for (i = 1; i <= length; i++) {
</span><span class='bc' id='L1142' title='0|4|4 - Total: 4'>                    Object temp = getRawElem(thisObj, i);
</span><span class='bc' id='L1143' title='0|7|7 - Total: 7'>                    setRawElem(cx, thisObj, i - 1, temp);
</span>                }
            }
            // We need to delete the last property, because 'thisObj' may not
            // have setLength which does that for us.
<span class='bc' id='L1148' title='0|3|3 - Total: 3'>            deleteElem(thisObj, length);
</span><span class='bc' id='L1149' title='0|1|1 - Total: 1'>        } else {
</span><span class='bc' id='L1150' title='0|2|2 - Total: 2'>            result = Undefined.instance;
</span>        }
<span class='bc' id='L1152' title='0|5|5 - Total: 5'>        setLengthProperty(cx, thisObj, length);
</span><span class='bc' id='L1153' title='0|2|2 - Total: 2'>        return result;
</span>    }

    private static Object js_unshift(Context cx, Scriptable thisObj,
                                     Object[] args)
    {
<span class='bc' id='L1159' title='0|2|2 - Total: 2'>        if (thisObj instanceof NativeArray) {
</span><span class='bc' id='L1160' title='0|3|3 - Total: 3'>            NativeArray na = (NativeArray) thisObj;
</span><span class='bc' id='L1161' title='0|2|2 - Total: 2'>            if (na.denseOnly &&
</span><span class='bpc' id='L1162' title='0|1|1 - Total: 2'>                na.ensureCapacity((int)na.length + args.length))
</span>            {
<span class='bc' id='L1164' title='0|11|11 - Total: 11'>                System.arraycopy(na.dense, 0, na.dense, args.length,
</span>                                 (int) na.length);
<span class='bc' id='L1166' title='0|2|2 - Total: 2'>                for (int i = 0; i < args.length; i++) {
</span><span class='bc' id='L1167' title='0|7|7 - Total: 7'>                    na.dense[i] = args[i];
</span>                }
<span class='bc' id='L1169' title='0|8|8 - Total: 8'>                na.length += args.length;
</span><span class='bc' id='L1170' title='0|5|5 - Total: 5'>                return ScriptRuntime.wrapNumber(na.length);
</span>            }
        }
<span class='bc' id='L1173' title='0|4|4 - Total: 4'>        long length = getLengthProperty(cx, thisObj);
</span><span class='bc' id='L1174' title='0|3|3 - Total: 3'>        int argc = args.length;
</span>
<span class='bpc' id='L1176' title='0|1|1 - Total: 2'>        if (args.length > 0) {
</span>            /*  Slide up the array to make room for args at the bottom */
<span class='bpc' id='L1178' title='0|1|1 - Total: 2'>            if (length > 0) {
</span><span class='bc' id='L1179' title='0|2|2 - Total: 2'>                for (long last = length - 1; last >= 0; last--) {
</span><span class='bc' id='L1180' title='0|4|4 - Total: 4'>                    Object temp = getRawElem(thisObj, last);
</span><span class='bc' id='L1181' title='0|8|8 - Total: 8'>                    setRawElem(cx, thisObj, last + argc, temp);
</span>                }
            }

            /* Copy from argv to the bottom of the array. */
<span class='bc' id='L1186' title='0|2|2 - Total: 2'>            for (int i = 0; i < args.length; i++) {
</span><span class='bc' id='L1187' title='0|8|8 - Total: 8'>                setElem(cx, thisObj, i, args[i]);
</span>            }
        }
        /* Follow Perl by returning the new array length. */
<span class='bc' id='L1191' title='0|6|6 - Total: 6'>        length += args.length;
</span><span class='bc' id='L1192' title='0|5|5 - Total: 5'>        return setLengthProperty(cx, thisObj, length);
</span>    }

    private static Object js_splice(Context cx, Scriptable scope,
                                    Scriptable thisObj, Object[] args)
    {
<span class='bc' id='L1198' title='0|2|2 - Total: 2'>      NativeArray na = null;
</span><span class='bc' id='L1199' title='0|2|2 - Total: 2'>      boolean denseMode = false;
</span><span class='bc' id='L1200' title='0|2|2 - Total: 2'>        if (thisObj instanceof NativeArray) {
</span><span class='bc' id='L1201' title='0|3|3 - Total: 3'>            na = (NativeArray) thisObj;
</span><span class='bc' id='L1202' title='0|3|3 - Total: 3'>            denseMode = na.denseOnly;
</span>        }

        /* create an empty Array to return. */
<span class='bc' id='L1206' title='0|3|3 - Total: 3'>        scope = getTopLevelScope(scope);
</span><span class='bc' id='L1207' title='0|3|3 - Total: 3'>        int argc = args.length;
</span><span class='bc' id='L1208' title='0|2|2 - Total: 2'>        if (argc == 0)
</span><span class='bc' id='L1209' title='0|5|5 - Total: 5'>            return cx.newArray(scope, 0);
</span><span class='bc' id='L1210' title='0|4|4 - Total: 4'>        long length = getLengthProperty(cx, thisObj);
</span>
        /* Convert the first argument into a starting index. */
<span class='bc' id='L1213' title='0|7|7 - Total: 7'>        long begin = toSliceIndex(ScriptRuntime.toInteger(args[0]), length);
</span><span class='bc' id='L1214' title='0|1|1 - Total: 1'>        argc--;
</span>
        /* Convert the second argument into count */
        long count;
<span class='bpc' id='L1218' title='0|1|1 - Total: 2'>        if (args.length == 1) {
</span><span class='nc' id='L1219' title='0|0|0 - Total: 5'>            count = length - begin;
</span>        } else {
<span class='bc' id='L1221' title='0|5|5 - Total: 5'>            double dcount = ScriptRuntime.toInteger(args[1]);
</span><span class='bpc' id='L1222' title='0|1|1 - Total: 2'>            if (dcount < 0) {
</span><span class='nc' id='L1223' title='0|0|0 - Total: 3'>                count = 0;
</span><span class='bc' id='L1224' title='0|2|2 - Total: 2'>            } else if (dcount > (length - begin)) {
</span><span class='bc' id='L1225' title='0|5|5 - Total: 5'>                count = length - begin;
</span>            } else {
<span class='bc' id='L1227' title='0|3|3 - Total: 3'>                count = (long)dcount;
</span>            }
<span class='bc' id='L1229' title='0|1|1 - Total: 1'>            argc--;
</span>        }

<span class='bc' id='L1232' title='0|4|4 - Total: 4'>        long end = begin + count;
</span>
        /* If there are elements to remove, put them into the return value. */
        Object result;
<span class='bc' id='L1236' title='0|2|2 - Total: 2'>        if (count != 0) {
</span><span class='bc' id='L1237' title='0|2|2 - Total: 2'>            if (count == 1
</span><span class='bc' id='L1238' title='0|2|2 - Total: 2'>                && (cx.getLanguageVersion() == Context.VERSION_1_2))
</span>            {
                /*
                 * JS lacks "list context", whereby in Perl one turns the
                 * single scalar that's spliced out into an array just by
                 * assigning it to @single instead of $single, or by using it
                 * as Perl push's first argument, for instance.
                 *
                 * JS1.2 emulated Perl too closely and returned a non-Array for
                 * the single-splice-out case, requiring callers to test and
                 * wrap in [] if necessary.  So JS1.3, default, and other
                 * versions all return an array of length 1 for uniformity.
                 */
<span class='bc' id='L1251' title='0|6|6 - Total: 6'>                result = getElem(cx, thisObj, begin);
</span>            } else {
<span class='bc' id='L1253' title='0|2|2 - Total: 2'>                if (denseMode) {
</span><span class='bc' id='L1254' title='0|5|5 - Total: 5'>                    int intLen = (int) (end - begin);
</span><span class='bc' id='L1255' title='0|3|3 - Total: 3'>                    Object[] copy = new Object[intLen];
</span><span class='bc' id='L1256' title='0|8|8 - Total: 8'>                    System.arraycopy(na.dense, (int) begin, copy, 0, intLen);
</span><span class='bc' id='L1257' title='0|5|5 - Total: 5'>                    result = cx.newArray(scope, copy);
</span><span class='bc' id='L1258' title='0|1|1 - Total: 1'>                } else {
</span><span class='bc' id='L1259' title='0|5|5 - Total: 5'>                    Scriptable resultArray = cx.newArray(scope, 0);
</span><span class='bc' id='L1260' title='0|2|2 - Total: 2'>                    for (long last = begin; last != end; last++) {
</span><span class='bc' id='L1261' title='0|4|4 - Total: 4'>                        Object temp = getRawElem(thisObj, last);
</span><span class='bc' id='L1262' title='0|2|2 - Total: 2'>                        if (temp != NOT_FOUND) {
</span><span class='bc' id='L1263' title='0|7|7 - Total: 7'>                            setElem(cx, resultArray, last - begin, temp);
</span>                        }
                    }
                    // Need to set length for sparse result array
<span class='bc' id='L1267' title='0|7|7 - Total: 7'>                    setLengthProperty(cx, resultArray, end - begin);
</span><span class='bc' id='L1268' title='0|2|2 - Total: 2'>                    result = resultArray;
</span><span class='bc' id='L1269' title='0|1|1 - Total: 1'>                }
</span>            }
        } else { // (count == 0)
<span class='bpc' id='L1272' title='0|1|1 - Total: 2'>            if (cx.getLanguageVersion() == Context.VERSION_1_2) {
</span>                /* Emulate C JS1.2; if no elements are removed, return undefined. */
<span class='bc' id='L1274' title='0|3|3 - Total: 3'>                result = Undefined.instance;
</span>            } else {
<span class='nc' id='L1276' title='0|0|0 - Total: 5'>                result = cx.newArray(scope, 0);
</span>            }
        }

        /* Find the direction (up or down) to copy and make way for argv. */
<span class='bc' id='L1281' title='0|5|5 - Total: 5'>        long delta = argc - count;
</span><span class='bpc' id='L1282' title='0|3|3 - Total: 4'>        if (denseMode && length + delta < Integer.MAX_VALUE &&
</span><span class='bpc' id='L1283' title='0|1|1 - Total: 2'>            na.ensureCapacity((int) (length + delta)))
</span>        {
<span class='bc' id='L1285' title='0|16|16 - Total: 16'>            System.arraycopy(na.dense, (int) end, na.dense,
</span>                             (int) (begin + argc), (int) (length - end));
<span class='bc' id='L1287' title='0|2|2 - Total: 2'>            if (argc > 0) {
</span><span class='bc' id='L1288' title='0|8|8 - Total: 8'>                System.arraycopy(args, 2, na.dense, (int) begin, argc);
</span>            }
<span class='bc' id='L1290' title='0|2|2 - Total: 2'>            if (delta < 0) {
</span><span class='bc' id='L1291' title='0|10|10 - Total: 10'>                Arrays.fill(na.dense, (int) (length + delta), (int) length,
</span>                            NOT_FOUND);
            }
<span class='bc' id='L1294' title='0|5|5 - Total: 5'>            na.length = length + delta;
</span><span class='bc' id='L1295' title='0|2|2 - Total: 2'>            return result;
</span>        }

<span class='bpc' id='L1298' title='0|1|1 - Total: 2'>        if (delta > 0) {
</span><span class='nc' id='L1299' title='0|0|0 - Total: 2'>            for (long last = length - 1; last >= end; last--) {
</span><span class='nc' id='L1300' title='0|0|0 - Total: 4'>                Object temp = getRawElem(thisObj, last);
</span><span class='nc' id='L1301' title='0|0|0 - Total: 7'>                setRawElem(cx, thisObj, last + delta, temp);
</span>            }
<span class='bpc' id='L1303' title='0|1|1 - Total: 2'>        } else if (delta < 0) {
</span><span class='bc' id='L1304' title='0|2|2 - Total: 2'>            for (long last = end; last < length; last++) {
</span><span class='bc' id='L1305' title='0|4|4 - Total: 4'>                Object temp = getRawElem(thisObj, last);
</span><span class='bc' id='L1306' title='0|7|7 - Total: 7'>                setRawElem(cx, thisObj, last + delta, temp);
</span>            }
<span class='bc' id='L1308' title='0|2|2 - Total: 2'>            for (long k = length + delta; k < length; ++k) {
</span><span class='bc' id='L1309' title='0|3|3 - Total: 3'>                deleteElem(thisObj, k);
</span>            }
        }

        /* Copy from argv into the hole to complete the splice. */
<span class='bc' id='L1314' title='0|5|5 - Total: 5'>        int argoffset = args.length - argc;
</span><span class='bc' id='L1315' title='0|2|2 - Total: 2'>        for (int i = 0; i < argc; i++) {
</span><span class='bc' id='L1316' title='0|12|12 - Total: 12'>            setElem(cx, thisObj, begin + i, args[i + argoffset]);
</span>        }

        /* Update length in case we deleted elements from the end. */
<span class='bc' id='L1320' title='0|7|7 - Total: 7'>        setLengthProperty(cx, thisObj, length + delta);
</span><span class='bc' id='L1321' title='0|2|2 - Total: 2'>        return result;
</span>    }

    /*
     * See Ecma 262v3 15.4.4.4
     */
    private static Scriptable js_concat(Context cx, Scriptable scope,
                                        Scriptable thisObj, Object[] args)
    {
        // create an empty Array to return.
<span class='bc' id='L1331' title='0|3|3 - Total: 3'>        scope = getTopLevelScope(scope);
</span><span class='bc' id='L1332' title='0|5|5 - Total: 5'>        Scriptable result = cx.newArray(scope, 0);
</span><span class='bpc' id='L1333' title='0|3|3 - Total: 4'>        if (thisObj instanceof NativeArray && result instanceof NativeArray) {
</span><span class='bc' id='L1334' title='0|3|3 - Total: 3'>            NativeArray denseThis = (NativeArray) thisObj;
</span><span class='bc' id='L1335' title='0|3|3 - Total: 3'>            NativeArray denseResult = (NativeArray) result;
</span><span class='bpc' id='L1336' title='0|3|3 - Total: 4'>            if (denseThis.denseOnly && denseResult.denseOnly) {
</span>                // First calculate length of resulting array
<span class='bc' id='L1338' title='0|2|2 - Total: 2'>                boolean canUseDense = true;
</span><span class='bc' id='L1339' title='0|4|4 - Total: 4'>                int length = (int) denseThis.length;
</span><span class='bpc' id='L1340' title='0|3|3 - Total: 4'>                for (int i = 0; i < args.length && canUseDense; i++) {
</span><span class='bc' id='L1341' title='0|2|2 - Total: 2'>                    if (args[i] instanceof NativeArray) {
</span>                        // only try to use dense approach for Array-like
                        // objects that are actually NativeArrays
<span class='bc' id='L1344' title='0|5|5 - Total: 5'>                        final NativeArray arg = (NativeArray) args[i];
</span><span class='bc' id='L1345' title='0|3|3 - Total: 3'>                        canUseDense = arg.denseOnly;
</span><span class='bc' id='L1346' title='0|7|7 - Total: 7'>                        length += arg.length;
</span><span class='bc' id='L1347' title='0|1|1 - Total: 1'>                    } else {
</span><span class='bc' id='L1348' title='0|1|1 - Total: 1'>                        length++;
</span>                    }
                }
<span class='bpc' id='L1351' title='0|3|3 - Total: 4'>                if (canUseDense && denseResult.ensureCapacity(length)) {
</span><span class='bc' id='L1352' title='0|10|10 - Total: 10'>                    System.arraycopy(denseThis.dense, 0, denseResult.dense,
</span>                                     0, (int) denseThis.length);
<span class='bc' id='L1354' title='0|4|4 - Total: 4'>                    int cursor = (int) denseThis.length;
</span><span class='bpc' id='L1355' title='0|3|3 - Total: 4'>                    for (int i = 0; i < args.length && canUseDense; i++) {
</span><span class='bc' id='L1356' title='0|2|2 - Total: 2'>                        if (args[i] instanceof NativeArray) {
</span><span class='bc' id='L1357' title='0|5|5 - Total: 5'>                            NativeArray arg = (NativeArray) args[i];
</span><span class='bc' id='L1358' title='0|10|10 - Total: 10'>                            System.arraycopy(arg.dense, 0,
</span>                                    denseResult.dense, cursor,
                                    (int)arg.length);
<span class='bc' id='L1361' title='0|6|6 - Total: 6'>                            cursor += (int)arg.length;
</span><span class='bc' id='L1362' title='0|1|1 - Total: 1'>                        } else {
</span><span class='bc' id='L1363' title='0|8|8 - Total: 8'>                            denseResult.dense[cursor++] = args[i];
</span>                        }
                    }
<span class='bc' id='L1366' title='0|4|4 - Total: 4'>                    denseResult.length = length;
</span><span class='bc' id='L1367' title='0|2|2 - Total: 2'>                    return result;
</span>                }
            }
        }

        long length;
<span class='bc' id='L1373' title='0|2|2 - Total: 2'>        long slot = 0;
</span>
        /* Put the target in the result array; only add it as an array
         * if it looks like one.
         */
<span class='bc' id='L1378' title='0|2|2 - Total: 2'>        if (js_isArray(thisObj)) {
</span><span class='bc' id='L1379' title='0|4|4 - Total: 4'>            length = getLengthProperty(cx, thisObj);
</span>
            // Copy from the target object into the result
<span class='bc' id='L1382' title='0|2|2 - Total: 2'>            for (slot = 0; slot < length; slot++) {
</span><span class='bc' id='L1383' title='0|4|4 - Total: 4'>                Object temp = getRawElem(thisObj, slot);
</span><span class='bc' id='L1384' title='0|2|2 - Total: 2'>                if (temp != NOT_FOUND) {
</span><span class='bc' id='L1385' title='0|5|5 - Total: 5'>                    defineElem(cx, result, slot, temp);
</span>                }
            }
        } else {
<span class='bc' id='L1389' title='0|9|9 - Total: 9'>            defineElem(cx, result, slot++, thisObj);
</span>        }

        /* Copy from the arguments into the result.  If any argument
         * has a numeric length property, treat it as an array and add
         * elements separately; otherwise, just copy the argument.
         */
<span class='bc' id='L1396' title='0|2|2 - Total: 2'>        for (int i = 0; i < args.length; i++) {
</span><span class='bc' id='L1397' title='0|2|2 - Total: 2'>            if (js_isArray(args[i])) {
</span>                // js_isArray => instanceof Scriptable
<span class='bc' id='L1399' title='0|5|5 - Total: 5'>                Scriptable arg = (Scriptable)args[i];
</span><span class='bc' id='L1400' title='0|4|4 - Total: 4'>                length = getLengthProperty(cx, arg);
</span><span class='bc' id='L1401' title='0|2|2 - Total: 2'>                for (long j = 0; j < length; j++, slot++) {
</span><span class='bc' id='L1402' title='0|4|4 - Total: 4'>                    Object temp = getRawElem(arg, j);
</span><span class='bc' id='L1403' title='0|2|2 - Total: 2'>                    if (temp != NOT_FOUND) {
</span><span class='bc' id='L1404' title='0|5|5 - Total: 5'>                        defineElem(cx, result, slot, temp);
</span>                    }
                }
<span class='bc' id='L1407' title='0|1|1 - Total: 1'>            } else {
</span><span class='bc' id='L1408' title='0|11|11 - Total: 11'>                defineElem(cx, result, slot++, args[i]);
</span>            }
        }
<span class='bc' id='L1411' title='0|5|5 - Total: 5'>        setLengthProperty(cx, result, slot);
</span><span class='bc' id='L1412' title='0|2|2 - Total: 2'>        return result;
</span>    }

    private Scriptable js_slice(Context cx, Scriptable thisObj,
                                Object[] args)
    {
<span class='bc' id='L1418' title='0|3|3 - Total: 3'>        Scriptable scope = getTopLevelScope(this);
</span><span class='bc' id='L1419' title='0|5|5 - Total: 5'>        Scriptable result = cx.newArray(scope, 0);
</span><span class='bc' id='L1420' title='0|4|4 - Total: 4'>        long length = getLengthProperty(cx, thisObj);
</span>
        long begin, end;
<span class='bc' id='L1423' title='0|2|2 - Total: 2'>        if (args.length == 0) {
</span><span class='bc' id='L1424' title='0|2|2 - Total: 2'>            begin = 0;
</span><span class='bc' id='L1425' title='0|3|3 - Total: 3'>            end = length;
</span>        } else {
<span class='bc' id='L1427' title='0|7|7 - Total: 7'>            begin = toSliceIndex(ScriptRuntime.toInteger(args[0]), length);
</span><span class='bpc' id='L1428' title='0|3|3 - Total: 4'>            if (args.length == 1 || args[1] == Undefined.instance) {
</span><span class='bc' id='L1429' title='0|3|3 - Total: 3'>                end = length;
</span>            } else {
<span class='bc' id='L1431' title='0|7|7 - Total: 7'>                end = toSliceIndex(ScriptRuntime.toInteger(args[1]), length);
</span>            }
        }

<span class='bc' id='L1435' title='0|2|2 - Total: 2'>        for (long slot = begin; slot < end; slot++) {
</span><span class='bc' id='L1436' title='0|4|4 - Total: 4'>            Object temp = getRawElem(thisObj, slot);
</span><span class='bc' id='L1437' title='0|2|2 - Total: 2'>            if (temp != NOT_FOUND) {
</span><span class='bc' id='L1438' title='0|7|7 - Total: 7'>                defineElem(cx, result, slot - begin, temp);
</span>            }
        }
<span class='bc' id='L1441' title='0|9|9 - Total: 9'>        setLengthProperty(cx, result, Math.max(0, end - begin));
</span>
<span class='bc' id='L1443' title='0|2|2 - Total: 2'>        return result;
</span>    }

    private static long toSliceIndex(double value, long length) {
        long result;
<span class='bc' id='L1448' title='0|2|2 - Total: 2'>        if (value < 0.0) {
</span><span class='bc' id='L1449' title='0|2|2 - Total: 2'>            if (value + length < 0.0) {
</span><span class='bc' id='L1450' title='0|3|3 - Total: 3'>                result = 0;
</span>            } else {
<span class='bc' id='L1452' title='0|7|7 - Total: 7'>                result = (long)(value + length);
</span>            }
<span class='bc' id='L1454' title='0|2|2 - Total: 2'>        } else if (value > length) {
</span><span class='bc' id='L1455' title='0|3|3 - Total: 3'>            result = length;
</span>        } else {
<span class='bc' id='L1457' title='0|3|3 - Total: 3'>            result = (long)value;
</span>        }
<span class='bc' id='L1459' title='0|2|2 - Total: 2'>        return result;
</span>    }

    private static Object js_indexOf(Context cx, Scriptable thisObj,
                                     Object[] args)
    {
<span class='bpc' id='L1465' title='0|1|1 - Total: 2'>        Object compareTo = args.length > 0 ? args[0] : Undefined.instance;
</span><span class='bc' id='L1466' title='0|4|4 - Total: 4'>        long length = getLengthProperty(cx, thisObj);
</span>        /*
         * From http://developer.mozilla.org/en/docs/Core_JavaScript_1.5_Reference:Objects:Array:indexOf
         * The index at which to begin the search. Defaults to 0, i.e. the
         * whole array will be searched. If the index is greater than or
         * equal to the length of the array, -1 is returned, i.e. the array
         * will not be searched. If negative, it is taken as the offset from
         * the end of the array. Note that even when the index is negative,
         * the array is still searched from front to back. If the calculated
         * index is less than 0, the whole array will be searched.
         */
        long start;
<span class='bc' id='L1478' title='0|2|2 - Total: 2'>        if (args.length < 2) {
</span>            // default
<span class='bc' id='L1480' title='0|3|3 - Total: 3'>            start = 0;
</span>        } else {
<span class='bc' id='L1482' title='0|6|6 - Total: 6'>            start = (long)ScriptRuntime.toInteger(args[1]);
</span><span class='bc' id='L1483' title='0|2|2 - Total: 2'>            if (start < 0) {
</span><span class='bc' id='L1484' title='0|4|4 - Total: 4'>                start += length;
</span><span class='bc' id='L1485' title='0|2|2 - Total: 2'>                if (start < 0)
</span><span class='bc' id='L1486' title='0|2|2 - Total: 2'>                    start = 0;
</span>            }
<span class='bc' id='L1488' title='0|2|2 - Total: 2'>            if (start > length - 1) return NEGATIVE_ONE;
</span>        }
<span class='bc' id='L1490' title='0|2|2 - Total: 2'>        if (thisObj instanceof NativeArray) {
</span><span class='bc' id='L1491' title='0|3|3 - Total: 3'>            NativeArray na = (NativeArray) thisObj;
</span><span class='bpc' id='L1492' title='0|1|1 - Total: 2'>            if (na.denseOnly) {
</span><span class='bc' id='L1493' title='0|3|3 - Total: 3'>                Scriptable proto = na.getPrototype();
</span><span class='bc' id='L1494' title='0|2|2 - Total: 2'>                for (int i=(int)start; i < length; i++) {
</span><span class='bc' id='L1495' title='0|5|5 - Total: 5'>                    Object val = na.dense[i];
</span><span class='bpc' id='L1496' title='0|3|3 - Total: 4'>                    if (val == NOT_FOUND && proto != null) {
</span><span class='bc' id='L1497' title='0|4|4 - Total: 4'>                        val = ScriptableObject.getProperty(proto, i);
</span>                    }
<span class='bc' id='L1499' title='0|2|2 - Total: 2'>                    if (val != NOT_FOUND &&
</span><span class='bc' id='L1500' title='0|2|2 - Total: 2'>                        ScriptRuntime.shallowEq(val, compareTo))
</span>                    {
<span class='bc' id='L1502' title='0|4|4 - Total: 4'>                        return Long.valueOf(i);
</span>                    }
                }
<span class='bc' id='L1505' title='0|2|2 - Total: 2'>                return NEGATIVE_ONE;
</span>            }
        }
<span class='bpc' id='L1508' title='0|1|1 - Total: 2'>        for (long i=start; i < length; i++) {
</span><span class='bc' id='L1509' title='0|4|4 - Total: 4'>            Object val = getRawElem(thisObj, i);
</span><span class='bpc' id='L1510' title='0|3|3 - Total: 4'>            if (val != NOT_FOUND && ScriptRuntime.shallowEq(val, compareTo)) {
</span><span class='bc' id='L1511' title='0|3|3 - Total: 3'>                return Long.valueOf(i);
</span>            }
        }
<span class='nc' id='L1514' title='0|0|0 - Total: 2'>        return NEGATIVE_ONE;
</span>    }

    private static Object js_lastIndexOf(Context cx, Scriptable thisObj,
            Object[] args)
    {
<span class='bc' id='L1520' title='0|2|2 - Total: 2'>        Object compareTo = args.length > 0 ? args[0] : Undefined.instance;
</span><span class='bc' id='L1521' title='0|4|4 - Total: 4'>        long length = getLengthProperty(cx, thisObj);
</span>        /*
         * From http://developer.mozilla.org/en/docs/Core_JavaScript_1.5_Reference:Objects:Array:lastIndexOf
         * The index at which to start searching backwards. Defaults to the
         * array's length, i.e. the whole array will be searched. If the
         * index is greater than or equal to the length of the array, the
         * whole array will be searched. If negative, it is taken as the
         * offset from the end of the array. Note that even when the index
         * is negative, the array is still searched from back to front. If
         * the calculated index is less than 0, -1 is returned, i.e. the
         * array will not be searched.
         */
        long start;
<span class='bc' id='L1534' title='0|2|2 - Total: 2'>        if (args.length < 2) {
</span>            // default
<span class='bc' id='L1536' title='0|5|5 - Total: 5'>            start = length-1;
</span>        } else {
<span class='bc' id='L1538' title='0|6|6 - Total: 6'>            start = (long)ScriptRuntime.toInteger(args[1]);
</span><span class='bc' id='L1539' title='0|2|2 - Total: 2'>            if (start >= length)
</span><span class='bc' id='L1540' title='0|5|5 - Total: 5'>                start = length-1;
</span><span class='bc' id='L1541' title='0|2|2 - Total: 2'>            else if (start < 0)
</span><span class='bc' id='L1542' title='0|4|4 - Total: 4'>                start += length;
</span><span class='bc' id='L1543' title='0|2|2 - Total: 2'>            if (start < 0) return NEGATIVE_ONE;
</span>        }
<span class='bc' id='L1545' title='0|2|2 - Total: 2'>        if (thisObj instanceof NativeArray) {
</span><span class='bc' id='L1546' title='0|3|3 - Total: 3'>            NativeArray na = (NativeArray) thisObj;
</span><span class='bc' id='L1547' title='0|2|2 - Total: 2'>            if (na.denseOnly) {
</span><span class='bc' id='L1548' title='0|3|3 - Total: 3'>                Scriptable proto = na.getPrototype();
</span><span class='bc' id='L1549' title='0|2|2 - Total: 2'>                for (int i=(int)start; i >= 0; i--) {
</span><span class='bc' id='L1550' title='0|5|5 - Total: 5'>                    Object val = na.dense[i];
</span><span class='bpc' id='L1551' title='0|3|3 - Total: 4'>                    if (val == NOT_FOUND && proto != null) {
</span><span class='bc' id='L1552' title='0|4|4 - Total: 4'>                        val = ScriptableObject.getProperty(proto, i);
</span>                    }
<span class='bc' id='L1554' title='0|2|2 - Total: 2'>                    if (val != NOT_FOUND &&
</span><span class='bc' id='L1555' title='0|2|2 - Total: 2'>                        ScriptRuntime.shallowEq(val, compareTo))
</span>                    {
<span class='bc' id='L1557' title='0|4|4 - Total: 4'>                        return Long.valueOf(i);
</span>                    }
                }
<span class='bc' id='L1560' title='0|2|2 - Total: 2'>                return NEGATIVE_ONE;
</span>            }
        }
<span class='bpc' id='L1563' title='0|1|1 - Total: 2'>        for (long i=start; i >= 0; i--) {
</span><span class='bc' id='L1564' title='0|4|4 - Total: 4'>            Object val = getRawElem(thisObj, i);
</span><span class='bpc' id='L1565' title='0|3|3 - Total: 4'>            if (val != NOT_FOUND && ScriptRuntime.shallowEq(val, compareTo)) {
</span><span class='bc' id='L1566' title='0|3|3 - Total: 3'>                return Long.valueOf(i);
</span>            }
        }
<span class='nc' id='L1569' title='0|0|0 - Total: 2'>        return NEGATIVE_ONE;
</span>    }

    /**
     * Implements the methods "every", "filter", "forEach", "map", and "some".
     */
    private static Object iterativeMethod(Context cx, IdFunctionObject idFunctionObject, Scriptable scope,
                                          Scriptable thisObj, Object[] args)
    {
        // execIdCall(..) uses a trick for all the ConstructorId_xxx calls
        // they are handled like object calls by adjusting the args list
        // as a result we have to handle ConstructorId_xxx calls (negative id)
        // the same way and always us the abs value of the id for method selection
<span class='bc' id='L1582' title='0|4|4 - Total: 4'>        int id = Math.abs(idFunctionObject.methodId());
</span><span class='bc' id='L1583' title='0|4|4 - Total: 4'>        if (Id_find == id || Id_findIndex == id) thisObj = requireObjectCoercible(cx, thisObj, idFunctionObject);
</span>
<span class='bc' id='L1585' title='0|4|4 - Total: 4'>        long length = getLengthProperty(cx, thisObj);
</span><span class='bc' id='L1586' title='0|2|2 - Total: 2'>        Object callbackArg = args.length > 0 ? args[0] : Undefined.instance;
</span><span class='bc' id='L1587' title='0|4|4 - Total: 4'>        if (callbackArg == null || !(callbackArg instanceof Function)) {
</span><span class='bc' id='L1588' title='0|3|3 - Total: 3'>            throw ScriptRuntime.notFunctionError(callbackArg);
</span>        }
<span class='bc' id='L1590' title='0|4|4 - Total: 4'>        if (cx.getLanguageVersion() >= Context.VERSION_ES6 && (callbackArg instanceof NativeRegExp)) {
</span>            // Previously, it was allowed to pass RegExp instance as a callback (it implements Function)
            // But according to ES2015 21.2.6 Properties of RegExp Instances:
            // > RegExp instances are ordinary objects that inherit properties from the RegExp prototype object.
            // > RegExp instances have internal slots [[RegExpMatcher]], [[OriginalSource]], and [[OriginalFlags]].
            // so, no [[Call]] for RegExp-s
<span class='bc' id='L1596' title='0|3|3 - Total: 3'>            throw ScriptRuntime.notFunctionError(callbackArg);
</span>        }

<span class='bc' id='L1599' title='0|3|3 - Total: 3'>        Function f = (Function) callbackArg;
</span><span class='bc' id='L1600' title='0|3|3 - Total: 3'>        Scriptable parent = ScriptableObject.getTopLevelScope(f);
</span>        Scriptable thisArg;
<span class='bpc' id='L1602' title='0|4|4 - Total: 6'>        if (args.length < 2 || args[1] == null || args[1] == Undefined.instance) {
</span><span class='bc' id='L1603' title='0|3|3 - Total: 3'>            thisArg = parent;
</span>        } else {
<span class='bc' id='L1605' title='0|7|7 - Total: 7'>            thisArg = ScriptRuntime.toObject(cx, scope, args[1]);
</span>        }

<span class='bc' id='L1608' title='0|2|2 - Total: 2'>        Scriptable array = null;
</span><span class='bc' id='L1609' title='0|4|4 - Total: 4'>        if (id == Id_filter || id == Id_map) {
</span><span class='bc' id='L1610' title='0|2|2 - Total: 2'>            int resultLength = id == Id_map ? (int) length : 0;
</span><span class='bc' id='L1611' title='0|5|5 - Total: 5'>            array = cx.newArray(scope, resultLength);
</span>        }
<span class='bc' id='L1613' title='0|2|2 - Total: 2'>        long j=0;
</span><span class='bc' id='L1614' title='0|2|2 - Total: 2'>        for (long i=0; i < length; i++) {
</span><span class='bc' id='L1615' title='0|3|3 - Total: 3'>            Object[] innerArgs = new Object[3];
</span><span class='bc' id='L1616' title='0|4|4 - Total: 4'>            Object elem = getRawElem(thisObj, i);
</span><span class='bc' id='L1617' title='0|2|2 - Total: 2'>            if (elem == Scriptable.NOT_FOUND) {
</span><span class='bc' id='L1618' title='0|4|4 - Total: 4'>                if (id == Id_find || id == Id_findIndex) {
</span><span class='bc' id='L1619' title='0|2|2 - Total: 2'>                    elem = Undefined.instance;
</span>                } else {
                    continue;
                }
            }
<span class='bc' id='L1624' title='0|4|4 - Total: 4'>            innerArgs[0] = elem;
</span><span class='bc' id='L1625' title='0|5|5 - Total: 5'>            innerArgs[1] = Long.valueOf(i);
</span><span class='bc' id='L1626' title='0|4|4 - Total: 4'>            innerArgs[2] = thisObj;
</span><span class='bc' id='L1627' title='0|7|7 - Total: 7'>            Object result = f.call(cx, parent, thisArg, innerArgs);
</span><span class='bpc' id='L1628' title='0|7|7 - Total: 8'>            switch (id) {
</span>              case Id_every:
<span class='bc' id='L1630' title='0|2|2 - Total: 2'>                if (!ScriptRuntime.toBoolean(result))
</span><span class='bc' id='L1631' title='0|2|2 - Total: 2'>                    return Boolean.FALSE;
</span>                break;
              case Id_filter:
<span class='bc' id='L1634' title='0|2|2 - Total: 2'>                if (ScriptRuntime.toBoolean(result))
</span><span class='bc' id='L1635' title='0|12|12 - Total: 12'>                    defineElem(cx, array, j++, innerArgs[0]);
</span>                break;
              case Id_forEach:
<span class='bc' id='L1638' title='0|1|1 - Total: 1'>                break;
</span>              case Id_map:
<span class='bc' id='L1640' title='0|5|5 - Total: 5'>                defineElem(cx, array, i, result);
</span><span class='bc' id='L1641' title='0|1|1 - Total: 1'>                break;
</span>              case Id_some:
<span class='bc' id='L1643' title='0|2|2 - Total: 2'>                if (ScriptRuntime.toBoolean(result))
</span><span class='bc' id='L1644' title='0|2|2 - Total: 2'>                    return Boolean.TRUE;
</span>                break;
              case Id_find:
<span class='bc' id='L1647' title='0|2|2 - Total: 2'>                if (ScriptRuntime.toBoolean(result))
</span><span class='bc' id='L1648' title='0|2|2 - Total: 2'>                    return elem;
</span>                break;
              case Id_findIndex:
<span class='bc' id='L1651' title='0|2|2 - Total: 2'>                if (ScriptRuntime.toBoolean(result))
</span><span class='bc' id='L1652' title='0|4|4 - Total: 4'>                    return ScriptRuntime.wrapNumber(i);
</span>                break;
            }
        }
<span class='bc' id='L1656' title='0|5|5 - Total: 5'>        switch (id) {
</span>          case Id_every:
<span class='bc' id='L1658' title='0|2|2 - Total: 2'>            return Boolean.TRUE;
</span>          case Id_filter:
          case Id_map:
<span class='bc' id='L1661' title='0|2|2 - Total: 2'>            return array;
</span>          case Id_some:
<span class='bc' id='L1663' title='0|2|2 - Total: 2'>            return Boolean.FALSE;
</span>          case Id_findIndex:
<span class='bc' id='L1665' title='0|3|3 - Total: 3'>            return ScriptRuntime.wrapNumber(-1);
</span>          case Id_forEach:
          default:
<span class='bc' id='L1668' title='0|2|2 - Total: 2'>            return Undefined.instance;
</span>        }
    }

    /**
     * Implements the methods "reduce" and "reduceRight".
     */
    private static Object reduceMethod(Context cx, int id, Scriptable scope,
                                       Scriptable thisObj, Object[] args)
    {
<span class='bc' id='L1678' title='0|4|4 - Total: 4'>        long length = getLengthProperty(cx, thisObj);
</span><span class='bpc' id='L1679' title='0|1|1 - Total: 2'>        Object callbackArg = args.length > 0 ? args[0] : Undefined.instance;
</span><span class='bpc' id='L1680' title='0|2|2 - Total: 4'>        if (callbackArg == null || !(callbackArg instanceof Function)) {
</span><span class='nc' id='L1681' title='0|0|0 - Total: 3'>            throw ScriptRuntime.notFunctionError(callbackArg);
</span>        }
<span class='bc' id='L1683' title='0|3|3 - Total: 3'>        Function f = (Function) callbackArg;
</span><span class='bc' id='L1684' title='0|3|3 - Total: 3'>        Scriptable parent = ScriptableObject.getTopLevelScope(f);
</span>        // hack to serve both reduce and reduceRight with the same loop
<span class='bc' id='L1686' title='0|2|2 - Total: 2'>        boolean movingLeft = id == Id_reduce;
</span><span class='bc' id='L1687' title='0|2|2 - Total: 2'>        Object value = args.length > 1 ? args[1] : Scriptable.NOT_FOUND;
</span><span class='bc' id='L1688' title='0|2|2 - Total: 2'>        for (long i = 0; i < length; i++) {
</span><span class='bc' id='L1689' title='0|2|2 - Total: 2'>            long index = movingLeft ? i : (length - 1 - i);
</span><span class='bc' id='L1690' title='0|4|4 - Total: 4'>            Object elem = getRawElem(thisObj, index);
</span><span class='bc' id='L1691' title='0|2|2 - Total: 2'>            if (elem == Scriptable.NOT_FOUND) {
</span><span class='bc' id='L1692' title='0|1|1 - Total: 1'>                continue;
</span>            }
<span class='bc' id='L1694' title='0|2|2 - Total: 2'>            if (value == Scriptable.NOT_FOUND) {
</span>                // no initial value passed, use first element found as inital value
<span class='bc' id='L1696' title='0|3|3 - Total: 3'>                value = elem;
</span>            } else {
<span class='bc' id='L1698' title='0|20|20 - Total: 20'>                Object[] innerArgs = { value, elem, index, thisObj };
</span><span class='bc' id='L1699' title='0|7|7 - Total: 7'>                value = f.call(cx, parent, parent, innerArgs);
</span>            }
        }
<span class='bc' id='L1702' title='0|2|2 - Total: 2'>        if (value == Scriptable.NOT_FOUND) {
</span>            // reproduce spidermonkey error message
<span class='bc' id='L1704' title='0|3|3 - Total: 3'>            throw ScriptRuntime.typeError0("msg.empty.array.reduce");
</span>        }
<span class='bc' id='L1706' title='0|2|2 - Total: 2'>        return value;
</span>    }

    private static boolean js_isArray(Object o) {
<span class='bc' id='L1710' title='0|2|2 - Total: 2'>        if (!(o instanceof Scriptable)) {
</span><span class='bc' id='L1711' title='0|2|2 - Total: 2'>            return false;
</span>        }
<span class='bc' id='L1713' title='0|6|6 - Total: 6'>        return "Array".equals(((Scriptable)o).getClassName());
</span>    }

    // methods to implement java.util.List

    public boolean contains(Object o) {
<span class='bc' id='L1719' title='0|2|2 - Total: 2'>        return indexOf(o) > -1;
</span>    }

    public Object[] toArray() {
<span class='bc' id='L1723' title='0|4|4 - Total: 4'>        return toArray(ScriptRuntime.emptyArgs);
</span>    }

    public Object[] toArray(Object[] a) {
<span class='bc' id='L1727' title='0|3|3 - Total: 3'>        long longLen = length;
</span><span class='bpc' id='L1728' title='0|1|1 - Total: 2'>        if (longLen > Integer.MAX_VALUE) {
</span><span class='nc' id='L1729' title='0|0|0 - Total: 4'>            throw new IllegalStateException();
</span>        }
<span class='bc' id='L1731' title='0|3|3 - Total: 3'>        int len = (int) longLen;
</span><span class='bc' id='L1732' title='0|2|2 - Total: 2'>        Object[] array = a.length >= len ?
</span>                a : (Object[]) java.lang.reflect.Array
<span class='bc' id='L1734' title='0|7|7 - Total: 7'>                .newInstance(a.getClass().getComponentType(), len);
</span><span class='bc' id='L1735' title='0|2|2 - Total: 2'>        for (int i = 0; i < len; i++) {
</span><span class='bc' id='L1736' title='0|6|6 - Total: 6'>            array[i] = get(i);
</span>        }
<span class='bc' id='L1738' title='0|2|2 - Total: 2'>        return array;
</span>    }

    public boolean containsAll(Collection c) {
<span class='nc' id='L1742' title='0|0|0 - Total: 2'>        for (Object aC : c)
</span><span class='nc' id='L1743' title='0|0|0 - Total: 2'>            if (!contains(aC))
</span><span class='nc' id='L1744' title='0|0|0 - Total: 2'>                return false;
</span><span class='nc' id='L1745' title='0|0|0 - Total: 2'>        return true;
</span>    }

    @Override
    public int size() {
<span class='bc' id='L1750' title='0|3|3 - Total: 3'>        long longLen = length;
</span><span class='bpc' id='L1751' title='0|1|1 - Total: 2'>        if (longLen > Integer.MAX_VALUE) {
</span><span class='nc' id='L1752' title='0|0|0 - Total: 4'>            throw new IllegalStateException();
</span>        }
<span class='bc' id='L1754' title='0|3|3 - Total: 3'>        return (int) longLen;
</span>    }

    @Override
    public boolean isEmpty() {
<span class='nc' id='L1759' title='0|0|0 - Total: 2'>        return length == 0;
</span>    }

    public Object get(long index) {
<span class='bpc' id='L1763' title='0|2|2 - Total: 4'>        if (index < 0 || index >= length) {
</span><span class='nc' id='L1764' title='0|0|0 - Total: 4'>            throw new IndexOutOfBoundsException();
</span>        }
<span class='bc' id='L1766' title='0|4|4 - Total: 4'>        Object value = getRawElem(this, index);
</span><span class='bc' id='L1767' title='0|4|4 - Total: 4'>        if (value == Scriptable.NOT_FOUND || value == Undefined.instance) {
</span><span class='bc' id='L1768' title='0|2|2 - Total: 2'>            return null;
</span><span class='bc' id='L1769' title='0|2|2 - Total: 2'>        } else if (value instanceof Wrapper) {
</span><span class='bc' id='L1770' title='0|4|4 - Total: 4'>            return ((Wrapper) value).unwrap();
</span>        } else {
<span class='bc' id='L1772' title='0|2|2 - Total: 2'>            return value;
</span>        }
    }

    public Object get(int index) {
<span class='bc' id='L1777' title='0|5|5 - Total: 5'>        return get((long) index);
</span>    }

    public int indexOf(Object o) {
<span class='bc' id='L1781' title='0|3|3 - Total: 3'>        long longLen = length;
</span><span class='bpc' id='L1782' title='0|1|1 - Total: 2'>        if (longLen > Integer.MAX_VALUE) {
</span><span class='nc' id='L1783' title='0|0|0 - Total: 4'>            throw new IllegalStateException();
</span>        }
<span class='bc' id='L1785' title='0|3|3 - Total: 3'>        int len = (int) longLen;
</span><span class='bc' id='L1786' title='0|2|2 - Total: 2'>        if (o == null) {
</span><span class='bc' id='L1787' title='0|2|2 - Total: 2'>            for (int i = 0; i < len; i++) {
</span><span class='bpc' id='L1788' title='0|1|1 - Total: 2'>                if (get(i) == null) {
</span><span class='nc' id='L1789' title='0|0|0 - Total: 2'>                    return i;
</span>                }
            }
        } else {
<span class='bc' id='L1793' title='0|2|2 - Total: 2'>            for (int i = 0; i < len; i++) {
</span><span class='bc' id='L1794' title='0|2|2 - Total: 2'>                if (o.equals(get(i))) {
</span><span class='bc' id='L1795' title='0|2|2 - Total: 2'>                    return i;
</span>                }
            }
        }
<span class='bc' id='L1799' title='0|2|2 - Total: 2'>        return -1;
</span>    }

    public int lastIndexOf(Object o) {
<span class='bc' id='L1803' title='0|3|3 - Total: 3'>        long longLen = length;
</span><span class='bpc' id='L1804' title='0|1|1 - Total: 2'>        if (longLen > Integer.MAX_VALUE) {
</span><span class='nc' id='L1805' title='0|0|0 - Total: 4'>            throw new IllegalStateException();
</span>        }
<span class='bc' id='L1807' title='0|3|3 - Total: 3'>        int len = (int) longLen;
</span><span class='bc' id='L1808' title='0|2|2 - Total: 2'>        if (o == null) {
</span><span class='bc' id='L1809' title='0|2|2 - Total: 2'>            for (int i = len - 1; i >= 0; i--) {
</span><span class='bpc' id='L1810' title='0|1|1 - Total: 2'>                if (get(i) == null) {
</span><span class='nc' id='L1811' title='0|0|0 - Total: 2'>                    return i;
</span>                }
            }
        } else {
<span class='bc' id='L1815' title='0|2|2 - Total: 2'>            for (int i = len - 1; i >= 0; i--) {
</span><span class='bc' id='L1816' title='0|2|2 - Total: 2'>                if (o.equals(get(i))) {
</span><span class='bc' id='L1817' title='0|2|2 - Total: 2'>                    return i;
</span>                }
            }
        }
<span class='bc' id='L1821' title='0|2|2 - Total: 2'>        return -1;
</span>    }

    public Iterator iterator() {
<span class='bc' id='L1825' title='0|4|4 - Total: 4'>        return listIterator(0);
</span>    }

    public ListIterator listIterator() {
<span class='bc' id='L1829' title='0|4|4 - Total: 4'>        return listIterator(0);
</span>    }

    public ListIterator listIterator(final int start) {
<span class='bc' id='L1833' title='0|3|3 - Total: 3'>        long longLen = length;
</span><span class='bpc' id='L1834' title='0|1|1 - Total: 2'>        if (longLen > Integer.MAX_VALUE) {
</span><span class='nc' id='L1835' title='0|0|0 - Total: 4'>            throw new IllegalStateException();
</span>        }
<span class='bc' id='L1837' title='0|3|3 - Total: 3'>        final int len = (int) longLen;
</span>
<span class='bpc' id='L1839' title='0|2|2 - Total: 4'>        if (start < 0 || start > len) {
</span><span class='nc' id='L1840' title='0|0|0 - Total: 12'>            throw new IndexOutOfBoundsException("Index: " + start);
</span>        }

<span class='bc' id='L1843' title='0|7|7 - Total: 7'>        return new ListIterator() {
</span>
            int cursor = start;

            public boolean hasNext() {
                return cursor < len;
            }

            public Object next() {
                if (cursor == len) {
                    throw new NoSuchElementException();
                }
                return get(cursor++);
            }

            public boolean hasPrevious() {
                return cursor > 0;
            }

            public Object previous() {
                if (cursor == 0) {
                    throw new NoSuchElementException();
                }
                return get(--cursor);
            }

            public int nextIndex() {
                return cursor;
            }

            public int previousIndex() {
                return cursor - 1;
            }

            public void remove() {
                throw new UnsupportedOperationException();
            }

            public void add(Object o) {
                throw new UnsupportedOperationException();
            }

            public void set(Object o) {
                throw new UnsupportedOperationException();
            }
        };
    }

    public boolean add(Object o) {
<span class='nc' id='L1892' title='0|0|0 - Total: 4'>        throw new UnsupportedOperationException();
</span>    }

    public boolean remove(Object o) {
<span class='nc' id='L1896' title='0|0|0 - Total: 4'>        throw new UnsupportedOperationException();
</span>    }

    public boolean addAll(Collection c) {
<span class='nc' id='L1900' title='0|0|0 - Total: 4'>        throw new UnsupportedOperationException();
</span>    }

    public boolean removeAll(Collection c) {
<span class='nc' id='L1904' title='0|0|0 - Total: 4'>        throw new UnsupportedOperationException();
</span>    }

    public boolean retainAll(Collection c) {
<span class='nc' id='L1908' title='0|0|0 - Total: 4'>        throw new UnsupportedOperationException();
</span>    }

    public void clear() {
<span class='nc' id='L1912' title='0|0|0 - Total: 4'>        throw new UnsupportedOperationException();
</span>    }

    public void add(int index, Object element) {
<span class='nc' id='L1916' title='0|0|0 - Total: 4'>        throw new UnsupportedOperationException();
</span>    }

    public boolean addAll(int index, Collection c) {
<span class='nc' id='L1920' title='0|0|0 - Total: 4'>        throw new UnsupportedOperationException();
</span>    }

    public Object set(int index, Object element) {
<span class='nc' id='L1924' title='0|0|0 - Total: 4'>        throw new UnsupportedOperationException();
</span>    }

    public Object remove(int index) {
<span class='nc' id='L1928' title='0|0|0 - Total: 4'>        throw new UnsupportedOperationException();
</span>    }

    public List subList(int fromIndex, int toIndex) {
<span class='nc' id='L1932' title='0|0|0 - Total: 4'>        throw new UnsupportedOperationException();
</span>    }

    @Override
    protected int findPrototypeId(Symbol k)
    {
<span class='bc' id='L1938' title='0|2|2 - Total: 2'>        if (SymbolKey.ITERATOR.equals(k)) {
</span><span class='bc' id='L1939' title='0|2|2 - Total: 2'>            return SymbolId_iterator;
</span>        }
<span class='bc' id='L1941' title='0|2|2 - Total: 2'>        return 0;
</span>    }

    // Comparators for the js_sort method. Putting them here lets us unit-test them better.

<span class='bc' id='L1946' title='0|4|4 - Total: 4'>    private static final Comparator<Object> STRING_COMPARATOR = new StringLikeComparator();
</span><span class='bc' id='L1947' title='0|4|4 - Total: 4'>    private static final Comparator<Object> DEFAULT_COMPARATOR = new ElementComparator();
</span>
    public static final class StringLikeComparator
      implements Comparator<Object> {

      public int compare(final Object x, final Object y) {
        final String a = ScriptRuntime.toString(x);
        final String b = ScriptRuntime.toString(y);
        return a.compareTo(b);
      }
    }

    public static final class ElementComparator
      implements Comparator<Object> {

      private final Comparator<Object> child;

      public ElementComparator() {
        child = STRING_COMPARATOR;
      }

      public ElementComparator(Comparator<Object> c) {
        child = c;
      }

      public int compare(final Object x, final Object y) {
        // Sort NOT_FOUND to very end, Undefined before that, exclusively, as per
        // ECMA 22.1.3.25.1.
        if (x == Undefined.instance) {
          if (y == Undefined.instance) {
            return 0;
          }
          if (y == NOT_FOUND) {
            return -1;
          }
          return 1;
        } else if (x == NOT_FOUND) {
          return y == NOT_FOUND ? 0 : 1;
        }

        if (y == NOT_FOUND) {
          return -1;
        }
        if (y == Undefined.instance) {
          return -1;
        }

        return child.compare(x, y);
      }
    }

// #string_id_map#

    @Override
    protected int findPrototypeId(String s)
    {
        int id;
// #generated# Last update: 2016-03-04 20:46:26 GMT
<span class='bc' id='L2005' title='0|4|4 - Total: 4'>        L0: { id = 0; String X = null; int c;
</span><span class='bc' id='L2006' title='0|10|10 - Total: 10'>            L: switch (s.length()) {
</span><span class='bc' id='L2007' title='0|4|4 - Total: 4'>            case 3: c=s.charAt(0);
</span><span class='bpc' id='L2008' title='0|4|4 - Total: 6'>                if (c=='m') { if (s.charAt(2)=='p' && s.charAt(1)=='a') {id=Id_map; break L0;} }
</span><span class='bpc' id='L2009' title='0|4|4 - Total: 6'>                else if (c=='p') { if (s.charAt(2)=='p' && s.charAt(1)=='o') {id=Id_pop; break L0;} }
</span>                break L;
<span class='bc' id='L2011' title='0|6|6 - Total: 6'>            case 4: switch (s.charAt(2)) {
</span><span class='bc' id='L2012' title='0|5|5 - Total: 5'>                case 'i': X="join";id=Id_join; break L;
</span><span class='bc' id='L2013' title='0|5|5 - Total: 5'>                case 'm': X="some";id=Id_some; break L;
</span><span class='bc' id='L2014' title='0|5|5 - Total: 5'>                case 'n': X="find";id=Id_find; break L;
</span><span class='bc' id='L2015' title='0|5|5 - Total: 5'>                case 'r': X="sort";id=Id_sort; break L;
</span><span class='bc' id='L2016' title='0|5|5 - Total: 5'>                case 's': X="push";id=Id_push; break L;
</span><span class='bc' id='L2017' title='0|1|1 - Total: 1'>                } break L;
</span><span class='bc' id='L2018' title='0|4|4 - Total: 4'>            case 5: c=s.charAt(1);
</span><span class='bc' id='L2019' title='0|2|2 - Total: 2'>                if (c=='h') { X="shift";id=Id_shift; }
</span><span class='bc' id='L2020' title='0|2|2 - Total: 2'>                else if (c=='l') { X="slice";id=Id_slice; }
</span><span class='bc' id='L2021' title='0|2|2 - Total: 2'>                else if (c=='v') { X="every";id=Id_every; }
</span>                break L;
<span class='bc' id='L2023' title='0|5|5 - Total: 5'>            case 6: switch (s.charAt(0)) {
</span><span class='bc' id='L2024' title='0|5|5 - Total: 5'>                case 'c': X="concat";id=Id_concat; break L;
</span><span class='bc' id='L2025' title='0|5|5 - Total: 5'>                case 'f': X="filter";id=Id_filter; break L;
</span><span class='bc' id='L2026' title='0|5|5 - Total: 5'>                case 'r': X="reduce";id=Id_reduce; break L;
</span><span class='bc' id='L2027' title='0|5|5 - Total: 5'>                case 's': X="splice";id=Id_splice; break L;
</span><span class='bc' id='L2028' title='0|1|1 - Total: 1'>                } break L;
</span><span class='bc' id='L2029' title='0|5|5 - Total: 5'>            case 7: switch (s.charAt(0)) {
</span><span class='bc' id='L2030' title='0|5|5 - Total: 5'>                case 'f': X="forEach";id=Id_forEach; break L;
</span><span class='bc' id='L2031' title='0|5|5 - Total: 5'>                case 'i': X="indexOf";id=Id_indexOf; break L;
</span><span class='bc' id='L2032' title='0|5|5 - Total: 5'>                case 'r': X="reverse";id=Id_reverse; break L;
</span><span class='bc' id='L2033' title='0|5|5 - Total: 5'>                case 'u': X="unshift";id=Id_unshift; break L;
</span><span class='bc' id='L2034' title='0|1|1 - Total: 1'>                } break L;
</span><span class='bc' id='L2035' title='0|4|4 - Total: 4'>            case 8: c=s.charAt(3);
</span><span class='bc' id='L2036' title='0|2|2 - Total: 2'>                if (c=='o') { X="toSource";id=Id_toSource; }
</span><span class='bc' id='L2037' title='0|2|2 - Total: 2'>                else if (c=='t') { X="toString";id=Id_toString; }
</span>                break L;
<span class='bc' id='L2039' title='0|5|5 - Total: 5'>            case 9: X="findIndex";id=Id_findIndex; break L;
</span><span class='bc' id='L2040' title='0|4|4 - Total: 4'>            case 11: c=s.charAt(0);
</span><span class='bc' id='L2041' title='0|2|2 - Total: 2'>                if (c=='c') { X="constructor";id=Id_constructor; }
</span><span class='bc' id='L2042' title='0|2|2 - Total: 2'>                else if (c=='l') { X="lastIndexOf";id=Id_lastIndexOf; }
</span><span class='bc' id='L2043' title='0|2|2 - Total: 2'>                else if (c=='r') { X="reduceRight";id=Id_reduceRight; }
</span>                break L;
<span class='bc' id='L2045' title='0|5|5 - Total: 5'>            case 14: X="toLocaleString";id=Id_toLocaleString; break L;
</span>            }
<span class='bc' id='L2047' title='0|6|6 - Total: 6'>            if (X!=null && X!=s && !X.equals(s)) id = 0;
</span>            break L0;
        }
// #/generated#
<span class='bc' id='L2051' title='0|2|2 - Total: 2'>        return id;
</span>    }

    private static final int
        Id_constructor          = 1,
        Id_toString             = 2,
        Id_toLocaleString       = 3,
        Id_toSource             = 4,
        Id_join                 = 5,
        Id_reverse              = 6,
        Id_sort                 = 7,
        Id_push                 = 8,
        Id_pop                  = 9,
        Id_shift                = 10,
        Id_unshift              = 11,
        Id_splice               = 12,
        Id_concat               = 13,
        Id_slice                = 14,
        Id_indexOf              = 15,
        Id_lastIndexOf          = 16,
        Id_every                = 17,
        Id_filter               = 18,
        Id_forEach              = 19,
        Id_map                  = 20,
        Id_some                 = 21,
        Id_find                 = 22,
        Id_findIndex            = 23,
        Id_reduce               = 24,
        Id_reduceRight          = 25,
        SymbolId_iterator       = 26,

        MAX_PROTOTYPE_ID        = SymbolId_iterator;

// #/string_id_map#

    private static final int
        ConstructorId_join                 = -Id_join,
        ConstructorId_reverse              = -Id_reverse,
        ConstructorId_sort                 = -Id_sort,
        ConstructorId_push                 = -Id_push,
        ConstructorId_pop                  = -Id_pop,
        ConstructorId_shift                = -Id_shift,
        ConstructorId_unshift              = -Id_unshift,
        ConstructorId_splice               = -Id_splice,
        ConstructorId_concat               = -Id_concat,
        ConstructorId_slice                = -Id_slice,
        ConstructorId_indexOf              = -Id_indexOf,
        ConstructorId_lastIndexOf          = -Id_lastIndexOf,
        ConstructorId_every                = -Id_every,
        ConstructorId_filter               = -Id_filter,
        ConstructorId_forEach              = -Id_forEach,
        ConstructorId_map                  = -Id_map,
        ConstructorId_some                 = -Id_some,
        ConstructorId_find                 = -Id_find,
        ConstructorId_findIndex            = -Id_findIndex,
        ConstructorId_reduce               = -Id_reduce,
        ConstructorId_reduceRight          = -Id_reduceRight,
        ConstructorId_isArray              = -26;

    /**
     * Internal representation of the JavaScript array's length property.
     */
    private long length;

    /**
     * Attributes of the array's length property
     */
<span class='bc' id='L2118' title='0|6|6 - Total: 6'>    private int lengthAttr = DONTENUM | PERMANENT;
</span>
    /**
     * Fast storage for dense arrays. Sparse arrays will use the superclass's
     * hashtable storage scheme.
     */
    private Object[] dense;

    /**
     * True if all numeric properties are stored in <code>dense</code>.
     */
    private boolean denseOnly;

    /**
     * The maximum size of <code>dense</code> that will be allocated initially.
     */
<span class='bc' id='L2134' title='0|3|3 - Total: 3'>    private static int maximumInitialCapacity = 10000;
</span>
    /**
     * The default capacity for <code>dense</code>.
     */
    private static final int DEFAULT_INITIAL_CAPACITY = 10;

    /**
     * The factor to grow <code>dense</code> by.
     */
    private static final double GROW_FACTOR = 1.5;
    private static final int MAX_PRE_GROW_SIZE = (int)(Integer.MAX_VALUE / GROW_FACTOR);
}
</pre></body></html><table class='legend'><tr><td class='nc'>Not Covered</td><td class='ac'>Covered by test suite 1</td><td class='bc'>Covered by test suite 2</td><td class='uc'>Covered by the union test suite</td><td class='apc'>Partially Covered by test suite 1</td><td class='bpc'>Partially Covered by test suite 2</td><td class='upc'>Partially Covered by the union test suite</td></tr></table>