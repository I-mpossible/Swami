<?xml version='1.0' encoding='UTF-8'?><!DOCTYPE html PUBLIC '-//W3C//DTD XHTML 1.0 Strict//EN' 'http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd'><html xmlns='http://www.w3.org/1999/xhtml' lang='en'><head><meta http-equiv='Content-Type' content='text/html;charset=UTF-8'/><title>org.mozilla.javascript.ClassCache.java</title><link rel='stylesheet' href='../.resources/report.css' type='text/css'/><link rel='stylesheet' href='../.resources/prettify.css' type='text/css'/><link rel='stylesheet' href='../.resources/custom.css' type='text/css'/><script type='text/javascript' src='../.resources/prettify.js'></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><h1>org.mozilla.javascript.ClassCache.java</h1><table class='legend'><tr><td class='nc'>Not Covered</td><td class='ac'>Covered by test suite 1</td><td class='bc'>Covered by test suite 2</td><td class='uc'>Covered by the union test suite</td><td class='apc'>Partially Covered by test suite 1</td><td class='bpc'>Partially Covered by test suite 2</td><td class='upc'>Partially Covered by the union test suite</td></tr></table><pre class='source lang-java linenums'>/* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-
 *
 * This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at http://mozilla.org/MPL/2.0/. */

package org.mozilla.javascript;

import java.util.Map;
import java.util.concurrent.ConcurrentHashMap;
import java.io.Serializable;

/**
 * Cache of generated classes and data structures to access Java runtime
 * from JavaScript.
 *
 * @author Igor Bukanov
 *
 * @since Rhino 1.5 Release 5
 */
<span class='uc' id='L21' title='2|2|2 - Total: 2'>public class ClassCache implements Serializable
</span>{
    private static final long serialVersionUID = -8866246036237312215L;
<span class='uc' id='L24' title='3|3|3 - Total: 3'>    private static final Object AKEY = "ClassCache";
</span><span class='uc' id='L25' title='4|4|4 - Total: 4'>    private volatile boolean cachingIsEnabled = true;
</span>    private transient Map<Class<?>,JavaMembers> classTable;
    private transient Map<JavaAdapter.JavaAdapterSignature,Class<?>> classAdapterCache;
    private transient Map<Class<?>,Object> interfaceAdapterCache;
    private int generatedClassSerial;
    private Scriptable associatedScope;

    /**
     * Search for ClassCache object in the given scope.
     * The method first calls
     * {@link ScriptableObject#getTopLevelScope(Scriptable scope)}
     * to get the top most scope and then tries to locate associated
     * ClassCache object in the prototype chain of the top scope.
     *
     * @param scope scope to search for ClassCache object.
     * @return previously associated ClassCache object or a new instance of
     *         ClassCache if no ClassCache object was found.
     *
     * @see #associate(ScriptableObject topScope)
     */
    public static ClassCache get(Scriptable scope)
    {
<span class='uc' id='L47' title='2|2|2 - Total: 2'>        ClassCache cache = (ClassCache)
</span><span class='uc' id='L48' title='3|3|3 - Total: 3'>                ScriptableObject.getTopScopeValue(scope, AKEY);
</span><span class='upc' id='L49' title='1|1|1 - Total: 2'>        if (cache == null) {
</span><span class='nc' id='L50' title='0|0|0 - Total: 5'>            throw new RuntimeException("Can't find top level scope for " +
</span>                    "ClassCache.get");
        }
<span class='uc' id='L53' title='2|2|2 - Total: 2'>        return cache;
</span>    }

    /**
     * Associate ClassCache object with the given top-level scope.
     * The ClassCache object can only be associated with the given scope once.
     *
     * @param topScope scope to associate this ClassCache object with.
     * @return true if no previous ClassCache objects were embedded into
     *         the scope and this ClassCache were successfully associated
     *         or false otherwise.
     *
     * @see #get(Scriptable scope)
     */
    public boolean associate(ScriptableObject topScope)
    {
<span class='upc' id='L69' title='1|1|1 - Total: 2'>        if (topScope.getParentScope() != null) {
</span>            // Can only associate cache with top level scope
<span class='nc' id='L71' title='0|0|0 - Total: 4'>            throw new IllegalArgumentException();
</span>        }
<span class='uc' id='L73' title='2|2|2 - Total: 2'>        if (this == topScope.associateValue(AKEY, this)) {
</span><span class='uc' id='L74' title='3|3|3 - Total: 3'>            associatedScope = topScope;
</span><span class='uc' id='L75' title='2|2|2 - Total: 2'>            return true;
</span>        }
<span class='uc' id='L77' title='2|2|2 - Total: 2'>        return false;
</span>    }

    /**
     * Empty caches of generated Java classes and Java reflection information.
     */
    public synchronized void clearCaches()
    {
<span class='nc' id='L85' title='0|0|0 - Total: 3'>        classTable = null;
</span><span class='nc' id='L86' title='0|0|0 - Total: 3'>        classAdapterCache = null;
</span><span class='nc' id='L87' title='0|0|0 - Total: 3'>        interfaceAdapterCache = null;
</span><span class='nc' id='L88' title='0|0|0 - Total: 1'>    }
</span>
    /**
     * Check if generated Java classes and Java reflection information
     * is cached.
     */
    public final boolean isCachingEnabled()
    {
<span class='uc' id='L96' title='3|3|3 - Total: 3'>        return cachingIsEnabled;
</span>    }

     /**
     * Set whether to cache some values.
     * <p>
     * By default, the engine will cache the results of
     * <tt>Class.getMethods()</tt> and similar calls.
     * This can speed execution dramatically, but increases the memory
     * footprint. Also, with caching enabled, references may be held to
     * objects past the lifetime of any real usage.
     * <p>
     * If caching is enabled and this method is called with a
     * <code>false</code> argument, the caches will be emptied.
     * <p>
     * Caching is enabled by default.
     *
     * @param enabled if true, caching is enabled
     *
     * @see #clearCaches()
     */
    public synchronized void setCachingEnabled(boolean enabled)
    {
<span class='nc' id='L119' title='0|0|0 - Total: 2'>        if (enabled == cachingIsEnabled)
</span><span class='nc' id='L120' title='0|0|0 - Total: 1'>            return;
</span><span class='nc' id='L121' title='0|0|0 - Total: 2'>        if (!enabled)
</span><span class='nc' id='L122' title='0|0|0 - Total: 2'>            clearCaches();
</span><span class='nc' id='L123' title='0|0|0 - Total: 3'>        cachingIsEnabled = enabled;
</span><span class='nc' id='L124' title='0|0|0 - Total: 1'>    }
</span>
    /**
     * @return a map from classes to associated JavaMembers objects
     */
    Map<Class<?>,JavaMembers> getClassCacheMap() {
<span class='uc' id='L130' title='2|2|2 - Total: 2'>        if (classTable == null) {
</span>            // Use 1 as concurrency level here and for other concurrent hash maps
            // as we don't expect high levels of sustained concurrent writes.
<span class='uc' id='L133' title='8|8|8 - Total: 8'>            classTable = new ConcurrentHashMap<Class<?>,JavaMembers>(16, 0.75f, 1);
</span>        }
<span class='uc' id='L135' title='3|3|3 - Total: 3'>        return classTable;
</span>    }

    Map<JavaAdapter.JavaAdapterSignature,Class<?>> getInterfaceAdapterCacheMap()
    {
<span class='uc' id='L140' title='2|2|2 - Total: 2'>        if (classAdapterCache == null) {
</span><span class='uc' id='L141' title='8|8|8 - Total: 8'>            classAdapterCache = new ConcurrentHashMap<JavaAdapter.JavaAdapterSignature,Class<?>>(16, 0.75f, 1);
</span>        }
<span class='uc' id='L143' title='3|3|3 - Total: 3'>        return classAdapterCache;
</span>    }

    /**
     * @deprecated
     * The method always returns false.
     * @see #setInvokerOptimizationEnabled(boolean enabled)
     */
    @Deprecated
    public boolean isInvokerOptimizationEnabled()
    {
<span class='nc' id='L154' title='0|0|0 - Total: 2'>        return false;
</span>    }

    /**
     * @deprecated
     * The method does nothing.
     * Invoker optimization is no longer used by Rhino.
     * On modern JDK like 1.4 or 1.5 the disadvantages of the optimization
     * like increased memory usage or longer initialization time overweight
     * small speed increase that can be gained using generated proxy class
     * to replace reflection.
     */
    @Deprecated
    public synchronized void setInvokerOptimizationEnabled(boolean enabled)
    {
<span class='nc' id='L169' title='0|0|0 - Total: 1'>    }
</span>
    /**
     * Internal engine method to return serial number for generated classes
     * to ensure name uniqueness.
     */
    public final synchronized int newClassSerialNumber()
    {
<span class='uc' id='L177' title='8|8|8 - Total: 8'>        return ++generatedClassSerial;
</span>    }

    Object getInterfaceAdapter(Class<?> cl)
    {
<span class='upc' id='L182' title='1|1|1 - Total: 2'>        return interfaceAdapterCache == null
</span>                    ? null
<span class='nc' id='L184' title='0|0|0 - Total: 1'>                    : interfaceAdapterCache.get(cl);
</span>    }

    synchronized void cacheInterfaceAdapter(Class<?> cl, Object iadapter)
    {
<span class='upc' id='L189' title='1|1|1 - Total: 2'>        if (cachingIsEnabled) {
</span><span class='upc' id='L190' title='1|1|1 - Total: 2'>            if (interfaceAdapterCache == null) {
</span><span class='uc' id='L191' title='8|8|8 - Total: 8'>                interfaceAdapterCache = new ConcurrentHashMap<Class<?>,Object>(16, 0.75f, 1);
</span>            }
<span class='uc' id='L193' title='6|6|6 - Total: 6'>            interfaceAdapterCache.put(cl, iadapter);
</span>        }
<span class='uc' id='L195' title='1|1|1 - Total: 1'>    }
</span>
    Scriptable getAssociatedScope() {
<span class='uc' id='L198' title='3|3|3 - Total: 3'>        return associatedScope;
</span>    }
}
</pre></body></html><table class='legend'><tr><td class='nc'>Not Covered</td><td class='ac'>Covered by test suite 1</td><td class='bc'>Covered by test suite 2</td><td class='uc'>Covered by the union test suite</td><td class='apc'>Partially Covered by test suite 1</td><td class='bpc'>Partially Covered by test suite 2</td><td class='upc'>Partially Covered by the union test suite</td></tr></table>