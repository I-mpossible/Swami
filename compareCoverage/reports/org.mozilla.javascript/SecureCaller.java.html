<?xml version='1.0' encoding='UTF-8'?><!DOCTYPE html PUBLIC '-//W3C//DTD XHTML 1.0 Strict//EN' 'http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd'><html xmlns='http://www.w3.org/1999/xhtml' lang='en'><head><meta http-equiv='Content-Type' content='text/html;charset=UTF-8'/><title>org.mozilla.javascript.SecureCaller.java</title><link rel='stylesheet' href='../.resources/report.css' type='text/css'/><link rel='stylesheet' href='../.resources/prettify.css' type='text/css'/><link rel='stylesheet' href='../.resources/custom.css' type='text/css'/><script type='text/javascript' src='../.resources/prettify.js'></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><h1>org.mozilla.javascript.SecureCaller.java</h1><table class='legend'><tr><td class='nc'>Not Covered</td><td class='ac'>Covered by test suite 1</td><td class='bc'>Covered by test suite 2</td><td class='uc'>Covered by the union test suite</td><td class='apc'>Partially Covered by test suite 1</td><td class='bpc'>Partially Covered by test suite 2</td><td class='upc'>Partially Covered by the union test suite</td></tr></table><pre class='source lang-java linenums'>/* This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at http://mozilla.org/MPL/2.0/. */

package org.mozilla.javascript;

import java.io.ByteArrayOutputStream;
import java.io.IOException;
import java.io.InputStream;
import java.lang.ref.SoftReference;
import java.lang.reflect.UndeclaredThrowableException;
import java.net.URL;
import java.security.AccessController;
import java.security.CodeSource;
import java.security.PrivilegedAction;
import java.security.PrivilegedActionException;
import java.security.PrivilegedExceptionAction;
import java.security.SecureClassLoader;
import java.util.Map;
import java.util.WeakHashMap;

/**
 * @author Attila Szegedi
 */
<span class='nc' id='L25' title='0|0|0 - Total: 3'>public abstract class SecureCaller
</span>{
<span class='nc' id='L27' title='0|0|0 - Total: 2'>    private static final byte[] secureCallerImplBytecode = loadBytecode();
</span>
    // We're storing a CodeSource -> (ClassLoader -> SecureRenderer), since we
    // need to have one renderer per class loader. We're using weak hash maps
    // and soft references all the way, since we don't want to interfere with
    // cleanup of either CodeSource or ClassLoader objects.
    private static final Map<CodeSource,Map<ClassLoader,SoftReference<SecureCaller>>>
<span class='nc' id='L34' title='0|0|0 - Total: 5'>    callers =
</span>        new WeakHashMap<CodeSource,Map<ClassLoader,SoftReference<SecureCaller>>>();

    public abstract Object call(Callable callable, Context cx,
            Scriptable scope, Scriptable thisObj, Object[] args);

    /**
     * Call the specified callable using a protection domain belonging to the
     * specified code source.
     */
    static Object callSecurely(final CodeSource codeSource, Callable callable,
            Context cx, Scriptable scope, Scriptable thisObj, Object[] args)
    {
<span class='nc' id='L47' title='0|0|0 - Total: 2'>        final Thread thread = Thread.currentThread();
</span>        // Run in doPrivileged as we might be checked for "getClassLoader"
        // runtime permission
<span class='nc' id='L50' title='0|0|0 - Total: 7'>        final ClassLoader classLoader = (ClassLoader)AccessController.doPrivileged(
</span>            new PrivilegedAction<Object>() {
                public Object run() {
                    return thread.getContextClassLoader();
                }
            });
        Map<ClassLoader,SoftReference<SecureCaller>> classLoaderMap;
<span class='nc' id='L57' title='0|0|0 - Total: 4'>        synchronized(callers)
</span>        {
<span class='nc' id='L59' title='0|0|0 - Total: 5'>            classLoaderMap = callers.get(codeSource);
</span><span class='nc' id='L60' title='0|0|0 - Total: 2'>            if(classLoaderMap == null)
</span>            {
<span class='nc' id='L62' title='0|0|0 - Total: 4'>                classLoaderMap = new WeakHashMap<ClassLoader,SoftReference<SecureCaller>>();
</span><span class='nc' id='L63' title='0|0|0 - Total: 5'>                callers.put(codeSource, classLoaderMap);
</span>            }
<span class='nc' id='L65' title='0|0|0 - Total: 8'>        }
</span>        SecureCaller caller;
<span class='nc' id='L67' title='0|0|0 - Total: 4'>        synchronized(classLoaderMap)
</span>        {
<span class='nc' id='L69' title='0|0|0 - Total: 5'>            SoftReference<SecureCaller> ref = classLoaderMap.get(classLoader);
</span><span class='nc' id='L70' title='0|0|0 - Total: 2'>            if (ref != null) {
</span><span class='nc' id='L71' title='0|0|0 - Total: 5'>                caller = ref.get();
</span>            } else {
<span class='nc' id='L73' title='0|0|0 - Total: 2'>                caller = null;
</span>            }
<span class='nc' id='L75' title='0|0|0 - Total: 2'>            if (caller == null) {
</span>                try
                {
                    // Run in doPrivileged as we'll be checked for
                    // "createClassLoader" runtime permission
<span class='nc' id='L80' title='0|0|0 - Total: 8'>                    caller = (SecureCaller)AccessController.doPrivileged(
</span>                            new PrivilegedExceptionAction<Object>()
                    {
                        public Object run() throws Exception
                        {
                            ClassLoader effectiveClassLoader;
                            Class<?> thisClass = getClass();
                            if(classLoader.loadClass(thisClass.getName()) != thisClass) {
                                effectiveClassLoader = thisClass.getClassLoader();
                            } else {
                                effectiveClassLoader = classLoader;
                            }
                            SecureClassLoaderImpl secCl =
                                new SecureClassLoaderImpl(effectiveClassLoader);
                            Class<?> c = secCl.defineAndLinkClass(
                                    SecureCaller.class.getName() + "Impl",
                                    secureCallerImplBytecode, codeSource);
                            return c.newInstance();
                        }
                    });
<span class='nc' id='L100' title='0|0|0 - Total: 8'>                    classLoaderMap.put(classLoader, new SoftReference<SecureCaller>(caller));
</span>                }
<span class='nc' id='L102' title='0|0|0 - Total: 1'>                catch(PrivilegedActionException ex)
</span>                {
<span class='nc' id='L104' title='0|0|0 - Total: 6'>                    throw new UndeclaredThrowableException(ex.getCause());
</span><span class='nc' id='L105' title='0|0|0 - Total: 1'>                }
</span>            }
<span class='nc' id='L107' title='0|0|0 - Total: 8'>        }
</span><span class='nc' id='L108' title='0|0|0 - Total: 8'>        return caller.call(callable, cx, scope, thisObj, args);
</span>    }

    private static class SecureClassLoaderImpl extends SecureClassLoader
    {
        SecureClassLoaderImpl(ClassLoader parent)
        {
            super(parent);
        }

        Class<?> defineAndLinkClass(String name, byte[] bytes, CodeSource cs)
        {
            Class<?> cl = defineClass(name, bytes, 0, bytes.length, cs);
            resolveClass(cl);
            return cl;
        }
    }

    private static byte[] loadBytecode()
    {
<span class='nc' id='L128' title='0|0|0 - Total: 7'>        return (byte[])AccessController.doPrivileged(new PrivilegedAction<Object>()
</span>        {
            public Object run()
            {
                return loadBytecodePrivileged();
            }
        });
    }

    private static byte[] loadBytecodePrivileged()
    {
<span class='nc' id='L139' title='0|0|0 - Total: 4'>        URL url = SecureCaller.class.getResource("SecureCallerImpl.clazz");
</span>        try
        {
<span class='nc' id='L142' title='0|0|0 - Total: 3'>            InputStream in = url.openStream();
</span>            try
            {
<span class='nc' id='L145' title='0|0|0 - Total: 4'>                ByteArrayOutputStream bout = new ByteArrayOutputStream();
</span>                for(;;)
                {
<span class='nc' id='L148' title='0|0|0 - Total: 3'>                    int r = in.read();
</span><span class='nc' id='L149' title='0|0|0 - Total: 2'>                    if(r == -1)
</span>                    {
<span class='nc' id='L151' title='0|0|0 - Total: 5'>                        return bout.toByteArray();
</span>                    }
<span class='nc' id='L153' title='0|0|0 - Total: 3'>                    bout.write(r);
</span><span class='nc' id='L154' title='0|0|0 - Total: 1'>                }
</span>            }
            finally
            {
<span class='nc' id='L158' title='0|0|0 - Total: 5'>                in.close();
</span><span class='nc' id='L159' title='0|0|0 - Total: 2'>            }
</span>        }
<span class='nc' id='L161' title='0|0|0 - Total: 1'>        catch(IOException e)
</span>        {
<span class='nc' id='L163' title='0|0|0 - Total: 5'>            throw new UndeclaredThrowableException(e);
</span>        }
    }
}
</pre></body></html><table class='legend'><tr><td class='nc'>Not Covered</td><td class='ac'>Covered by test suite 1</td><td class='bc'>Covered by test suite 2</td><td class='uc'>Covered by the union test suite</td><td class='apc'>Partially Covered by test suite 1</td><td class='bpc'>Partially Covered by test suite 2</td><td class='upc'>Partially Covered by the union test suite</td></tr></table>