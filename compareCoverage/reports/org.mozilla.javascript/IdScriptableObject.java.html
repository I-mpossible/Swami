<?xml version='1.0' encoding='UTF-8'?><!DOCTYPE html PUBLIC '-//W3C//DTD XHTML 1.0 Strict//EN' 'http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd'><html xmlns='http://www.w3.org/1999/xhtml' lang='en'><head><meta http-equiv='Content-Type' content='text/html;charset=UTF-8'/><title>org.mozilla.javascript.IdScriptableObject.java</title><link rel='stylesheet' href='../.resources/report.css' type='text/css'/><link rel='stylesheet' href='../.resources/prettify.css' type='text/css'/><link rel='stylesheet' href='../.resources/custom.css' type='text/css'/><script type='text/javascript' src='../.resources/prettify.js'></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><h1>org.mozilla.javascript.IdScriptableObject.java</h1><table class='legend'><tr><td class='nc'>Not Covered</td><td class='ac'>Covered by test suite 1</td><td class='bc'>Covered by test suite 2</td><td class='uc'>Covered by the union test suite</td><td class='apc'>Partially Covered by test suite 1</td><td class='bpc'>Partially Covered by test suite 2</td><td class='upc'>Partially Covered by the union test suite</td></tr></table><pre class='source lang-java linenums'>/* -*- Mode: java; tab-width: 4; indent-tabs-mode: 1; c-basic-offset: 4 -*-
 *
 * This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at http://mozilla.org/MPL/2.0/. */

package org.mozilla.javascript;

import java.io.IOException;
import java.io.ObjectInputStream;
import java.io.ObjectOutputStream;
import java.io.Serializable;

/**
Base class for native object implementation that uses IdFunctionObject to export its methods to script via <class-name>.prototype object.

Any descendant should implement at least the following methods:
    findInstanceIdInfo
    getInstanceIdName
    execIdCall
    methodArity

To define non-function properties, the descendant should override
    getInstanceIdValue
    setInstanceIdValue
to get/set property value and provide its default attributes.


To customize initialization of constructor and prototype objects, descendant
may override scopeInit or fillConstructorProperties methods.

*/
public abstract class IdScriptableObject extends ScriptableObject
    implements IdFunctionCall
{
    private transient PrototypeValues prototypeValues;

    private static final class PrototypeValues implements Serializable
    {
        static final long serialVersionUID = 3038645279153854371L;

        private static final int NAME_SLOT = 1;
        private static final int SLOT_SPAN = 2;

        private IdScriptableObject obj;
        private int maxId;
        private Object[] valueArray;
        private short[] attributeArray;

        // The following helps to avoid creation of valueArray during runtime
        // initialization for common case of "constructor" property
        int constructorId;
        private IdFunctionObject constructor;
        private short constructorAttrs;

        PrototypeValues(IdScriptableObject obj, int maxId)
        {
            if (obj == null) throw new IllegalArgumentException();
            if (maxId < 1) throw new IllegalArgumentException();
            this.obj = obj;
            this.maxId = maxId;
        }

        final int getMaxId()
        {
            return maxId;
        }

        final void initValue(int id, String name, Object value, int attributes)
        {
            if (!(1 <= id && id <= maxId))
                throw new IllegalArgumentException();
            if (name == null)
                throw new IllegalArgumentException();
            if (value == NOT_FOUND)
                throw new IllegalArgumentException();
            ScriptableObject.checkValidAttributes(attributes);
            if (obj.findPrototypeId(name) != id)
                throw new IllegalArgumentException(name);

            if (id == constructorId) {
                if (!(value instanceof IdFunctionObject)) {
                    throw new IllegalArgumentException("consructor should be initialized with IdFunctionObject");
                }
                constructor = (IdFunctionObject)value;
                constructorAttrs = (short)attributes;
                return;
            }

            initSlot(id, name, value, attributes);
        }

        final void initValue(int id, Symbol key, Object value, int attributes)
        {
            if (!(1 <= id && id <= maxId))
                throw new IllegalArgumentException();
            if (key == null)
                throw new IllegalArgumentException();
            if (value == NOT_FOUND)
                throw new IllegalArgumentException();
            ScriptableObject.checkValidAttributes(attributes);
            if (obj.findPrototypeId(key) != id)
                throw new IllegalArgumentException(key.toString());

            if (id == constructorId) {
                if (!(value instanceof IdFunctionObject)) {
                    throw new IllegalArgumentException("consructor should be initialized with IdFunctionObject");
                }
                constructor = (IdFunctionObject)value;
                constructorAttrs = (short)attributes;
                return;
            }

            initSlot(id, "", value, attributes);
        }

        private void initSlot(int id, String name, Object value,
                              int attributes)
        {
            Object[] array = valueArray;
            if (array == null)
                throw new IllegalStateException();

            if (value == null) {
                value = UniqueTag.NULL_VALUE;
            }
            int index = (id - 1) * SLOT_SPAN;
            synchronized (this) {
                Object value2 = array[index];
                if (value2 == null) {
                    array[index] = value;
                    array[index + NAME_SLOT] = name;
                    attributeArray[id - 1] = (short)attributes;
                } else {
                    if (!name.equals(array[index + NAME_SLOT]))
                         throw new IllegalStateException();
                }
            }
        }

        final IdFunctionObject createPrecachedConstructor()
        {
            if (constructorId != 0) throw new IllegalStateException();
            constructorId = obj.findPrototypeId("constructor");
            if (constructorId == 0) {
                throw new IllegalStateException(
                    "No id for constructor property");
            }
            obj.initPrototypeId(constructorId);
            if (constructor == null) {
                throw new IllegalStateException(
                    obj.getClass().getName()+".initPrototypeId() did not "
                    +"initialize id="+constructorId);
            }
            constructor.initFunction(obj.getClassName(),
                                     ScriptableObject.getTopLevelScope(obj));
            constructor.markAsConstructor(obj);
            return constructor;
        }

        final int findId(String name)
        {
            return obj.findPrototypeId(name);
        }

        final int findId(Symbol key)
        {
            return obj.findPrototypeId(key);
        }

        final boolean has(int id)
        {
            Object[] array = valueArray;
            if (array == null) {
                // Not yet initialized, assume all exists
                return true;
            }
            int valueSlot = (id  - 1) * SLOT_SPAN;
            Object value = array[valueSlot];
            if (value == null) {
                // The particular entry has not been yet initialized
                return true;
            }
            return value != NOT_FOUND;
        }

        final Object get(int id)
        {
            Object value = ensureId(id);
            if (value == UniqueTag.NULL_VALUE) {
                value = null;
            }
            return value;
        }

        final void set(int id, Scriptable start, Object value)
        {
            if (value == NOT_FOUND) throw new IllegalArgumentException();
            ensureId(id);
            int attr = attributeArray[id - 1];
            if ((attr & READONLY) == 0) {
                if (start == obj) {
                    if (value == null) {
                        value = UniqueTag.NULL_VALUE;
                    }
                    int valueSlot = (id  - 1) * SLOT_SPAN;
                    synchronized (this) {
                        valueArray[valueSlot] = value;
                    }
                }
                else {
                    int nameSlot = (id  - 1) * SLOT_SPAN + NAME_SLOT;
                    String name = (String)valueArray[nameSlot];
                    start.put(name, start, value);
                }
            }
        }

        final void delete(int id)
        {
            ensureId(id);
            int attr = attributeArray[id - 1];
            // non-configurable
            if ((attr & PERMANENT) != 0) {
                Context cx = Context.getContext();
                if (cx.isStrictMode()) {
                    int nameSlot = (id  - 1) * SLOT_SPAN + NAME_SLOT;
                    String name = (String)valueArray[nameSlot];
                    throw ScriptRuntime.typeError1("msg.delete.property.with.configurable.false", name);
                }
            } else {
                int valueSlot = (id  - 1) * SLOT_SPAN;
                synchronized (this) {
                    valueArray[valueSlot] = NOT_FOUND;
                    attributeArray[id - 1] = EMPTY;
                }
            }
        }

        final int getAttributes(int id)
        {
            ensureId(id);
            return attributeArray[id - 1];
        }

        final void setAttributes(int id, int attributes)
        {
            ScriptableObject.checkValidAttributes(attributes);
            ensureId(id);
            synchronized (this) {
                attributeArray[id - 1] = (short)attributes;
            }
        }

        final Object[] getNames(boolean getAll, Object[] extraEntries)
        {
            Object[] names = null;
            int count = 0;
            for (int id = 1; id <= maxId; ++id) {
                Object value = ensureId(id);
                if (getAll || (attributeArray[id - 1] & DONTENUM) == 0) {
                    if (value != NOT_FOUND) {
                        int nameSlot = (id  - 1) * SLOT_SPAN + NAME_SLOT;
                        String name = (String)valueArray[nameSlot];
                        if (names == null) {
                            names = new Object[maxId];
                        }
                        names[count++] = name;
                    }
                }
            }
            if (count == 0) {
                return extraEntries;
            } else if (extraEntries == null || extraEntries.length == 0) {
                if (count != names.length) {
                    Object[] tmp = new Object[count];
                    System.arraycopy(names, 0, tmp, 0, count);
                    names = tmp;
                }
                return names;
            } else {
                int extra = extraEntries.length;
                Object[] tmp = new Object[extra + count];
                System.arraycopy(extraEntries, 0, tmp, 0, extra);
                System.arraycopy(names, 0, tmp, extra, count);
                return tmp;
            }
        }

        private Object ensureId(int id)
        {
            Object[] array = valueArray;
            if (array == null) {
                synchronized (this) {
                    array = valueArray;
                    if (array == null) {
                        array = new Object[maxId * SLOT_SPAN];
                        valueArray = array;
                        attributeArray = new short[maxId];
                    }
                }
            }
            int valueSlot = (id  - 1) * SLOT_SPAN;
            Object value = array[valueSlot];
            if (value == null) {
                if (id == constructorId) {
                    initSlot(constructorId, "constructor",
                             constructor, constructorAttrs);
                    constructor = null; // no need to refer it any longer
                } else {
                    obj.initPrototypeId(id);
                }
                value = array[valueSlot];
                if (value == null) {
                    throw new IllegalStateException(
                        obj.getClass().getName()+".initPrototypeId(int id) "
                        +"did not initialize id="+id);
                }
            }
            return value;
        }
    }

    public IdScriptableObject()
<span class='uc' id='L325' title='2|2|2 - Total: 2'>    {
</span><span class='uc' id='L326' title='1|1|1 - Total: 1'>    }
</span>
    public IdScriptableObject(Scriptable scope, Scriptable prototype)
    {
<span class='uc' id='L330' title='4|4|4 - Total: 4'>        super(scope, prototype);
</span><span class='uc' id='L331' title='1|1|1 - Total: 1'>    }
</span>
    protected final boolean defaultHas(String name)
    {
<span class='uc' id='L335' title='5|5|5 - Total: 5'>        return super.has(name, this);
</span>    }

    protected final Object defaultGet(String name)
    {
<span class='nc' id='L340' title='0|0|0 - Total: 5'>        return super.get(name, this);
</span>    }

    protected final void defaultPut(String name, Object value)
    {
<span class='nc' id='L345' title='0|0|0 - Total: 5'>        super.put(name, this, value);
</span><span class='nc' id='L346' title='0|0|0 - Total: 1'>    }
</span>
    @Override
    public boolean has(String name, Scriptable start)
    {
<span class='uc' id='L351' title='4|4|4 - Total: 4'>        int info = findInstanceIdInfo(name);
</span><span class='uc' id='L352' title='2|2|2 - Total: 2'>        if (info != 0) {
</span><span class='uc' id='L353' title='4|4|4 - Total: 4'>            int attr = (info >>> 16);
</span><span class='uc' id='L354' title='2|2|2 - Total: 2'>            if ((attr & PERMANENT) != 0) {
</span><span class='uc' id='L355' title='2|2|2 - Total: 2'>                return true;
</span>            }
<span class='uc' id='L357' title='4|4|4 - Total: 4'>            int id = (info & 0xFFFF);
</span><span class='upc' id='L358' title='1|1|1 - Total: 2'>            return NOT_FOUND != getInstanceIdValue(id);
</span>        }
<span class='uc' id='L360' title='2|2|2 - Total: 2'>        if (prototypeValues != null) {
</span><span class='uc' id='L361' title='5|5|5 - Total: 5'>            int id = prototypeValues.findId(name);
</span><span class='uc' id='L362' title='2|2|2 - Total: 2'>            if (id != 0) {
</span><span class='uc' id='L363' title='5|5|5 - Total: 5'>                return prototypeValues.has(id);
</span>            }
        }
<span class='uc' id='L366' title='5|5|5 - Total: 5'>        return super.has(name, start);
</span>    }


    @Override
    public boolean has(Symbol key, Scriptable start)
    {
<span class='uc' id='L373' title='4|4|4 - Total: 4'>        int info = findInstanceIdInfo(key);
</span><span class='upc' id='L374' title='1|1|1 - Total: 2'>        if (info != 0) {
</span><span class='nc' id='L375' title='0|0|0 - Total: 4'>            int attr = (info >>> 16);
</span><span class='nc' id='L376' title='0|0|0 - Total: 2'>            if ((attr & PERMANENT) != 0) {
</span><span class='nc' id='L377' title='0|0|0 - Total: 2'>                return true;
</span>            }
<span class='nc' id='L379' title='0|0|0 - Total: 4'>            int id = (info & 0xFFFF);
</span><span class='nc' id='L380' title='0|0|0 - Total: 2'>            return NOT_FOUND != getInstanceIdValue(id);
</span>        }
<span class='uc' id='L382' title='2|2|2 - Total: 2'>        if (prototypeValues != null) {
</span><span class='uc' id='L383' title='5|5|5 - Total: 5'>            int id = prototypeValues.findId(key);
</span><span class='uc' id='L384' title='2|2|2 - Total: 2'>            if (id != 0) {
</span><span class='uc' id='L385' title='5|5|5 - Total: 5'>                return prototypeValues.has(id);
</span>            }
        }
<span class='uc' id='L388' title='5|5|5 - Total: 5'>        return super.has(key, start);
</span>    }

    @Override
    public Object get(String name, Scriptable start)
    {
        // Check for slot first for performance. This is a very hot code
        // path that should be further optimized.
<span class='uc' id='L396' title='5|5|5 - Total: 5'>        Object value = super.get(name, start);
</span><span class='uc' id='L397' title='2|2|2 - Total: 2'>        if (value != NOT_FOUND) {
</span><span class='uc' id='L398' title='2|2|2 - Total: 2'>            return value;
</span>        }
<span class='uc' id='L400' title='4|4|4 - Total: 4'>        int info = findInstanceIdInfo(name);
</span><span class='uc' id='L401' title='2|2|2 - Total: 2'>        if (info != 0) {
</span><span class='uc' id='L402' title='4|4|4 - Total: 4'>            int id = (info & 0xFFFF);
</span><span class='uc' id='L403' title='4|4|4 - Total: 4'>            value = getInstanceIdValue(id);
</span><span class='uc' id='L404' title='2|2|2 - Total: 2'>            if (value != NOT_FOUND) return value;
</span>        }
<span class='uc' id='L406' title='2|2|2 - Total: 2'>        if (prototypeValues != null) {
</span><span class='uc' id='L407' title='5|5|5 - Total: 5'>            int id = prototypeValues.findId(name);
</span><span class='uc' id='L408' title='2|2|2 - Total: 2'>            if (id != 0) {
</span><span class='uc' id='L409' title='5|5|5 - Total: 5'>                value = prototypeValues.get(id);
</span><span class='uc' id='L410' title='2|2|2 - Total: 2'>                if (value != NOT_FOUND) return value;
</span>            }
        }
<span class='uc' id='L413' title='2|2|2 - Total: 2'>        return NOT_FOUND;
</span>    }

    @Override
    public Object get(Symbol key, Scriptable start)
    {
<span class='uc' id='L419' title='5|5|5 - Total: 5'>        Object value = super.get(key, start);
</span><span class='uc' id='L420' title='2|2|2 - Total: 2'>        if (value != NOT_FOUND) {
</span><span class='uc' id='L421' title='2|2|2 - Total: 2'>            return value;
</span>        }
<span class='uc' id='L423' title='4|4|4 - Total: 4'>        int info = findInstanceIdInfo(key);
</span><span class='upc' id='L424' title='1|1|1 - Total: 2'>        if (info != 0) {
</span><span class='nc' id='L425' title='0|0|0 - Total: 4'>            int id = (info & 0xFFFF);
</span><span class='nc' id='L426' title='0|0|0 - Total: 4'>            value = getInstanceIdValue(id);
</span><span class='nc' id='L427' title='0|0|0 - Total: 2'>            if (value != NOT_FOUND) return value;
</span>        }
<span class='uc' id='L429' title='2|2|2 - Total: 2'>        if (prototypeValues != null) {
</span><span class='uc' id='L430' title='5|5|5 - Total: 5'>            int id = prototypeValues.findId(key);
</span><span class='upc' id='L431' title='1|1|1 - Total: 2'>            if (id != 0) {
</span><span class='uc' id='L432' title='5|5|5 - Total: 5'>                value = prototypeValues.get(id);
</span><span class='upc' id='L433' title='1|1|1 - Total: 2'>                if (value != NOT_FOUND) return value;
</span>            }
        }
<span class='uc' id='L436' title='2|2|2 - Total: 2'>        return NOT_FOUND;
</span>    }

    @Override
    public void put(String name, Scriptable start, Object value)
    {
<span class='uc' id='L442' title='4|4|4 - Total: 4'>        int info = findInstanceIdInfo(name);
</span><span class='uc' id='L443' title='2|2|2 - Total: 2'>        if (info != 0) {
</span><span class='upc' id='L444' title='3|3|3 - Total: 4'>            if (start == this && isSealed()) {
</span><span class='nc' id='L445' title='0|0|0 - Total: 4'>                throw Context.reportRuntimeError1("msg.modify.sealed",
</span>                                                  name);
            }
<span class='uc' id='L448' title='4|4|4 - Total: 4'>            int attr = (info >>> 16);
</span><span class='uc' id='L449' title='2|2|2 - Total: 2'>            if ((attr & READONLY) == 0) {
</span><span class='uc' id='L450' title='2|2|2 - Total: 2'>                if (start == this) {
</span><span class='uc' id='L451' title='4|4|4 - Total: 4'>                    int id = (info & 0xFFFF);
</span><span class='uc' id='L452' title='4|4|4 - Total: 4'>                    setInstanceIdValue(id, value);
</span><span class='uc' id='L453' title='1|1|1 - Total: 1'>                }
</span>                else {
<span class='uc' id='L455' title='5|5|5 - Total: 5'>                    start.put(name, start, value);
</span>                }
            }
<span class='uc' id='L458' title='1|1|1 - Total: 1'>            return;
</span>        }
<span class='uc' id='L460' title='2|2|2 - Total: 2'>        if (prototypeValues != null) {
</span><span class='uc' id='L461' title='5|5|5 - Total: 5'>            int id = prototypeValues.findId(name);
</span><span class='uc' id='L462' title='2|2|2 - Total: 2'>            if (id != 0) {
</span><span class='upc' id='L463' title='3|3|3 - Total: 4'>                if (start == this && isSealed()) {
</span><span class='nc' id='L464' title='0|0|0 - Total: 4'>                    throw Context.reportRuntimeError1("msg.modify.sealed",
</span>                                                      name);
                }
<span class='uc' id='L467' title='6|6|6 - Total: 6'>                prototypeValues.set(id, start, value);
</span><span class='uc' id='L468' title='1|1|1 - Total: 1'>                return;
</span>            }
        }
<span class='uc' id='L471' title='5|5|5 - Total: 5'>        super.put(name, start, value);
</span><span class='uc' id='L472' title='1|1|1 - Total: 1'>    }
</span>
    @Override
    public void put(Symbol key, Scriptable start, Object value)
    {
<span class='uc' id='L477' title='4|4|4 - Total: 4'>        int info = findInstanceIdInfo(key);
</span><span class='upc' id='L478' title='1|1|1 - Total: 2'>        if (info != 0) {
</span><span class='nc' id='L479' title='0|0|0 - Total: 4'>            if (start == this && isSealed()) {
</span><span class='nc' id='L480' title='0|0|0 - Total: 3'>                throw Context.reportRuntimeError0("msg.modify.sealed");
</span>            }
<span class='nc' id='L482' title='0|0|0 - Total: 4'>            int attr = (info >>> 16);
</span><span class='nc' id='L483' title='0|0|0 - Total: 2'>            if ((attr & READONLY) == 0) {
</span><span class='nc' id='L484' title='0|0|0 - Total: 2'>                if (start == this) {
</span><span class='nc' id='L485' title='0|0|0 - Total: 4'>                    int id = (info & 0xFFFF);
</span><span class='nc' id='L486' title='0|0|0 - Total: 4'>                    setInstanceIdValue(id, value);
</span><span class='nc' id='L487' title='0|0|0 - Total: 1'>                }
</span>                else {
<span class='nc' id='L489' title='0|0|0 - Total: 6'>                    ensureSymbolScriptable(start).put(key, start, value);
</span>                }
            }
<span class='nc' id='L492' title='0|0|0 - Total: 1'>            return;
</span>        }
<span class='upc' id='L494' title='1|1|1 - Total: 2'>        if (prototypeValues != null) {
</span><span class='nc' id='L495' title='0|0|0 - Total: 5'>            int id = prototypeValues.findId(key);
</span><span class='nc' id='L496' title='0|0|0 - Total: 2'>            if (id != 0) {
</span><span class='nc' id='L497' title='0|0|0 - Total: 4'>                if (start == this && isSealed()) {
</span><span class='nc' id='L498' title='0|0|0 - Total: 3'>                    throw Context.reportRuntimeError0("msg.modify.sealed");
</span>                }
<span class='nc' id='L500' title='0|0|0 - Total: 6'>                prototypeValues.set(id, start, value);
</span><span class='nc' id='L501' title='0|0|0 - Total: 1'>                return;
</span>            }
        }
<span class='uc' id='L504' title='5|5|5 - Total: 5'>        super.put(key, start, value);
</span><span class='uc' id='L505' title='1|1|1 - Total: 1'>    }
</span>
    @Override
    public void delete(String name)
    {
<span class='uc' id='L510' title='4|4|4 - Total: 4'>        int info = findInstanceIdInfo(name);
</span><span class='uc' id='L511' title='2|2|2 - Total: 2'>        if (info != 0) {
</span>            // Let the super class to throw exceptions for sealed objects
<span class='upc' id='L513' title='1|1|1 - Total: 2'>            if (!isSealed()) {
</span><span class='uc' id='L514' title='4|4|4 - Total: 4'>                int attr = (info >>> 16);
</span>                // non-configurable
<span class='uc' id='L516' title='2|2|2 - Total: 2'>                if ((attr & PERMANENT) != 0) {
</span><span class='uc' id='L517' title='2|2|2 - Total: 2'>                    Context cx = Context.getContext();
</span><span class='upc' id='L518' title='1|1|1 - Total: 2'>                    if (cx.isStrictMode()) {
</span><span class='nc' id='L519' title='0|0|0 - Total: 4'>                        throw ScriptRuntime.typeError1("msg.delete.property.with.configurable.false", name);
</span>                    }
<span class='uc' id='L521' title='1|1|1 - Total: 1'>                } else {
</span><span class='uc' id='L522' title='4|4|4 - Total: 4'>                    int id = (info & 0xFFFF);
</span><span class='uc' id='L523' title='4|4|4 - Total: 4'>                    setInstanceIdValue(id, NOT_FOUND);
</span>                }
<span class='uc' id='L525' title='1|1|1 - Total: 1'>                return;
</span>            }
        }
<span class='uc' id='L528' title='2|2|2 - Total: 2'>        if (prototypeValues != null) {
</span><span class='uc' id='L529' title='5|5|5 - Total: 5'>            int id = prototypeValues.findId(name);
</span><span class='uc' id='L530' title='2|2|2 - Total: 2'>            if (id != 0) {
</span><span class='upc' id='L531' title='1|1|1 - Total: 2'>                if (!isSealed()) {
</span><span class='uc' id='L532' title='4|4|4 - Total: 4'>                    prototypeValues.delete(id);
</span>                }
<span class='uc' id='L534' title='1|1|1 - Total: 1'>                return;
</span>            }
        }
<span class='uc' id='L537' title='3|3|3 - Total: 3'>        super.delete(name);
</span><span class='uc' id='L538' title='1|1|1 - Total: 1'>    }
</span>
    @Override
    public void delete(Symbol key)
    {
<span class='uc' id='L543' title='4|4|4 - Total: 4'>        int info = findInstanceIdInfo(key);
</span><span class='upc' id='L544' title='1|1|1 - Total: 2'>        if (info != 0) {
</span>            // Let the super class to throw exceptions for sealed objects
<span class='nc' id='L546' title='0|0|0 - Total: 2'>            if (!isSealed()) {
</span><span class='nc' id='L547' title='0|0|0 - Total: 4'>                int attr = (info >>> 16);
</span>                // non-configurable
<span class='nc' id='L549' title='0|0|0 - Total: 2'>                if ((attr & PERMANENT) != 0) {
</span><span class='nc' id='L550' title='0|0|0 - Total: 2'>                    Context cx = Context.getContext();
</span><span class='nc' id='L551' title='0|0|0 - Total: 2'>                    if (cx.isStrictMode()) {
</span><span class='nc' id='L552' title='0|0|0 - Total: 3'>                        throw ScriptRuntime.typeError0("msg.delete.property.with.configurable.false");
</span>                    }
<span class='nc' id='L554' title='0|0|0 - Total: 1'>                } else {
</span><span class='nc' id='L555' title='0|0|0 - Total: 4'>                    int id = (info & 0xFFFF);
</span><span class='nc' id='L556' title='0|0|0 - Total: 4'>                    setInstanceIdValue(id, NOT_FOUND);
</span>                }
<span class='nc' id='L558' title='0|0|0 - Total: 1'>                return;
</span>            }
        }
<span class='upc' id='L561' title='1|1|1 - Total: 2'>        if (prototypeValues != null) {
</span><span class='nc' id='L562' title='0|0|0 - Total: 5'>            int id = prototypeValues.findId(key);
</span><span class='nc' id='L563' title='0|0|0 - Total: 2'>            if (id != 0) {
</span><span class='nc' id='L564' title='0|0|0 - Total: 2'>                if (!isSealed()) {
</span><span class='nc' id='L565' title='0|0|0 - Total: 4'>                    prototypeValues.delete(id);
</span>                }
<span class='nc' id='L567' title='0|0|0 - Total: 1'>                return;
</span>            }
        }
<span class='uc' id='L570' title='3|3|3 - Total: 3'>        super.delete(key);
</span><span class='uc' id='L571' title='1|1|1 - Total: 1'>    }
</span>
    @Override
    public int getAttributes(String name)
    {
<span class='uc' id='L576' title='4|4|4 - Total: 4'>        int info = findInstanceIdInfo(name);
</span><span class='uc' id='L577' title='2|2|2 - Total: 2'>        if (info != 0) {
</span><span class='uc' id='L578' title='4|4|4 - Total: 4'>            int attr = (info >>> 16);
</span><span class='uc' id='L579' title='2|2|2 - Total: 2'>            return attr;
</span>        }
<span class='uc' id='L581' title='2|2|2 - Total: 2'>        if (prototypeValues != null) {
</span><span class='uc' id='L582' title='5|5|5 - Total: 5'>            int id = prototypeValues.findId(name);
</span><span class='uc' id='L583' title='2|2|2 - Total: 2'>            if (id != 0) {
</span><span class='uc' id='L584' title='5|5|5 - Total: 5'>                return prototypeValues.getAttributes(id);
</span>            }
        }
<span class='uc' id='L587' title='4|4|4 - Total: 4'>        return super.getAttributes(name);
</span>    }

    @Override
    public void setAttributes(String name, int attributes)
    {
<span class='uc' id='L593' title='2|2|2 - Total: 2'>        ScriptableObject.checkValidAttributes(attributes);
</span><span class='uc' id='L594' title='4|4|4 - Total: 4'>        int info = findInstanceIdInfo(name);
</span><span class='upc' id='L595' title='1|1|1 - Total: 2'>        if (info != 0) {
</span><span class='nc' id='L596' title='0|0|0 - Total: 4'>            int id = (info & 0xFFFF);
</span><span class='nc' id='L597' title='0|0|0 - Total: 4'>            int currentAttributes = (info >>> 16);
</span><span class='nc' id='L598' title='0|0|0 - Total: 2'>            if (attributes != currentAttributes) {
</span><span class='nc' id='L599' title='0|0|0 - Total: 4'>                setInstanceIdAttributes(id, attributes);
</span>            }
<span class='nc' id='L601' title='0|0|0 - Total: 1'>            return;
</span>        }
<span class='uc' id='L603' title='2|2|2 - Total: 2'>        if (prototypeValues != null) {
</span><span class='uc' id='L604' title='5|5|5 - Total: 5'>            int id = prototypeValues.findId(name);
</span><span class='upc' id='L605' title='1|1|1 - Total: 2'>            if (id != 0) {
</span><span class='nc' id='L606' title='0|0|0 - Total: 5'>                prototypeValues.setAttributes(id, attributes);
</span><span class='nc' id='L607' title='0|0|0 - Total: 1'>                return;
</span>            }
        }
<span class='uc' id='L610' title='4|4|4 - Total: 4'>        super.setAttributes(name, attributes);
</span><span class='uc' id='L611' title='1|1|1 - Total: 1'>    }
</span>
    @Override
    Object[] getIds(boolean getNonEnumerable, boolean getSymbols)
    {
<span class='uc' id='L616' title='5|5|5 - Total: 5'>        Object[] result = super.getIds(getNonEnumerable, getSymbols);
</span>
<span class='uc' id='L618' title='2|2|2 - Total: 2'>        if (prototypeValues != null) {
</span><span class='uc' id='L619' title='6|6|6 - Total: 6'>            result = prototypeValues.getNames(getNonEnumerable, result);
</span>        }

<span class='uc' id='L622' title='3|3|3 - Total: 3'>        int maxInstanceId = getMaxInstanceId();
</span><span class='uc' id='L623' title='2|2|2 - Total: 2'>        if (maxInstanceId != 0) {
</span><span class='uc' id='L624' title='2|2|2 - Total: 2'>            Object[] ids = null;
</span><span class='uc' id='L625' title='2|2|2 - Total: 2'>            int count = 0;
</span>
<span class='uc' id='L627' title='2|2|2 - Total: 2'>            for (int id = maxInstanceId; id != 0; --id) {
</span><span class='uc' id='L628' title='4|4|4 - Total: 4'>                String name = getInstanceIdName(id);
</span><span class='uc' id='L629' title='4|4|4 - Total: 4'>                int info = findInstanceIdInfo(name);
</span><span class='uc' id='L630' title='2|2|2 - Total: 2'>                if (info != 0) {
</span><span class='uc' id='L631' title='4|4|4 - Total: 4'>                    int attr = (info >>> 16);
</span><span class='uc' id='L632' title='2|2|2 - Total: 2'>                    if ((attr & PERMANENT) == 0) {
</span><span class='uc' id='L633' title='2|2|2 - Total: 2'>                        if (NOT_FOUND == getInstanceIdValue(id)) {
</span><span class='uc' id='L634' title='1|1|1 - Total: 1'>                            continue;
</span>                        }
                    }
<span class='uc' id='L637' title='4|4|4 - Total: 4'>                    if (getNonEnumerable || (attr & DONTENUM) == 0) {
</span><span class='uc' id='L638' title='2|2|2 - Total: 2'>                        if (count == 0) {
</span>                            // Need extra room for no more then [1..id] names
<span class='uc' id='L640' title='3|3|3 - Total: 3'>                            ids = new Object[id];
</span>                        }
<span class='uc' id='L642' title='5|5|5 - Total: 5'>                        ids[count++] = name;
</span>                    }
                }
            }
<span class='uc' id='L646' title='2|2|2 - Total: 2'>            if (count != 0) {
</span><span class='upc' id='L647' title='3|3|3 - Total: 4'>                if (result.length == 0 && ids.length == count) {
</span><span class='uc' id='L648' title='3|3|3 - Total: 3'>                    result = ids;
</span>                }
                else {
<span class='uc' id='L651' title='6|6|6 - Total: 6'>                    Object[] tmp = new Object[result.length + count];
</span><span class='uc' id='L652' title='7|7|7 - Total: 7'>                    System.arraycopy(result, 0, tmp, 0, result.length);
</span><span class='uc' id='L653' title='7|7|7 - Total: 7'>                    System.arraycopy(ids, 0, tmp, result.length, count);
</span><span class='uc' id='L654' title='2|2|2 - Total: 2'>                    result = tmp;
</span>                }
            }
        }
<span class='uc' id='L658' title='2|2|2 - Total: 2'>        return result;
</span>    }

    /**
     * Get maximum id findInstanceIdInfo can generate.
     */
    protected int getMaxInstanceId()
    {
<span class='uc' id='L666' title='2|2|2 - Total: 2'>        return 0;
</span>    }

    protected static int instanceIdInfo(int attributes, int id)
    {
<span class='uc' id='L671' title='6|6|6 - Total: 6'>        return (attributes << 16) | id;
</span>    }

    /**
     * Map name to id of instance property.
     * Should return 0 if not found or the result of
     * {@link #instanceIdInfo(int, int)}.
     */
    protected int findInstanceIdInfo(String name)
    {
<span class='uc' id='L681' title='2|2|2 - Total: 2'>        return 0;
</span>    }

    /**
     * Map name to id of instance property.
     * Should return 0 if not found or the result of
     * {@link #instanceIdInfo(int, int)}.
     */
    protected int findInstanceIdInfo(Symbol key)
    {
<span class='uc' id='L691' title='2|2|2 - Total: 2'>        return 0;
</span>    }

    /** Map id back to property name it defines.
     */
    protected String getInstanceIdName(int id)
    {
<span class='nc' id='L698' title='0|0|0 - Total: 6'>        throw new IllegalArgumentException(String.valueOf(id));
</span>    }

    /** Get id value.
     ** If id value is constant, descendant can call cacheIdValue to store
     ** value in the permanent cache.
     ** Default implementation creates IdFunctionObject instance for given id
     ** and cache its value
     */
    protected Object getInstanceIdValue(int id)
    {
<span class='nc' id='L709' title='0|0|0 - Total: 6'>        throw new IllegalStateException(String.valueOf(id));
</span>    }

    /**
     * Set or delete id value. If value == NOT_FOUND , the implementation
     * should make sure that the following getInstanceIdValue return NOT_FOUND.
     */
    protected void setInstanceIdValue(int id, Object value)
    {
<span class='nc' id='L718' title='0|0|0 - Total: 6'>        throw new IllegalStateException(String.valueOf(id));
</span>    }

    /**
     * Update the attributes of the given instance property. Classes which
     * want to support changing property attributes via Object.defineProperty
     * must override this method. The default implementation throws
     * InternalError.
     * @param id the instance property id
     * @param attr the new attribute bitset
     */
    protected void setInstanceIdAttributes(int id, int attr) {
<span class='nc' id='L730' title='0|0|0 - Total: 9'>        throw ScriptRuntime.constructError("InternalError",
</span><span class='nc' id='L731' title='0|0|0 - Total: 6'>                "Changing attributes not supported for " + getClassName()
</span><span class='nc' id='L732' title='0|0|0 - Total: 5'>                + " " + getInstanceIdName(id) + " property");
</span>    }

    /** 'thisObj' will be null if invoked as constructor, in which case
     ** instance of Scriptable should be returned. */
    public Object execIdCall(IdFunctionObject f, Context cx, Scriptable scope,
                             Scriptable thisObj, Object[] args)
    {
<span class='nc' id='L740' title='0|0|0 - Total: 3'>        throw f.unknown();
</span>    }

    public final IdFunctionObject exportAsJSClass(int maxPrototypeId,
                                                  Scriptable scope,
                                                  boolean sealed)
    {
        // Set scope and prototype unless this is top level scope itself
<span class='upc' id='L748' title='3|3|3 - Total: 4'>        if (scope != this && scope != null) {
</span><span class='uc' id='L749' title='3|3|3 - Total: 3'>            setParentScope(scope);
</span><span class='uc' id='L750' title='4|4|4 - Total: 4'>            setPrototype(getObjectPrototype(scope));
</span>        }

<span class='uc' id='L753' title='3|3|3 - Total: 3'>        activatePrototypeMap(maxPrototypeId);
</span><span class='uc' id='L754' title='4|4|4 - Total: 4'>        IdFunctionObject ctor = prototypeValues.createPrecachedConstructor();
</span><span class='uc' id='L755' title='2|2|2 - Total: 2'>        if (sealed) {
</span><span class='uc' id='L756' title='2|2|2 - Total: 2'>            sealObject();
</span>        }
<span class='uc' id='L758' title='3|3|3 - Total: 3'>        fillConstructorProperties(ctor);
</span><span class='uc' id='L759' title='2|2|2 - Total: 2'>        if (sealed) {
</span><span class='uc' id='L760' title='2|2|2 - Total: 2'>            ctor.sealObject();
</span>        }
<span class='uc' id='L762' title='2|2|2 - Total: 2'>        ctor.exportAsScopeProperty();
</span><span class='uc' id='L763' title='2|2|2 - Total: 2'>        return ctor;
</span>    }

    public final boolean hasPrototypeMap()
    {
<span class='nc' id='L768' title='0|0|0 - Total: 2'>        return prototypeValues != null;
</span>    }

    public final void activatePrototypeMap(int maxPrototypeId)
    {
<span class='uc' id='L773' title='6|6|6 - Total: 6'>        PrototypeValues values = new PrototypeValues(this, maxPrototypeId);
</span><span class='uc' id='L774' title='4|4|4 - Total: 4'>        synchronized (this) {
</span><span class='upc' id='L775' title='1|1|1 - Total: 2'>            if (prototypeValues != null)
</span><span class='nc' id='L776' title='0|0|0 - Total: 4'>                throw new IllegalStateException();
</span><span class='uc' id='L777' title='3|3|3 - Total: 3'>            prototypeValues = values;
</span><span class='upc' id='L778' title='3|3|3 - Total: 8'>        }
</span><span class='uc' id='L779' title='1|1|1 - Total: 1'>    }
</span>
    public final IdFunctionObject initPrototypeMethod(Object tag, int id, String name,
                                          int arity)
    {
<span class='uc' id='L784' title='8|8|8 - Total: 8'>        return initPrototypeMethod(tag, id, name, name, arity);
</span>    }

    public final IdFunctionObject initPrototypeMethod(Object tag, int id, String propertyName, String functionName,
                                          int arity)
    {
<span class='uc' id='L790' title='3|3|3 - Total: 3'>        Scriptable scope = ScriptableObject.getTopLevelScope(this);
</span><span class='uc' id='L791' title='2|2|2 - Total: 2'>        IdFunctionObject function = newIdFunction(tag, id,
</span>            functionName != null ? functionName : propertyName,
            arity, scope);
<span class='uc' id='L794' title='7|7|7 - Total: 7'>        prototypeValues.initValue(id, propertyName, function, DONTENUM);
</span><span class='uc' id='L795' title='2|2|2 - Total: 2'>        return function;
</span>    }

    public final IdFunctionObject initPrototypeMethod(Object tag, int id, Symbol key, String functionName,
                                          int arity)
    {
<span class='uc' id='L801' title='3|3|3 - Total: 3'>        Scriptable scope = ScriptableObject.getTopLevelScope(this);
</span><span class='uc' id='L802' title='8|8|8 - Total: 8'>        IdFunctionObject function = newIdFunction(tag, id, functionName, arity, scope);
</span><span class='uc' id='L803' title='7|7|7 - Total: 7'>        prototypeValues.initValue(id, key, function, DONTENUM);
</span><span class='uc' id='L804' title='2|2|2 - Total: 2'>        return function;
</span>    }

    public final void initPrototypeConstructor(IdFunctionObject f)
    {
<span class='uc' id='L809' title='4|4|4 - Total: 4'>        int id = prototypeValues.constructorId;
</span><span class='upc' id='L810' title='1|1|1 - Total: 2'>        if (id == 0)
</span><span class='nc' id='L811' title='0|0|0 - Total: 4'>            throw new IllegalStateException();
</span><span class='upc' id='L812' title='1|1|1 - Total: 2'>        if (f.methodId() != id)
</span><span class='nc' id='L813' title='0|0|0 - Total: 4'>            throw new IllegalArgumentException();
</span><span class='upc' id='L814' title='1|1|1 - Total: 2'>        if (isSealed()) { f.sealObject(); }
</span><span class='uc' id='L815' title='7|7|7 - Total: 7'>        prototypeValues.initValue(id, "constructor", f, DONTENUM);
</span><span class='uc' id='L816' title='1|1|1 - Total: 1'>    }
</span>
    public final void initPrototypeValue(int id, String name, Object value,
                                         int attributes)
    {
<span class='uc' id='L821' title='7|7|7 - Total: 7'>        prototypeValues.initValue(id, name, value, attributes);
</span><span class='uc' id='L822' title='1|1|1 - Total: 1'>    }
</span>
    public final void initPrototypeValue(int id, Symbol key, Object value,
                                         int attributes)
    {
<span class='uc' id='L827' title='7|7|7 - Total: 7'>        prototypeValues.initValue(id, key, value, attributes);
</span><span class='uc' id='L828' title='1|1|1 - Total: 1'>    }
</span>
    protected void initPrototypeId(int id)
    {
<span class='nc' id='L832' title='0|0|0 - Total: 6'>        throw new IllegalStateException(String.valueOf(id));
</span>    }

    protected int findPrototypeId(String name)
    {
<span class='nc' id='L837' title='0|0|0 - Total: 5'>        throw new IllegalStateException(name);
</span>    }

    protected int findPrototypeId(Symbol key)
    {
<span class='uc' id='L842' title='2|2|2 - Total: 2'>        return 0;
</span>    }

    protected void fillConstructorProperties(IdFunctionObject ctor)
    {
<span class='uc' id='L847' title='1|1|1 - Total: 1'>    }
</span>
    protected void addIdFunctionProperty(Scriptable obj, Object tag, int id,
                                         String name, int arity)
    {
<span class='uc' id='L852' title='3|3|3 - Total: 3'>        Scriptable scope = ScriptableObject.getTopLevelScope(obj);
</span><span class='uc' id='L853' title='8|8|8 - Total: 8'>        IdFunctionObject f = newIdFunction(tag, id, name, arity, scope);
</span><span class='uc' id='L854' title='3|3|3 - Total: 3'>        f.addAsProperty(obj);
</span><span class='uc' id='L855' title='1|1|1 - Total: 1'>    }
</span>
    /**
     * Utility method to construct type error to indicate incompatible call
     * when converting script thisObj to a particular type is not possible.
     * Possible usage would be to have a private function like realThis:
     * <pre>
     *  private static NativeSomething realThis(Scriptable thisObj,
     *                                          IdFunctionObject f)
     *  {
     *      if (!(thisObj instanceof NativeSomething))
     *          throw incompatibleCallError(f);
     *      return (NativeSomething)thisObj;
     * }
     * </pre>
     * Note that although such function can be implemented universally via
     * java.lang.Class.isInstance(), it would be much more slower.
     * @param f function that is attempting to convert 'this'
     * object.
     * @return Scriptable object suitable for a check by the instanceof
     * operator.
     * @throws RuntimeException if no more instanceof target can be found
     */
    protected static EcmaError incompatibleCallError(IdFunctionObject f)
    {
<span class='uc' id='L880' title='4|4|4 - Total: 4'>        throw ScriptRuntime.typeError1("msg.incompat.call",
</span><span class='uc' id='L881' title='1|1|1 - Total: 1'>                                       f.getFunctionName());
</span>    }

    private IdFunctionObject newIdFunction(Object tag, int id, String name,
                                           int arity, Scriptable scope)
    {
<span class='uc' id='L887' title='2|2|2 - Total: 2'>        IdFunctionObject function = null;
</span><span class='uc' id='L888' title='2|2|2 - Total: 2'>        if (Context.getContext().getLanguageVersion() < Context.VERSION_ES6) {
</span><span class='uc' id='L889' title='11|11|11 - Total: 11'>            function = new IdFunctionObject(this, tag, id, name, arity, scope);
</span>        } else {
<span class='uc' id='L891' title='10|10|10 - Total: 10'>            function = new IdFunctionObjectES6(this, tag, id, name, arity, scope);
</span>        }

<span class='uc' id='L894' title='2|2|2 - Total: 2'>        if (isSealed()) { function.sealObject(); }
</span><span class='uc' id='L895' title='2|2|2 - Total: 2'>        return function;
</span>    }

    @Override
    public void defineOwnProperty(Context cx, Object key, ScriptableObject desc) {
<span class='uc' id='L900' title='2|2|2 - Total: 2'>      if (key instanceof String) {
</span><span class='uc' id='L901' title='3|3|3 - Total: 3'>        String name = (String) key;
</span><span class='uc' id='L902' title='4|4|4 - Total: 4'>        int info = findInstanceIdInfo(name);
</span><span class='upc' id='L903' title='1|1|1 - Total: 2'>        if (info != 0) {
</span><span class='nc' id='L904' title='0|0|0 - Total: 4'>            int id = (info & 0xFFFF);
</span><span class='nc' id='L905' title='0|0|0 - Total: 2'>            if (isAccessorDescriptor(desc)) {
</span><span class='nc' id='L906' title='0|0|0 - Total: 4'>              delete(id); // it will be replaced with a slot
</span>            } else {
<span class='nc' id='L908' title='0|0|0 - Total: 3'>              checkPropertyDefinition(desc);
</span><span class='nc' id='L909' title='0|0|0 - Total: 5'>              ScriptableObject current = getOwnPropertyDescriptor(cx, key);
</span><span class='nc' id='L910' title='0|0|0 - Total: 5'>              checkPropertyChange(name, current, desc);
</span><span class='nc' id='L911' title='0|0|0 - Total: 4'>              int attr = (info >>> 16);
</span><span class='nc' id='L912' title='0|0|0 - Total: 4'>              Object value = getProperty(desc, "value");
</span><span class='nc' id='L913' title='0|0|0 - Total: 4'>              if (value != NOT_FOUND && (attr & READONLY) == 0) {
</span><span class='nc' id='L914' title='0|0|0 - Total: 4'>                Object currentValue = getInstanceIdValue(id);
</span><span class='nc' id='L915' title='0|0|0 - Total: 2'>                if (!sameValue(value, currentValue)) {
</span><span class='nc' id='L916' title='0|0|0 - Total: 4'>                  setInstanceIdValue(id, value);
</span>                }
              }
<span class='nc' id='L919' title='0|0|0 - Total: 7'>              setAttributes(name, applyDescriptorToAttributeBitset(attr, desc));
</span><span class='nc' id='L920' title='0|0|0 - Total: 1'>              return;
</span>            }
        }
<span class='uc' id='L923' title='2|2|2 - Total: 2'>        if (prototypeValues != null) {
</span><span class='uc' id='L924' title='5|5|5 - Total: 5'>            int id = prototypeValues.findId(name);
</span><span class='uc' id='L925' title='2|2|2 - Total: 2'>            if (id != 0) {
</span><span class='uc' id='L926' title='2|2|2 - Total: 2'>              if (isAccessorDescriptor(desc)) {
</span><span class='uc' id='L927' title='5|5|5 - Total: 5'>                prototypeValues.delete(id); // it will be replaced with a slot
</span>              } else {
<span class='uc' id='L929' title='3|3|3 - Total: 3'>                checkPropertyDefinition(desc);
</span><span class='uc' id='L930' title='5|5|5 - Total: 5'>                ScriptableObject current = getOwnPropertyDescriptor(cx, key);
</span><span class='uc' id='L931' title='5|5|5 - Total: 5'>                checkPropertyChange(name, current, desc);
</span><span class='uc' id='L932' title='5|5|5 - Total: 5'>                int attr = prototypeValues.getAttributes(id);
</span><span class='uc' id='L933' title='4|4|4 - Total: 4'>                Object value = getProperty(desc, "value");
</span><span class='upc' id='L934' title='2|2|2 - Total: 4'>                if (value != NOT_FOUND && (attr & READONLY) == 0) {
</span><span class='uc' id='L935' title='5|5|5 - Total: 5'>                  Object currentValue = prototypeValues.get(id);
</span><span class='upc' id='L936' title='1|1|1 - Total: 2'>                  if (!sameValue(value, currentValue)) {
</span><span class='uc' id='L937' title='6|6|6 - Total: 6'>                    prototypeValues.set(id, this, value);
</span>                  }
                }
<span class='uc' id='L940' title='8|8|8 - Total: 8'>                prototypeValues.setAttributes(id, applyDescriptorToAttributeBitset(attr, desc));
</span><span class='uc' id='L941' title='1|1|1 - Total: 1'>                return;
</span>              }
            }
        }
      }
<span class='uc' id='L946' title='5|5|5 - Total: 5'>      super.defineOwnProperty(cx, key, desc);
</span><span class='uc' id='L947' title='1|1|1 - Total: 1'>    }
</span>

    @Override
    protected ScriptableObject getOwnPropertyDescriptor(Context cx, Object id) {
<span class='uc' id='L952' title='5|5|5 - Total: 5'>      ScriptableObject desc = super.getOwnPropertyDescriptor(cx, id);
</span><span class='uc' id='L953' title='2|2|2 - Total: 2'>      if (desc == null) {
</span><span class='uc' id='L954' title='2|2|2 - Total: 2'>          if (id instanceof String) {
</span><span class='uc' id='L955' title='6|6|6 - Total: 6'>              desc = getBuiltInDescriptor((String) id);
</span><span class='uc' id='L956' title='2|2|2 - Total: 2'>          } else if (ScriptRuntime.isSymbol(id)) {
</span><span class='uc' id='L957' title='6|6|6 - Total: 6'>              desc = getBuiltInDescriptor(((NativeSymbol)id).getKey());
</span>          }
      }
<span class='uc' id='L960' title='2|2|2 - Total: 2'>      return desc;
</span>    }

    private ScriptableObject getBuiltInDescriptor(String name) {
<span class='uc' id='L964' title='2|2|2 - Total: 2'>      Object value = null;
</span><span class='uc' id='L965' title='2|2|2 - Total: 2'>      int attr = EMPTY;
</span>
<span class='uc' id='L967' title='3|3|3 - Total: 3'>      Scriptable scope = getParentScope();
</span><span class='upc' id='L968' title='1|1|1 - Total: 2'>      if (scope == null) {
</span><span class='nc' id='L969' title='0|0|0 - Total: 2'>        scope = this;
</span>      }

<span class='uc' id='L972' title='4|4|4 - Total: 4'>      int info = findInstanceIdInfo(name);
</span><span class='uc' id='L973' title='2|2|2 - Total: 2'>      if (info != 0) {
</span><span class='uc' id='L974' title='4|4|4 - Total: 4'>        int id = (info & 0xFFFF);
</span><span class='uc' id='L975' title='4|4|4 - Total: 4'>        value = getInstanceIdValue(id);
</span><span class='uc' id='L976' title='4|4|4 - Total: 4'>        attr = (info >>> 16);
</span><span class='uc' id='L977' title='5|5|5 - Total: 5'>        return buildDataDescriptor(scope, value, attr);
</span>      }
<span class='uc' id='L979' title='2|2|2 - Total: 2'>      if (prototypeValues != null) {
</span><span class='uc' id='L980' title='5|5|5 - Total: 5'>        int id = prototypeValues.findId(name);
</span><span class='upc' id='L981' title='1|1|1 - Total: 2'>        if (id != 0) {
</span><span class='uc' id='L982' title='5|5|5 - Total: 5'>          value = prototypeValues.get(id);
</span><span class='uc' id='L983' title='5|5|5 - Total: 5'>          attr = prototypeValues.getAttributes(id);
</span><span class='uc' id='L984' title='5|5|5 - Total: 5'>          return buildDataDescriptor(scope, value, attr);
</span>        }
      }
<span class='uc' id='L987' title='2|2|2 - Total: 2'>      return null;
</span>    }

    private ScriptableObject getBuiltInDescriptor(Symbol key) {
<span class='uc' id='L991' title='2|2|2 - Total: 2'>      Object value = null;
</span><span class='uc' id='L992' title='2|2|2 - Total: 2'>      int attr = EMPTY;
</span>
<span class='uc' id='L994' title='3|3|3 - Total: 3'>      Scriptable scope = getParentScope();
</span><span class='upc' id='L995' title='1|1|1 - Total: 2'>      if (scope == null) {
</span><span class='nc' id='L996' title='0|0|0 - Total: 2'>        scope = this;
</span>      }

<span class='upc' id='L999' title='1|1|1 - Total: 2'>      if (prototypeValues != null) {
</span><span class='nc' id='L1000' title='0|0|0 - Total: 5'>        int id = prototypeValues.findId(key);
</span><span class='nc' id='L1001' title='0|0|0 - Total: 2'>        if (id != 0) {
</span><span class='nc' id='L1002' title='0|0|0 - Total: 5'>          value = prototypeValues.get(id);
</span><span class='nc' id='L1003' title='0|0|0 - Total: 5'>          attr = prototypeValues.getAttributes(id);
</span><span class='nc' id='L1004' title='0|0|0 - Total: 5'>          return buildDataDescriptor(scope, value, attr);
</span>        }
      }
<span class='uc' id='L1007' title='2|2|2 - Total: 2'>      return null;
</span>    }

    private void readObject(ObjectInputStream stream)
        throws IOException, ClassNotFoundException
    {
<span class='uc' id='L1013' title='2|2|2 - Total: 2'>        stream.defaultReadObject();
</span><span class='uc' id='L1014' title='3|3|3 - Total: 3'>        int maxPrototypeId = stream.readInt();
</span><span class='uc' id='L1015' title='2|2|2 - Total: 2'>        if (maxPrototypeId != 0) {
</span><span class='uc' id='L1016' title='3|3|3 - Total: 3'>            activatePrototypeMap(maxPrototypeId);
</span>        }
<span class='uc' id='L1018' title='1|1|1 - Total: 1'>    }
</span>
    private void writeObject(ObjectOutputStream stream)
        throws IOException
    {
<span class='uc' id='L1023' title='2|2|2 - Total: 2'>        stream.defaultWriteObject();
</span><span class='uc' id='L1024' title='2|2|2 - Total: 2'>        int maxPrototypeId = 0;
</span><span class='uc' id='L1025' title='2|2|2 - Total: 2'>        if (prototypeValues != null) {
</span><span class='uc' id='L1026' title='4|4|4 - Total: 4'>            maxPrototypeId = prototypeValues.getMaxId();
</span>        }
<span class='uc' id='L1028' title='3|3|3 - Total: 3'>        stream.writeInt(maxPrototypeId);
</span><span class='uc' id='L1029' title='1|1|1 - Total: 1'>    }
</span>
}

</pre></body></html><table class='legend'><tr><td class='nc'>Not Covered</td><td class='ac'>Covered by test suite 1</td><td class='bc'>Covered by test suite 2</td><td class='uc'>Covered by the union test suite</td><td class='apc'>Partially Covered by test suite 1</td><td class='bpc'>Partially Covered by test suite 2</td><td class='upc'>Partially Covered by the union test suite</td></tr></table>