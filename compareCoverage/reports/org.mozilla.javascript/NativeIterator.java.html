<?xml version='1.0' encoding='UTF-8'?><!DOCTYPE html PUBLIC '-//W3C//DTD XHTML 1.0 Strict//EN' 'http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd'><html xmlns='http://www.w3.org/1999/xhtml' lang='en'><head><meta http-equiv='Content-Type' content='text/html;charset=UTF-8'/><title>org.mozilla.javascript.NativeIterator.java</title><link rel='stylesheet' href='../.resources/report.css' type='text/css'/><link rel='stylesheet' href='../.resources/prettify.css' type='text/css'/><link rel='stylesheet' href='../.resources/custom.css' type='text/css'/><script type='text/javascript' src='../.resources/prettify.js'></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><h1>org.mozilla.javascript.NativeIterator.java</h1><table class='legend'><tr><td class='nc'>Not Covered</td><td class='ac'>Covered by test suite 1</td><td class='bc'>Covered by test suite 2</td><td class='uc'>Covered by the union test suite</td><td class='apc'>Partially Covered by test suite 1</td><td class='bpc'>Partially Covered by test suite 2</td><td class='upc'>Partially Covered by the union test suite</td></tr></table><pre class='source lang-java linenums'>/* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-
 *
 * This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at http://mozilla.org/MPL/2.0/. */

package org.mozilla.javascript;

import java.util.Iterator;

/**
 * This class implements iterator objects. See
 * http://developer.mozilla.org/en/docs/New_in_JavaScript_1.7#Iterators
 *
 * @author Norris Boyd
 */
public final class NativeIterator extends IdScriptableObject {
    private static final long serialVersionUID = -4136968203581667681L;
<span class='uc' id='L19' title='3|3|3 - Total: 3'>    private static final Object ITERATOR_TAG = "Iterator";
</span>
    static void init(ScriptableObject scope, boolean sealed) {
        // Iterator
<span class='uc' id='L23' title='4|4|4 - Total: 4'>        NativeIterator iterator = new NativeIterator();
</span><span class='uc' id='L24' title='6|6|6 - Total: 6'>        iterator.exportAsJSClass(MAX_PROTOTYPE_ID, scope, sealed);
</span>
        // Generator
<span class='uc' id='L27' title='4|4|4 - Total: 4'>        NativeGenerator.init(scope, sealed);
</span>
        // StopIteration
<span class='uc' id='L30' title='4|4|4 - Total: 4'>        NativeObject obj = new StopIteration();
</span><span class='uc' id='L31' title='4|4|4 - Total: 4'>        obj.setPrototype(getObjectPrototype(scope));
</span><span class='uc' id='L32' title='3|3|3 - Total: 3'>        obj.setParentScope(scope);
</span><span class='uc' id='L33' title='2|2|2 - Total: 2'>        if (sealed) { obj.sealObject(); }
</span><span class='uc' id='L34' title='5|5|5 - Total: 5'>        ScriptableObject.defineProperty(scope, STOP_ITERATION, obj,
</span>                                        ScriptableObject.DONTENUM);
        // Use "associateValue" so that generators can continue to
        // throw StopIteration even if the property of the global
        // scope is replaced or deleted.
<span class='uc' id='L39' title='5|5|5 - Total: 5'>        scope.associateValue(ITERATOR_TAG, obj);
</span><span class='uc' id='L40' title='1|1|1 - Total: 1'>    }
</span>
    /**
     * Only for constructing the prototype object.
     */
<span class='uc' id='L45' title='2|2|2 - Total: 2'>    private NativeIterator() {
</span><span class='uc' id='L46' title='1|1|1 - Total: 1'>    }
</span>
<span class='uc' id='L48' title='2|2|2 - Total: 2'>    private NativeIterator(Object objectIterator) {
</span><span class='uc' id='L49' title='3|3|3 - Total: 3'>      this.objectIterator = objectIterator;
</span><span class='uc' id='L50' title='1|1|1 - Total: 1'>    }
</span>
    /**
     * Get the value of the "StopIteration" object. Note that this value
     * is stored in the top-level scope using "associateValue" so the
     * value can still be found even if a script overwrites or deletes
     * the global "StopIteration" property.
     * @param scope a scope whose parent chain reaches a top-level scope
     * @return the StopIteration object
     */
    public static Object getStopIterationObject(Scriptable scope) {
<span class='uc' id='L61' title='3|3|3 - Total: 3'>        Scriptable top = ScriptableObject.getTopLevelScope(scope);
</span><span class='uc' id='L62' title='4|4|4 - Total: 4'>        return ScriptableObject.getTopScopeValue(top, ITERATOR_TAG);
</span>    }

    private static final String STOP_ITERATION = "StopIteration";
    public static final String ITERATOR_PROPERTY_NAME = "__iterator__";

    static class StopIteration extends NativeObject {
        private static final long serialVersionUID = 2485151085722377663L;

        @Override
        public String getClassName() {
            return STOP_ITERATION;
        }

        /* StopIteration has custom instanceof behavior since it
         * doesn't have a constructor.
         */
        @Override
        public boolean hasInstance(Scriptable instance) {
            return instance instanceof StopIteration;
        }
    }

    @Override
    public String getClassName() {
<span class='uc' id='L87' title='2|2|2 - Total: 2'>        return "Iterator";
</span>    }

    @Override
    protected void initPrototypeId(int id) {
        String s;
        int arity;
<span class='upc' id='L94' title='3|3|3 - Total: 4'>        switch (id) {
</span><span class='uc' id='L95' title='5|5|5 - Total: 5'>          case Id_constructor:    arity=2; s="constructor";          break;
</span><span class='uc' id='L96' title='5|5|5 - Total: 5'>          case Id_next:           arity=0; s="next";                 break;
</span><span class='uc' id='L97' title='5|5|5 - Total: 5'>          case Id___iterator__:   arity=1; s=ITERATOR_PROPERTY_NAME; break;
</span><span class='nc' id='L98' title='0|0|0 - Total: 6'>          default: throw new IllegalArgumentException(String.valueOf(id));
</span>        }
<span class='uc' id='L100' title='7|7|7 - Total: 7'>        initPrototypeMethod(ITERATOR_TAG, id, s, arity);
</span><span class='uc' id='L101' title='1|1|1 - Total: 1'>    }
</span>
    @Override
    public Object execIdCall(IdFunctionObject f, Context cx, Scriptable scope,
                             Scriptable thisObj, Object[] args)
    {
<span class='upc' id='L107' title='1|1|1 - Total: 2'>        if (!f.hasTag(ITERATOR_TAG)) {
</span><span class='nc' id='L108' title='0|0|0 - Total: 8'>            return super.execIdCall(f, cx, scope, thisObj, args);
</span>        }
<span class='uc' id='L110' title='3|3|3 - Total: 3'>        int id = f.methodId();
</span>
<span class='uc' id='L112' title='2|2|2 - Total: 2'>        if (id == Id_constructor) {
</span><span class='uc' id='L113' title='6|6|6 - Total: 6'>            return jsConstructor(cx, scope, thisObj, args);
</span>        }

<span class='upc' id='L116' title='1|1|1 - Total: 2'>        if (!(thisObj instanceof NativeIterator))
</span><span class='nc' id='L117' title='0|0|0 - Total: 3'>            throw incompatibleCallError(f);
</span>
<span class='uc' id='L119' title='3|3|3 - Total: 3'>        NativeIterator iterator = (NativeIterator) thisObj;
</span>
<span class='upc' id='L121' title='2|2|2 - Total: 3'>        switch (id) {
</span>
          case Id_next:
<span class='uc' id='L124' title='5|5|5 - Total: 5'>            return iterator.next(cx, scope);
</span>
          case Id___iterator__:
            /// XXX: what about argument? SpiderMonkey apparently ignores it
<span class='uc' id='L128' title='2|2|2 - Total: 2'>            return thisObj;
</span>
          default:
<span class='nc' id='L131' title='0|0|0 - Total: 6'>            throw new IllegalArgumentException(String.valueOf(id));
</span>        }
    }

    /* The JavaScript constructor */
    private static Object jsConstructor(Context cx, Scriptable scope,
                                        Scriptable thisObj, Object[] args)
    {
<span class='upc' id='L139' title='3|3|3 - Total: 6'>        if (args.length == 0 || args[0] == null ||
</span>            args[0] == Undefined.instance)
        {
<span class='nc' id='L142' title='0|0|0 - Total: 2'>            Object argument = args.length == 0 ? Undefined.instance : args[0];
</span><span class='nc' id='L143' title='0|0|0 - Total: 4'>            throw ScriptRuntime.typeError1("msg.no.properties",
</span><span class='nc' id='L144' title='0|0|0 - Total: 1'>                                           ScriptRuntime.toString(argument));
</span>        }
<span class='uc' id='L146' title='7|7|7 - Total: 7'>        Scriptable obj = ScriptRuntime.toObject(cx, scope, args[0]);
</span><span class='uc' id='L147' title='4|4|4 - Total: 4'>        boolean keyOnly = args.length > 1 && ScriptRuntime.toBoolean(args[1]);
</span><span class='uc' id='L148' title='2|2|2 - Total: 2'>        if (thisObj != null) {
</span>            // Called as a function. Convert to iterator if possible.

            // For objects that implement java.lang.Iterable or
            // java.util.Iterator, have JavaScript Iterator call the underlying
            // iteration methods
<span class='uc' id='L154' title='4|4|4 - Total: 4'>            Iterator<?> iterator =
</span><span class='uc' id='L155' title='2|2|2 - Total: 2'>                VMBridge.instance.getJavaIterator(cx, scope, obj);
</span><span class='uc' id='L156' title='2|2|2 - Total: 2'>            if (iterator != null) {
</span><span class='uc' id='L157' title='3|3|3 - Total: 3'>                scope = ScriptableObject.getTopLevelScope(scope);
</span><span class='uc' id='L158' title='12|12|12 - Total: 12'>                return cx.getWrapFactory().wrap(cx, scope,
</span>                        new WrappedJavaIterator(iterator, scope),
                        WrappedJavaIterator.class);
            }

            // Otherwise, just call the runtime routine
<span class='uc' id='L164' title='6|6|6 - Total: 6'>            Scriptable jsIterator = ScriptRuntime.toIterator(cx, scope, obj,
</span>                                                             keyOnly);
<span class='uc' id='L166' title='2|2|2 - Total: 2'>            if (jsIterator != null) {
</span><span class='uc' id='L167' title='2|2|2 - Total: 2'>                return jsIterator;
</span>            }
        }

        // Otherwise, just set up to iterate over the properties of the object.
        // Do not call __iterator__ method.
<span class='uc' id='L173' title='2|2|2 - Total: 2'>        Object objectIterator = ScriptRuntime.enumInit(obj, cx, scope,
</span>            keyOnly ? ScriptRuntime.ENUMERATE_KEYS_NO_ITERATOR
                    : ScriptRuntime.ENUMERATE_ARRAY_NO_ITERATOR);
<span class='uc' id='L176' title='3|3|3 - Total: 3'>        ScriptRuntime.setEnumNumbers(objectIterator, true);
</span><span class='uc' id='L177' title='5|5|5 - Total: 5'>        NativeIterator result = new NativeIterator(objectIterator);
</span><span class='uc' id='L178' title='5|5|5 - Total: 5'>        result.setPrototype(ScriptableObject.getClassPrototype(scope,
</span><span class='uc' id='L179' title='1|1|1 - Total: 1'>                                result.getClassName()));
</span><span class='uc' id='L180' title='3|3|3 - Total: 3'>        result.setParentScope(scope);
</span><span class='uc' id='L181' title='2|2|2 - Total: 2'>        return result;
</span>    }

    private Object next(Context cx, Scriptable scope) {
<span class='uc' id='L185' title='4|4|4 - Total: 4'>        Boolean b = ScriptRuntime.enumNext(this.objectIterator);
</span><span class='uc' id='L186' title='2|2|2 - Total: 2'>        if (!b.booleanValue()) {
</span>            // Out of values. Throw StopIteration.
<span class='uc' id='L188' title='3|3|3 - Total: 3'>            throw new JavaScriptException(
</span><span class='uc' id='L189' title='5|5|5 - Total: 5'>                NativeIterator.getStopIterationObject(scope), null, 0);
</span>        }
<span class='uc' id='L191' title='5|5|5 - Total: 5'>        return ScriptRuntime.enumId(this.objectIterator, cx);
</span>    }

    static public class WrappedJavaIterator
    {
        WrappedJavaIterator(Iterator<?> iterator, Scriptable scope) {
            this.iterator = iterator;
            this.scope = scope;
        }

        public Object next() {
            if (!iterator.hasNext()) {
                // Out of values. Throw StopIteration.
                throw new JavaScriptException(
                    NativeIterator.getStopIterationObject(scope), null, 0);
            }
            return iterator.next();
        }

        public Object __iterator__(boolean b) {
            return this;
        }

        private Iterator<?> iterator;
        private Scriptable scope;
    }

// #string_id_map#

    @Override
    protected int findPrototypeId(String s) {
        int id;
// #generated# Last update: 2007-06-11 09:43:19 EDT
<span class='uc' id='L224' title='4|4|4 - Total: 4'>        L0: { id = 0; String X = null;
</span><span class='uc' id='L225' title='3|3|3 - Total: 3'>            int s_length = s.length();
</span><span class='uc' id='L226' title='2|2|2 - Total: 2'>            if (s_length==4) { X="next";id=Id_next; }
</span><span class='uc' id='L227' title='2|2|2 - Total: 2'>            else if (s_length==11) { X="constructor";id=Id_constructor; }
</span><span class='uc' id='L228' title='2|2|2 - Total: 2'>            else if (s_length==12) { X="__iterator__";id=Id___iterator__; }
</span><span class='upc' id='L229' title='5|5|5 - Total: 6'>            if (X!=null && X!=s && !X.equals(s)) id = 0;
</span>            break L0;
        }
// #/generated#
<span class='uc' id='L233' title='2|2|2 - Total: 2'>        return id;
</span>    }

    private static final int
        Id_constructor           = 1,
        Id_next                  = 2,
        Id___iterator__          = 3,
        MAX_PROTOTYPE_ID         = 3;

// #/string_id_map#

    private Object objectIterator;
}

</pre></body></html><table class='legend'><tr><td class='nc'>Not Covered</td><td class='ac'>Covered by test suite 1</td><td class='bc'>Covered by test suite 2</td><td class='uc'>Covered by the union test suite</td><td class='apc'>Partially Covered by test suite 1</td><td class='bpc'>Partially Covered by test suite 2</td><td class='upc'>Partially Covered by the union test suite</td></tr></table>