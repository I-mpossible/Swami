<?xml version='1.0' encoding='UTF-8'?><!DOCTYPE html PUBLIC '-//W3C//DTD XHTML 1.0 Strict//EN' 'http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd'><html xmlns='http://www.w3.org/1999/xhtml' lang='en'><head><meta http-equiv='Content-Type' content='text/html;charset=UTF-8'/><title>org.mozilla.javascript.ObjArray.java</title><link rel='stylesheet' href='../.resources/report.css' type='text/css'/><link rel='stylesheet' href='../.resources/prettify.css' type='text/css'/><link rel='stylesheet' href='../.resources/custom.css' type='text/css'/><script type='text/javascript' src='../.resources/prettify.js'></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><h1>org.mozilla.javascript.ObjArray.java</h1><table class='legend'><tr><td class='nc'>Not Covered</td><td class='ac'>Covered by test suite 1</td><td class='bc'>Covered by test suite 2</td><td class='uc'>Covered by the union test suite</td><td class='apc'>Partially Covered by test suite 1</td><td class='bpc'>Partially Covered by test suite 2</td><td class='upc'>Partially Covered by the union test suite</td></tr></table><pre class='source lang-java linenums'>/* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-
 *
 * This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at http://mozilla.org/MPL/2.0/. */

package org.mozilla.javascript;

import java.io.Serializable;
import java.io.IOException;
import java.io.ObjectInputStream;
import java.io.ObjectOutputStream;

/**
Implementation of resizable array with focus on minimizing memory usage by storing few initial array elements in object fields. Can also be used as a stack.
*/

public class ObjArray implements Serializable
{
    static final long serialVersionUID = 4174889037736658296L;

<span class='uc' id='L22' title='3|3|3 - Total: 3'>    public ObjArray() { }
</span>
    public final boolean isSealed()
    {
<span class='nc' id='L26' title='0|0|0 - Total: 3'>        return sealed;
</span>    }

    public final void seal()
    {
<span class='nc' id='L31' title='0|0|0 - Total: 3'>        sealed = true;
</span><span class='nc' id='L32' title='0|0|0 - Total: 1'>    }
</span>
    public final boolean isEmpty()
    {
<span class='uc' id='L36' title='2|2|2 - Total: 2'>        return size == 0;
</span>    }

    public final int size()
    {
<span class='uc' id='L41' title='3|3|3 - Total: 3'>        return size;
</span>    }

    public final void setSize(int newSize)
    {
<span class='nc' id='L46' title='0|0|0 - Total: 2'>        if (newSize < 0) throw new IllegalArgumentException();
</span><span class='nc' id='L47' title='0|0|0 - Total: 2'>        if (sealed) throw onSeledMutation();
</span><span class='nc' id='L48' title='0|0|0 - Total: 3'>        int N = size;
</span><span class='nc' id='L49' title='0|0|0 - Total: 2'>        if (newSize < N) {
</span><span class='nc' id='L50' title='0|0|0 - Total: 2'>            for (int i = newSize; i != N; ++i) {
</span><span class='nc' id='L51' title='0|0|0 - Total: 4'>                setImpl(i, null);
</span>            }
<span class='nc' id='L53' title='0|0|0 - Total: 2'>        } else if (newSize > N) {
</span><span class='nc' id='L54' title='0|0|0 - Total: 2'>            if (newSize > FIELDS_STORE_SIZE) {
</span><span class='nc' id='L55' title='0|0|0 - Total: 3'>                ensureCapacity(newSize);
</span>            }
        }
<span class='nc' id='L58' title='0|0|0 - Total: 3'>        size = newSize;
</span><span class='nc' id='L59' title='0|0|0 - Total: 1'>    }
</span>
    public final Object get(int index)
    {
<span class='upc' id='L63' title='2|2|2 - Total: 4'>        if (!(0 <= index && index < size)) throw onInvalidIndex(index, size);
</span><span class='uc' id='L64' title='4|4|4 - Total: 4'>        return getImpl(index);
</span>    }

    public final void set(int index, Object value)
    {
<span class='nc' id='L69' title='0|0|0 - Total: 4'>        if (!(0 <= index && index < size)) throw onInvalidIndex(index, size);
</span><span class='nc' id='L70' title='0|0|0 - Total: 2'>        if (sealed) throw onSeledMutation();
</span><span class='nc' id='L71' title='0|0|0 - Total: 4'>        setImpl(index, value);
</span><span class='nc' id='L72' title='0|0|0 - Total: 1'>    }
</span>
    private Object getImpl(int index)
    {
<span class='uc' id='L76' title='6|6|6 - Total: 6'>        switch (index) {
</span><span class='uc' id='L77' title='3|3|3 - Total: 3'>            case 0: return f0;
</span><span class='uc' id='L78' title='3|3|3 - Total: 3'>            case 1: return f1;
</span><span class='uc' id='L79' title='3|3|3 - Total: 3'>            case 2: return f2;
</span><span class='uc' id='L80' title='3|3|3 - Total: 3'>            case 3: return f3;
</span><span class='uc' id='L81' title='3|3|3 - Total: 3'>            case 4: return f4;
</span>        }
<span class='uc' id='L83' title='7|7|7 - Total: 7'>        return data[index - FIELDS_STORE_SIZE];
</span>    }

    private void setImpl(int index, Object value)
    {
<span class='uc' id='L88' title='6|6|6 - Total: 6'>        switch (index) {
</span><span class='uc' id='L89' title='4|4|4 - Total: 4'>            case 0: f0 = value; break;
</span><span class='uc' id='L90' title='4|4|4 - Total: 4'>            case 1: f1 = value; break;
</span><span class='uc' id='L91' title='4|4|4 - Total: 4'>            case 2: f2 = value; break;
</span><span class='uc' id='L92' title='4|4|4 - Total: 4'>            case 3: f3 = value; break;
</span><span class='uc' id='L93' title='4|4|4 - Total: 4'>            case 4: f4 = value; break;
</span><span class='uc' id='L94' title='7|7|7 - Total: 7'>            default: data[index - FIELDS_STORE_SIZE] = value;
</span>        }

<span class='uc' id='L97' title='1|1|1 - Total: 1'>    }
</span>
    public int indexOf(Object obj)
    {
<span class='nc' id='L101' title='0|0|0 - Total: 3'>        int N = size;
</span><span class='nc' id='L102' title='0|0|0 - Total: 2'>        for (int i = 0; i != N; ++i) {
</span><span class='nc' id='L103' title='0|0|0 - Total: 4'>            Object current = getImpl(i);
</span><span class='nc' id='L104' title='0|0|0 - Total: 6'>            if (current == obj || (current != null && current.equals(obj))) {
</span><span class='nc' id='L105' title='0|0|0 - Total: 2'>                return i;
</span>            }
        }
<span class='nc' id='L108' title='0|0|0 - Total: 2'>        return -1;
</span>    }

    public int lastIndexOf(Object obj)
    {
<span class='nc' id='L113' title='0|0|0 - Total: 2'>        for (int i = size; i != 0;) {
</span><span class='nc' id='L114' title='0|0|0 - Total: 1'>            --i;
</span><span class='nc' id='L115' title='0|0|0 - Total: 4'>            Object current = getImpl(i);
</span><span class='nc' id='L116' title='0|0|0 - Total: 6'>            if (current == obj || (current != null && current.equals(obj))) {
</span><span class='nc' id='L117' title='0|0|0 - Total: 2'>                return i;
</span>            }
<span class='nc' id='L119' title='0|0|0 - Total: 1'>        }
</span><span class='nc' id='L120' title='0|0|0 - Total: 2'>        return -1;
</span>    }

    public final Object peek()
    {
<span class='uc' id='L125' title='3|3|3 - Total: 3'>        int N = size;
</span><span class='upc' id='L126' title='1|1|1 - Total: 2'>        if (N == 0) throw onEmptyStackTopRead();
</span><span class='uc' id='L127' title='6|6|6 - Total: 6'>        return getImpl(N - 1);
</span>    }

    public final Object pop()
    {
<span class='upc' id='L132' title='1|1|1 - Total: 2'>        if (sealed) throw onSeledMutation();
</span><span class='uc' id='L133' title='3|3|3 - Total: 3'>        int N = size;
</span><span class='uc' id='L134' title='1|1|1 - Total: 1'>        --N;
</span>        Object top;
<span class='upc' id='L136' title='6|6|6 - Total: 7'>        switch (N) {
</span><span class='nc' id='L137' title='0|0|0 - Total: 2'>            case -1: throw onEmptyStackTopRead();
</span><span class='uc' id='L138' title='7|7|7 - Total: 7'>            case 0: top = f0; f0 = null; break;
</span><span class='uc' id='L139' title='7|7|7 - Total: 7'>            case 1: top = f1; f1 = null; break;
</span><span class='uc' id='L140' title='7|7|7 - Total: 7'>            case 2: top = f2; f2 = null; break;
</span><span class='uc' id='L141' title='7|7|7 - Total: 7'>            case 3: top = f3; f3 = null; break;
</span><span class='uc' id='L142' title='7|7|7 - Total: 7'>            case 4: top = f4; f4 = null; break;
</span>            default:
<span class='uc' id='L144' title='7|7|7 - Total: 7'>                top = data[N - FIELDS_STORE_SIZE];
</span><span class='uc' id='L145' title='7|7|7 - Total: 7'>                data[N - FIELDS_STORE_SIZE] = null;
</span>        }
<span class='uc' id='L147' title='3|3|3 - Total: 3'>        size = N;
</span><span class='uc' id='L148' title='2|2|2 - Total: 2'>        return top;
</span>    }

    public final void push(Object value)
    {
<span class='uc' id='L153' title='3|3|3 - Total: 3'>        add(value);
</span><span class='uc' id='L154' title='1|1|1 - Total: 1'>    }
</span>
    public final void add(Object value)
    {
<span class='upc' id='L158' title='1|1|1 - Total: 2'>        if (sealed) throw onSeledMutation();
</span><span class='uc' id='L159' title='3|3|3 - Total: 3'>        int N = size;
</span><span class='uc' id='L160' title='2|2|2 - Total: 2'>        if (N >= FIELDS_STORE_SIZE) {
</span><span class='uc' id='L161' title='5|5|5 - Total: 5'>            ensureCapacity(N + 1);
</span>        }
<span class='uc' id='L163' title='5|5|5 - Total: 5'>        size = N + 1;
</span><span class='uc' id='L164' title='4|4|4 - Total: 4'>        setImpl(N, value);
</span><span class='uc' id='L165' title='1|1|1 - Total: 1'>    }
</span>
    public final void add(int index, Object value)
    {
<span class='nc' id='L169' title='0|0|0 - Total: 3'>        int N = size;
</span><span class='nc' id='L170' title='0|0|0 - Total: 4'>        if (!(0 <= index && index <= N)) throw onInvalidIndex(index, N + 1);
</span><span class='nc' id='L171' title='0|0|0 - Total: 2'>        if (sealed) throw onSeledMutation();
</span>        Object tmp;
<span class='nc' id='L173' title='0|0|0 - Total: 6'>        switch (index) {
</span>            case 0:
<span class='nc' id='L175' title='0|0|0 - Total: 2'>                if (N == 0) { f0 = value; break; }
</span><span class='nc' id='L176' title='0|0|0 - Total: 8'>                tmp = f0; f0 = value; value = tmp;
</span>            /* fallthru */ case 1:
<span class='nc' id='L178' title='0|0|0 - Total: 2'>                if (N == 1) { f1 = value; break; }
</span><span class='nc' id='L179' title='0|0|0 - Total: 8'>                tmp = f1; f1 = value; value = tmp;
</span>            /* fallthru */ case 2:
<span class='nc' id='L181' title='0|0|0 - Total: 2'>                if (N == 2) { f2 = value; break; }
</span><span class='nc' id='L182' title='0|0|0 - Total: 8'>                tmp = f2; f2 = value; value = tmp;
</span>            /* fallthru */ case 3:
<span class='nc' id='L184' title='0|0|0 - Total: 2'>                if (N == 3) { f3 = value; break; }
</span><span class='nc' id='L185' title='0|0|0 - Total: 8'>                tmp = f3; f3 = value; value = tmp;
</span>            /* fallthru */ case 4:
<span class='nc' id='L187' title='0|0|0 - Total: 2'>                if (N == 4) { f4 = value; break; }
</span><span class='nc' id='L188' title='0|0|0 - Total: 8'>                tmp = f4; f4 = value; value = tmp;
</span>
<span class='nc' id='L190' title='0|0|0 - Total: 2'>                index = FIELDS_STORE_SIZE;
</span>            /* fallthru */ default:
<span class='nc' id='L192' title='0|0|0 - Total: 5'>                ensureCapacity(N + 1);
</span><span class='nc' id='L193' title='0|0|0 - Total: 2'>                if (index != N) {
</span><span class='nc' id='L194' title='0|0|0 - Total: 16'>                    System.arraycopy(data, index - FIELDS_STORE_SIZE,
</span>                                     data, index - FIELDS_STORE_SIZE + 1,
                                     N - index);
                }
<span class='nc' id='L198' title='0|0|0 - Total: 7'>                data[index - FIELDS_STORE_SIZE] = value;
</span>        }
<span class='nc' id='L200' title='0|0|0 - Total: 5'>        size = N + 1;
</span><span class='nc' id='L201' title='0|0|0 - Total: 1'>    }
</span>
    public final void remove(int index)
    {
<span class='nc' id='L205' title='0|0|0 - Total: 3'>        int N = size;
</span><span class='nc' id='L206' title='0|0|0 - Total: 4'>        if (!(0 <= index && index < N)) throw onInvalidIndex(index, N);
</span><span class='nc' id='L207' title='0|0|0 - Total: 2'>        if (sealed) throw onSeledMutation();
</span><span class='nc' id='L208' title='0|0|0 - Total: 1'>        --N;
</span><span class='nc' id='L209' title='0|0|0 - Total: 6'>        switch (index) {
</span>            case 0:
<span class='nc' id='L211' title='0|0|0 - Total: 2'>                if (N == 0) { f0 = null; break; }
</span><span class='nc' id='L212' title='0|0|0 - Total: 4'>                f0 = f1;
</span>            /* fallthru */ case 1:
<span class='nc' id='L214' title='0|0|0 - Total: 2'>                if (N == 1) { f1 = null; break; }
</span><span class='nc' id='L215' title='0|0|0 - Total: 4'>                f1 = f2;
</span>            /* fallthru */ case 2:
<span class='nc' id='L217' title='0|0|0 - Total: 2'>                if (N == 2) { f2 = null; break; }
</span><span class='nc' id='L218' title='0|0|0 - Total: 4'>                f2 = f3;
</span>            /* fallthru */ case 3:
<span class='nc' id='L220' title='0|0|0 - Total: 2'>                if (N == 3) { f3 = null; break; }
</span><span class='nc' id='L221' title='0|0|0 - Total: 4'>                f3 = f4;
</span>            /* fallthru */ case 4:
<span class='nc' id='L223' title='0|0|0 - Total: 2'>                if (N == 4) { f4 = null; break; }
</span><span class='nc' id='L224' title='0|0|0 - Total: 6'>                f4 = data[0];
</span>
<span class='nc' id='L226' title='0|0|0 - Total: 2'>                index = FIELDS_STORE_SIZE;
</span>            /* fallthru */ default:
<span class='nc' id='L228' title='0|0|0 - Total: 2'>                if (index != N) {
</span><span class='nc' id='L229' title='0|0|0 - Total: 16'>                    System.arraycopy(data, index - FIELDS_STORE_SIZE + 1,
</span>                                     data, index - FIELDS_STORE_SIZE,
                                     N - index);
                }
<span class='nc' id='L233' title='0|0|0 - Total: 7'>                data[N - FIELDS_STORE_SIZE] = null;
</span>        }
<span class='nc' id='L235' title='0|0|0 - Total: 3'>        size = N;
</span><span class='nc' id='L236' title='0|0|0 - Total: 1'>    }
</span>
    public final void clear()
    {
<span class='nc' id='L240' title='0|0|0 - Total: 2'>        if (sealed) throw onSeledMutation();
</span><span class='nc' id='L241' title='0|0|0 - Total: 3'>        int N = size;
</span><span class='nc' id='L242' title='0|0|0 - Total: 2'>        for (int i = 0; i != N; ++i) {
</span><span class='nc' id='L243' title='0|0|0 - Total: 4'>            setImpl(i, null);
</span>        }
<span class='nc' id='L245' title='0|0|0 - Total: 3'>        size = 0;
</span><span class='nc' id='L246' title='0|0|0 - Total: 1'>    }
</span>
    public final Object[] toArray()
    {
<span class='uc' id='L250' title='4|4|4 - Total: 4'>        Object[] array = new Object[size];
</span><span class='uc' id='L251' title='4|4|4 - Total: 4'>        toArray(array, 0);
</span><span class='uc' id='L252' title='2|2|2 - Total: 2'>        return array;
</span>    }

    public final void toArray(Object[] array)
    {
<span class='uc' id='L257' title='4|4|4 - Total: 4'>        toArray(array, 0);
</span><span class='uc' id='L258' title='1|1|1 - Total: 1'>    }
</span>
    public final void toArray(Object[] array, int offset)
    {
<span class='uc' id='L262' title='3|3|3 - Total: 3'>        int N = size;
</span><span class='uc' id='L263' title='7|7|7 - Total: 7'>        switch (N) {
</span>            default:
<span class='uc' id='L265' title='11|11|11 - Total: 11'>                System.arraycopy(data, 0, array, offset + FIELDS_STORE_SIZE,
</span>                                 N - FIELDS_STORE_SIZE);
<span class='uc' id='L267' title='7|7|7 - Total: 7'>            /* fallthru */ case 5: array[offset + 4] = f4;
</span><span class='uc' id='L268' title='7|7|7 - Total: 7'>            /* fallthru */ case 4: array[offset + 3] = f3;
</span><span class='uc' id='L269' title='7|7|7 - Total: 7'>            /* fallthru */ case 3: array[offset + 2] = f2;
</span><span class='uc' id='L270' title='7|7|7 - Total: 7'>            /* fallthru */ case 2: array[offset + 1] = f1;
</span><span class='uc' id='L271' title='7|7|7 - Total: 7'>            /* fallthru */ case 1: array[offset + 0] = f0;
</span>            /* fallthru */ case 0: break;
        }
<span class='uc' id='L274' title='1|1|1 - Total: 1'>    }
</span>
    private void ensureCapacity(int minimalCapacity)
    {
<span class='uc' id='L278' title='4|4|4 - Total: 4'>        int required = minimalCapacity - FIELDS_STORE_SIZE;
</span><span class='upc' id='L279' title='1|1|1 - Total: 2'>        if (required <= 0) throw new IllegalArgumentException();
</span><span class='uc' id='L280' title='2|2|2 - Total: 2'>        if (data == null) {
</span><span class='uc' id='L281' title='2|2|2 - Total: 2'>            int alloc = FIELDS_STORE_SIZE * 2;
</span><span class='upc' id='L282' title='1|1|1 - Total: 2'>            if (alloc < required) {
</span><span class='nc' id='L283' title='0|0|0 - Total: 2'>                alloc = required;
</span>            }
<span class='uc' id='L285' title='4|4|4 - Total: 4'>            data = new Object[alloc];
</span><span class='uc' id='L286' title='1|1|1 - Total: 1'>        } else {
</span><span class='uc' id='L287' title='4|4|4 - Total: 4'>            int alloc = data.length;
</span><span class='uc' id='L288' title='2|2|2 - Total: 2'>            if (alloc < required) {
</span><span class='upc' id='L289' title='1|1|1 - Total: 2'>                   if (alloc <= FIELDS_STORE_SIZE) {
</span><span class='nc' id='L290' title='0|0|0 - Total: 3'>                    alloc = FIELDS_STORE_SIZE * 2;
</span>                } else {
<span class='uc' id='L292' title='4|4|4 - Total: 4'>                    alloc *= 2;
</span>                }
<span class='upc' id='L294' title='1|1|1 - Total: 2'>                if (alloc < required) {
</span><span class='nc' id='L295' title='0|0|0 - Total: 2'>                    alloc = required;
</span>                }
<span class='uc' id='L297' title='3|3|3 - Total: 3'>                Object[] tmp = new Object[alloc];
</span><span class='upc' id='L298' title='1|1|1 - Total: 2'>                if (size > FIELDS_STORE_SIZE) {
</span><span class='uc' id='L299' title='10|10|10 - Total: 10'>                    System.arraycopy(data, 0, tmp, 0,
</span>                                     size - FIELDS_STORE_SIZE);
                }
<span class='uc' id='L302' title='3|3|3 - Total: 3'>                data = tmp;
</span>            }
        }
<span class='uc' id='L305' title='1|1|1 - Total: 1'>    }
</span>
    private static RuntimeException onInvalidIndex(int index, int upperBound)
    {
        // \u2209 is "NOT ELEMENT OF"
<span class='nc' id='L310' title='0|0|0 - Total: 13'>        String msg = index+" \u2209 [0, "+upperBound+')';
</span><span class='nc' id='L311' title='0|0|0 - Total: 5'>        throw new IndexOutOfBoundsException(msg);
</span>    }

    private static RuntimeException onEmptyStackTopRead()
    {
<span class='nc' id='L316' title='0|0|0 - Total: 5'>        throw new RuntimeException("Empty stack");
</span>    }

    private static RuntimeException onSeledMutation()
    {
<span class='nc' id='L321' title='0|0|0 - Total: 5'>        throw new IllegalStateException("Attempt to modify sealed array");
</span>    }

    private void writeObject(ObjectOutputStream os) throws IOException
    {
<span class='nc' id='L326' title='0|0|0 - Total: 2'>        os.defaultWriteObject();
</span><span class='nc' id='L327' title='0|0|0 - Total: 3'>        int N = size;
</span><span class='nc' id='L328' title='0|0|0 - Total: 2'>        for (int i = 0; i != N; ++i) {
</span><span class='nc' id='L329' title='0|0|0 - Total: 4'>            Object obj = getImpl(i);
</span><span class='nc' id='L330' title='0|0|0 - Total: 3'>            os.writeObject(obj);
</span>        }
<span class='nc' id='L332' title='0|0|0 - Total: 1'>    }
</span>
    private void readObject(ObjectInputStream is)
        throws IOException, ClassNotFoundException
    {
<span class='nc' id='L337' title='0|0|0 - Total: 2'>        is.defaultReadObject(); // It reads size
</span><span class='nc' id='L338' title='0|0|0 - Total: 3'>        int N = size;
</span><span class='nc' id='L339' title='0|0|0 - Total: 2'>        if (N > FIELDS_STORE_SIZE) {
</span><span class='nc' id='L340' title='0|0|0 - Total: 6'>            data = new Object[N - FIELDS_STORE_SIZE];
</span>        }
<span class='nc' id='L342' title='0|0|0 - Total: 2'>        for (int i = 0; i != N; ++i) {
</span><span class='nc' id='L343' title='0|0|0 - Total: 3'>            Object obj = is.readObject();
</span><span class='nc' id='L344' title='0|0|0 - Total: 4'>            setImpl(i, obj);
</span>        }
<span class='nc' id='L346' title='0|0|0 - Total: 1'>    }
</span>
// Number of data elements
    private int size;

    private boolean sealed;

    private static final int FIELDS_STORE_SIZE = 5;
    private transient Object f0, f1, f2, f3, f4;
    private transient Object[] data;
}
</pre></body></html><table class='legend'><tr><td class='nc'>Not Covered</td><td class='ac'>Covered by test suite 1</td><td class='bc'>Covered by test suite 2</td><td class='uc'>Covered by the union test suite</td><td class='apc'>Partially Covered by test suite 1</td><td class='bpc'>Partially Covered by test suite 2</td><td class='upc'>Partially Covered by the union test suite</td></tr></table>