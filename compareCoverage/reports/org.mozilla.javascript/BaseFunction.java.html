<?xml version='1.0' encoding='UTF-8'?><!DOCTYPE html PUBLIC '-//W3C//DTD XHTML 1.0 Strict//EN' 'http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd'><html xmlns='http://www.w3.org/1999/xhtml' lang='en'><head><meta http-equiv='Content-Type' content='text/html;charset=UTF-8'/><title>org.mozilla.javascript.BaseFunction.java</title><link rel='stylesheet' href='../.resources/report.css' type='text/css'/><link rel='stylesheet' href='../.resources/prettify.css' type='text/css'/><link rel='stylesheet' href='../.resources/custom.css' type='text/css'/><script type='text/javascript' src='../.resources/prettify.js'></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><h1>org.mozilla.javascript.BaseFunction.java</h1><table class='legend'><tr><td class='nc'>Not Covered</td><td class='ac'>Covered by test suite 1</td><td class='bc'>Covered by test suite 2</td><td class='uc'>Covered by the union test suite</td><td class='apc'>Partially Covered by test suite 1</td><td class='bpc'>Partially Covered by test suite 2</td><td class='upc'>Partially Covered by the union test suite</td></tr></table><pre class='source lang-java linenums'>/* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-
 *
 * This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at http://mozilla.org/MPL/2.0/. */

package org.mozilla.javascript;

/**
 * The base class for Function objects
 * See ECMA 15.3.
 * @author Norris Boyd
 */
public class BaseFunction extends IdScriptableObject implements Function
{

    static final long serialVersionUID = 5311394446546053859L;

<span class='uc' id='L19' title='3|3|3 - Total: 3'>    private static final Object FUNCTION_TAG = "Function";
</span>
    static void init(Scriptable scope, boolean sealed)
    {
<span class='uc' id='L23' title='4|4|4 - Total: 4'>        BaseFunction obj = new BaseFunction();
</span>        // Function.prototype attributes: see ECMA 15.3.3.1
<span class='uc' id='L25' title='3|3|3 - Total: 3'>        obj.prototypePropertyAttributes = DONTENUM | READONLY | PERMANENT;
</span><span class='uc' id='L26' title='6|6|6 - Total: 6'>        obj.exportAsJSClass(MAX_PROTOTYPE_ID, scope, sealed);
</span><span class='uc' id='L27' title='1|1|1 - Total: 1'>    }
</span>
    public BaseFunction()
<span class='uc' id='L30' title='2|2|2 - Total: 2'>    {
</span><span class='uc' id='L31' title='1|1|1 - Total: 1'>    }
</span>
    public BaseFunction(Scriptable scope, Scriptable prototype)
    {
<span class='uc' id='L35' title='4|4|4 - Total: 4'>        super(scope, prototype);
</span><span class='uc' id='L36' title='1|1|1 - Total: 1'>    }
</span>
    @Override
    public String getClassName() {
<span class='uc' id='L40' title='2|2|2 - Total: 2'>        return "Function";
</span>    }

    /**
     * Gets the value returned by calling the typeof operator on this object.
     * @see org.mozilla.javascript.ScriptableObject#getTypeOf()
     * @return "function" or "undefined" if {@link #avoidObjectDetection()} returns <code>true</code>
     */
    @Override
    public String getTypeOf()
    {
<span class='upc' id='L51' title='1|1|1 - Total: 2'>        return avoidObjectDetection() ? "undefined" : "function";
</span>    }

    /**
     * Implements the instanceof operator for JavaScript Function objects.
     * <p>
     * <code>
     * foo = new Foo();<br>
     * foo instanceof Foo;  // true<br>
     * </code>
     *
     * @param instance The value that appeared on the LHS of the instanceof
     *              operator
     * @return true if the "prototype" property of "this" appears in
     *              value's prototype chain
     *
     */
    @Override
    public boolean hasInstance(Scriptable instance)
    {
<span class='uc' id='L71' title='4|4|4 - Total: 4'>        Object protoProp = ScriptableObject.getProperty(this, "prototype");
</span><span class='uc' id='L72' title='2|2|2 - Total: 2'>        if (protoProp instanceof Scriptable) {
</span><span class='uc' id='L73' title='5|5|5 - Total: 5'>            return ScriptRuntime.jsDelegatesTo(instance, (Scriptable)protoProp);
</span>        }
<span class='uc' id='L75' title='4|4|4 - Total: 4'>        throw ScriptRuntime.typeError1("msg.instanceof.bad.prototype",
</span><span class='uc' id='L76' title='1|1|1 - Total: 1'>                                       getFunctionName());
</span>    }

// #string_id_map#

    private static final int
        Id_length       = 1,
        Id_arity        = 2,
        Id_name         = 3,
        Id_prototype    = 4,
        Id_arguments    = 5,

        MAX_INSTANCE_ID = 5;

    @Override
    protected int getMaxInstanceId()
    {
<span class='uc' id='L93' title='2|2|2 - Total: 2'>        return MAX_INSTANCE_ID;
</span>    }

    @Override
    protected int findInstanceIdInfo(String s)
    {
        int id;
// #generated# Last update: 2007-05-09 08:15:15 EDT
<span class='uc' id='L101' title='4|4|4 - Total: 4'>        L0: { id = 0; String X = null; int c;
</span><span class='uc' id='L102' title='5|5|5 - Total: 5'>            L: switch (s.length()) {
</span><span class='uc' id='L103' title='5|5|5 - Total: 5'>            case 4: X="name";id=Id_name; break L;
</span><span class='uc' id='L104' title='5|5|5 - Total: 5'>            case 5: X="arity";id=Id_arity; break L;
</span><span class='uc' id='L105' title='5|5|5 - Total: 5'>            case 6: X="length";id=Id_length; break L;
</span><span class='uc' id='L106' title='4|4|4 - Total: 4'>            case 9: c=s.charAt(0);
</span><span class='uc' id='L107' title='2|2|2 - Total: 2'>                if (c=='a') { X="arguments";id=Id_arguments; }
</span><span class='uc' id='L108' title='2|2|2 - Total: 2'>                else if (c=='p') { X="prototype";id=Id_prototype; }
</span>                break L;
            }
<span class='uc' id='L111' title='6|6|6 - Total: 6'>            if (X!=null && X!=s && !X.equals(s)) id = 0;
</span>            break L0;
        }
// #/generated#
// #/string_id_map#

<span class='uc' id='L117' title='2|2|2 - Total: 2'>        if (id == 0) return super.findInstanceIdInfo(s);
</span>
        int attr;
<span class='upc' id='L120' title='3|3|3 - Total: 4'>        switch (id) {
</span>          case Id_length:
          case Id_arity:
          case Id_name:
<span class='uc' id='L124' title='2|2|2 - Total: 2'>            attr = DONTENUM | READONLY | PERMANENT;
</span><span class='uc' id='L125' title='1|1|1 - Total: 1'>            break;
</span>          case Id_prototype:
            // some functions such as built-ins don't have a prototype property
<span class='uc' id='L128' title='2|2|2 - Total: 2'>            if (!hasPrototypeProperty()) {
</span><span class='uc' id='L129' title='2|2|2 - Total: 2'>                return 0;
</span>            }
<span class='uc' id='L131' title='3|3|3 - Total: 3'>            attr = prototypePropertyAttributes;
</span><span class='uc' id='L132' title='1|1|1 - Total: 1'>            break;
</span>          case Id_arguments:
<span class='uc' id='L134' title='3|3|3 - Total: 3'>            attr = argumentsAttributes;
</span><span class='uc' id='L135' title='1|1|1 - Total: 1'>            break;
</span><span class='nc' id='L136' title='0|0|0 - Total: 4'>          default: throw new IllegalStateException();
</span>        }
<span class='uc' id='L138' title='4|4|4 - Total: 4'>        return instanceIdInfo(attr, id);
</span>    }

    @Override
    protected String getInstanceIdName(int id)
    {
<span class='upc' id='L144' title='5|5|5 - Total: 6'>        switch (id) {
</span><span class='uc' id='L145' title='2|2|2 - Total: 2'>            case Id_length:       return "length";
</span><span class='uc' id='L146' title='2|2|2 - Total: 2'>            case Id_arity:        return "arity";
</span><span class='uc' id='L147' title='2|2|2 - Total: 2'>            case Id_name:         return "name";
</span><span class='uc' id='L148' title='2|2|2 - Total: 2'>            case Id_prototype:    return "prototype";
</span><span class='uc' id='L149' title='2|2|2 - Total: 2'>            case Id_arguments:    return "arguments";
</span>        }
<span class='nc' id='L151' title='0|0|0 - Total: 4'>        return super.getInstanceIdName(id);
</span>    }

    @Override
    protected Object getInstanceIdValue(int id)
    {
<span class='upc' id='L157' title='5|5|5 - Total: 6'>        switch (id) {
</span><span class='uc' id='L158' title='4|4|4 - Total: 4'>          case Id_length:    return ScriptRuntime.wrapInt(getLength());
</span><span class='uc' id='L159' title='4|4|4 - Total: 4'>          case Id_arity:     return ScriptRuntime.wrapInt(getArity());
</span><span class='uc' id='L160' title='3|3|3 - Total: 3'>          case Id_name:      return getFunctionName();
</span><span class='uc' id='L161' title='3|3|3 - Total: 3'>          case Id_prototype: return getPrototypeProperty();
</span><span class='uc' id='L162' title='3|3|3 - Total: 3'>          case Id_arguments: return getArguments();
</span>        }
<span class='nc' id='L164' title='0|0|0 - Total: 4'>        return super.getInstanceIdValue(id);
</span>    }

    @Override
    protected void setInstanceIdValue(int id, Object value)
    {
<span class='upc' id='L170' title='2|2|2 - Total: 4'>        switch (id) {
</span>            case Id_prototype:
<span class='upc' id='L172' title='1|1|1 - Total: 2'>                if ((prototypePropertyAttributes & READONLY) == 0) {
</span><span class='upc' id='L173' title='1|1|1 - Total: 2'>                    prototypeProperty = (value != null)
</span>                                        ? value : UniqueTag.NULL_VALUE;
                }
<span class='uc' id='L176' title='1|1|1 - Total: 1'>                return;
</span>            case Id_arguments:
<span class='upc' id='L178' title='1|1|1 - Total: 2'>                if (value == NOT_FOUND) {
</span>                    // This should not be called since "arguments" is PERMANENT
<span class='nc' id='L180' title='0|0|0 - Total: 2'>                    Kit.codeBug();
</span>                }
<span class='upc' id='L182' title='1|1|1 - Total: 2'>                if (defaultHas("arguments")) {
</span><span class='nc' id='L183' title='0|0|0 - Total: 5'>                    defaultPut("arguments", value);
</span><span class='nc' id='L184' title='0|0|0 - Total: 2'>                } else if ((argumentsAttributes & READONLY) == 0) {
</span><span class='nc' id='L185' title='0|0|0 - Total: 3'>                    argumentsObj = value;
</span>                }
<span class='nc' id='L187' title='0|0|0 - Total: 1'>                return;
</span>            case Id_name:
            case Id_arity:
            case Id_length:
<span class='nc' id='L191' title='0|0|0 - Total: 1'>                return;
</span>        }
<span class='nc' id='L193' title='0|0|0 - Total: 4'>        super.setInstanceIdValue(id, value);
</span><span class='nc' id='L194' title='0|0|0 - Total: 1'>    }
</span>
    @Override
    protected void setInstanceIdAttributes(int id, int attr)
    {
<span class='nc' id='L199' title='0|0|0 - Total: 3'>        switch (id) {
</span>            case Id_prototype:
<span class='nc' id='L201' title='0|0|0 - Total: 3'>                prototypePropertyAttributes = attr;
</span><span class='nc' id='L202' title='0|0|0 - Total: 1'>                return;
</span>            case Id_arguments:
<span class='nc' id='L204' title='0|0|0 - Total: 3'>                argumentsAttributes = attr;
</span><span class='nc' id='L205' title='0|0|0 - Total: 1'>                return;
</span>        }
<span class='nc' id='L207' title='0|0|0 - Total: 4'>        super.setInstanceIdAttributes(id, attr);
</span><span class='nc' id='L208' title='0|0|0 - Total: 1'>    }
</span>
    @Override
    protected void fillConstructorProperties(IdFunctionObject ctor)
    {
        // Fix up bootstrapping problem: getPrototype of the IdFunctionObject
        // can not return Function.prototype because Function object is not
        // yet defined.
<span class='uc' id='L216' title='3|3|3 - Total: 3'>        ctor.setPrototype(this);
</span><span class='uc' id='L217' title='3|3|3 - Total: 3'>        super.fillConstructorProperties(ctor);
</span><span class='uc' id='L218' title='1|1|1 - Total: 1'>    }
</span>
    @Override
    protected void initPrototypeId(int id)
    {
        String s;
        int arity;
<span class='upc' id='L225' title='6|6|6 - Total: 7'>        switch (id) {
</span><span class='uc' id='L226' title='5|5|5 - Total: 5'>          case Id_constructor: arity=1; s="constructor"; break;
</span><span class='uc' id='L227' title='5|5|5 - Total: 5'>          case Id_toString:    arity=0; s="toString";    break;
</span><span class='uc' id='L228' title='5|5|5 - Total: 5'>          case Id_toSource:    arity=1; s="toSource";    break;
</span><span class='uc' id='L229' title='5|5|5 - Total: 5'>          case Id_apply:       arity=2; s="apply";       break;
</span><span class='uc' id='L230' title='5|5|5 - Total: 5'>          case Id_call:        arity=1; s="call";        break;
</span><span class='uc' id='L231' title='5|5|5 - Total: 5'>          case Id_bind:        arity=1; s="bind";        break;
</span><span class='nc' id='L232' title='0|0|0 - Total: 6'>          default: throw new IllegalArgumentException(String.valueOf(id));
</span>        }
<span class='uc' id='L234' title='7|7|7 - Total: 7'>        initPrototypeMethod(FUNCTION_TAG, id, s, arity);
</span><span class='uc' id='L235' title='1|1|1 - Total: 1'>    }
</span>
    static boolean isApply(IdFunctionObject f) {
<span class='upc' id='L238' title='3|3|3 - Total: 4'>        return f.hasTag(FUNCTION_TAG) && f.methodId() == Id_apply;
</span>    }

    static boolean isApplyOrCall(IdFunctionObject f) {
<span class='uc' id='L242' title='2|2|2 - Total: 2'>        if(f.hasTag(FUNCTION_TAG)) {
</span><span class='uc' id='L243' title='2|2|2 - Total: 2'>            switch(f.methodId()) {
</span>                case Id_apply:
                case Id_call:
<span class='uc' id='L246' title='2|2|2 - Total: 2'>                    return true;
</span>            }
        }
<span class='uc' id='L249' title='2|2|2 - Total: 2'>        return false;
</span>    }

    @Override
    public Object execIdCall(IdFunctionObject f, Context cx, Scriptable scope,
                             Scriptable thisObj, Object[] args)
    {
<span class='upc' id='L256' title='1|1|1 - Total: 2'>        if (!f.hasTag(FUNCTION_TAG)) {
</span><span class='nc' id='L257' title='0|0|0 - Total: 8'>            return super.execIdCall(f, cx, scope, thisObj, args);
</span>        }
<span class='uc' id='L259' title='3|3|3 - Total: 3'>        int id = f.methodId();
</span><span class='upc' id='L260' title='5|5|5 - Total: 6'>        switch (id) {
</span>          case Id_constructor:
<span class='uc' id='L262' title='5|5|5 - Total: 5'>            return jsConstructor(cx, scope, args);
</span>
          case Id_toString: {
<span class='uc' id='L265' title='5|5|5 - Total: 5'>            BaseFunction realf = realFunction(thisObj, f);
</span><span class='uc' id='L266' title='4|4|4 - Total: 4'>            int indent = ScriptRuntime.toInt32(args, 0);
</span><span class='uc' id='L267' title='5|5|5 - Total: 5'>            return realf.decompile(indent, 0);
</span>          }

          case Id_toSource: {
<span class='uc' id='L271' title='5|5|5 - Total: 5'>            BaseFunction realf = realFunction(thisObj, f);
</span><span class='uc' id='L272' title='2|2|2 - Total: 2'>            int indent = 0;
</span><span class='uc' id='L273' title='2|2|2 - Total: 2'>            int flags = Decompiler.TO_SOURCE_FLAG;
</span><span class='uc' id='L274' title='2|2|2 - Total: 2'>            if (args.length != 0) {
</span><span class='uc' id='L275' title='5|5|5 - Total: 5'>                indent = ScriptRuntime.toInt32(args[0]);
</span><span class='upc' id='L276' title='1|1|1 - Total: 2'>                if (indent >= 0) {
</span><span class='uc' id='L277' title='3|3|3 - Total: 3'>                    flags = 0;
</span>                } else {
<span class='nc' id='L279' title='0|0|0 - Total: 2'>                    indent = 0;
</span>                }
            }
<span class='uc' id='L282' title='5|5|5 - Total: 5'>            return realf.decompile(indent, flags);
</span>          }

          case Id_apply:
          case Id_call:
<span class='uc' id='L287' title='2|2|2 - Total: 2'>            return ScriptRuntime.applyOrCall(id == Id_apply,
</span>                                             cx, scope, thisObj, args);

          case Id_bind:
<span class='uc' id='L291' title='2|2|2 - Total: 2'>            if ( !(thisObj instanceof Callable) ) {
</span><span class='uc' id='L292' title='3|3|3 - Total: 3'>              throw ScriptRuntime.notFunctionError(thisObj);
</span>            }
<span class='uc' id='L294' title='3|3|3 - Total: 3'>            Callable targetFunction = (Callable) thisObj;
</span><span class='uc' id='L295' title='3|3|3 - Total: 3'>            int argc = args.length;
</span>            final Scriptable boundThis;
            final Object[] boundArgs;
<span class='uc' id='L298' title='2|2|2 - Total: 2'>            if (argc > 0) {
</span><span class='uc' id='L299' title='7|7|7 - Total: 7'>              boundThis = ScriptRuntime.toObjectOrNull(cx, args[0], scope);
</span><span class='uc' id='L300' title='5|5|5 - Total: 5'>              boundArgs = new Object[argc-1];
</span><span class='uc' id='L301' title='9|9|9 - Total: 9'>              System.arraycopy(args, 1, boundArgs, 0, argc-1);
</span>            } else {
<span class='uc' id='L303' title='2|2|2 - Total: 2'>              boundThis = null;
</span><span class='uc' id='L304' title='2|2|2 - Total: 2'>              boundArgs = ScriptRuntime.emptyArgs;
</span>            }
<span class='uc' id='L306' title='9|9|9 - Total: 9'>            return new BoundFunction(cx, scope, targetFunction, boundThis, boundArgs);
</span>        }
<span class='nc' id='L308' title='0|0|0 - Total: 6'>        throw new IllegalArgumentException(String.valueOf(id));
</span>    }

    private BaseFunction realFunction(Scriptable thisObj, IdFunctionObject f)
    {
<span class='uc' id='L313' title='4|4|4 - Total: 4'>        Object x = thisObj.getDefaultValue(ScriptRuntime.FunctionClass);
</span><span class='upc' id='L314' title='1|1|1 - Total: 2'>        if (x instanceof Delegator) {
</span><span class='nc' id='L315' title='0|0|0 - Total: 4'>            x = ((Delegator)x).getDelegee();
</span>        }
<span class='uc' id='L317' title='2|2|2 - Total: 2'>        if (x instanceof BaseFunction) {
</span><span class='uc' id='L318' title='3|3|3 - Total: 3'>            return (BaseFunction)x;
</span>        }
<span class='uc' id='L320' title='4|4|4 - Total: 4'>        throw ScriptRuntime.typeError1("msg.incompat.call",
</span><span class='uc' id='L321' title='1|1|1 - Total: 1'>                                       f.getFunctionName());
</span>    }

    /**
     * Make value as DontEnum, DontDelete, ReadOnly
     * prototype property of this Function object
     */
    public void setImmunePrototypeProperty(Object value)
    {
<span class='upc' id='L330' title='1|1|1 - Total: 2'>        if ((prototypePropertyAttributes & READONLY) != 0) {
</span><span class='nc' id='L331' title='0|0|0 - Total: 4'>            throw new IllegalStateException();
</span>        }
<span class='uc' id='L333' title='2|2|2 - Total: 2'>        prototypeProperty = (value != null) ? value : UniqueTag.NULL_VALUE;
</span><span class='uc' id='L334' title='3|3|3 - Total: 3'>        prototypePropertyAttributes = DONTENUM | PERMANENT | READONLY;
</span><span class='uc' id='L335' title='1|1|1 - Total: 1'>    }
</span>
    protected Scriptable getClassPrototype()
    {
<span class='uc' id='L339' title='3|3|3 - Total: 3'>        Object protoVal = getPrototypeProperty();
</span><span class='uc' id='L340' title='2|2|2 - Total: 2'>        if (protoVal instanceof Scriptable) {
</span><span class='uc' id='L341' title='3|3|3 - Total: 3'>            return (Scriptable) protoVal;
</span>        }
<span class='uc' id='L343' title='3|3|3 - Total: 3'>        return ScriptableObject.getObjectPrototype(this);
</span>    }

    /**
     * Should be overridden.
     */
    public Object call(Context cx, Scriptable scope, Scriptable thisObj,
                       Object[] args)
    {
<span class='uc' id='L352' title='2|2|2 - Total: 2'>        return Undefined.instance;
</span>    }

    public Scriptable construct(Context cx, Scriptable scope, Object[] args)
    {
<span class='uc' id='L357' title='5|5|5 - Total: 5'>        Scriptable result = createObject(cx, scope);
</span><span class='uc' id='L358' title='2|2|2 - Total: 2'>        if (result != null) {
</span><span class='uc' id='L359' title='7|7|7 - Total: 7'>            Object val = call(cx, scope, result, args);
</span><span class='uc' id='L360' title='2|2|2 - Total: 2'>            if (val instanceof Scriptable) {
</span><span class='uc' id='L361' title='3|3|3 - Total: 3'>                result = (Scriptable)val;
</span>            }
<span class='uc' id='L363' title='1|1|1 - Total: 1'>        } else {
</span><span class='uc' id='L364' title='7|7|7 - Total: 7'>            Object val = call(cx, scope, null, args);
</span><span class='upc' id='L365' title='1|1|1 - Total: 2'>            if (!(val instanceof Scriptable)) {
</span>                // It is program error not to return Scriptable from
                // the call method if createObject returns null.
<span class='nc' id='L368' title='0|0|0 - Total: 8'>                throw new IllegalStateException(
</span>                    "Bad implementaion of call as constructor, name="
<span class='nc' id='L370' title='0|0|0 - Total: 11'>                    +getFunctionName()+" in "+getClass().getName());
</span>            }
<span class='uc' id='L372' title='3|3|3 - Total: 3'>            result = (Scriptable)val;
</span><span class='uc' id='L373' title='2|2|2 - Total: 2'>            if (result.getPrototype() == null) {
</span><span class='uc' id='L374' title='3|3|3 - Total: 3'>                Scriptable proto = getClassPrototype();
</span><span class='upc' id='L375' title='1|1|1 - Total: 2'>                if (result != proto) {
</span><span class='uc' id='L376' title='3|3|3 - Total: 3'>                    result.setPrototype(proto);
</span>                }
            }
<span class='uc' id='L379' title='2|2|2 - Total: 2'>            if (result.getParentScope() == null) {
</span><span class='uc' id='L380' title='3|3|3 - Total: 3'>                Scriptable parent = getParentScope();
</span><span class='uc' id='L381' title='2|2|2 - Total: 2'>                if (result != parent) {
</span><span class='uc' id='L382' title='3|3|3 - Total: 3'>                    result.setParentScope(parent);
</span>                }
            }
        }
<span class='uc' id='L386' title='2|2|2 - Total: 2'>        return result;
</span>    }

    /**
     * Creates new script object.
     * The default implementation of {@link #construct} uses the method to
     * to get the value for <tt>thisObj</tt> argument when invoking
     * {@link #call}.
     * The methos is allowed to return <tt>null</tt> to indicate that
     * {@link #call} will create a new object itself. In this case
     * {@link #construct} will set scope and prototype on the result
     * {@link #call} unless they are already set.
     */
    public Scriptable createObject(Context cx, Scriptable scope)
    {
<span class='uc' id='L401' title='4|4|4 - Total: 4'>        Scriptable newInstance = new NativeObject();
</span><span class='uc' id='L402' title='4|4|4 - Total: 4'>        newInstance.setPrototype(getClassPrototype());
</span><span class='uc' id='L403' title='4|4|4 - Total: 4'>        newInstance.setParentScope(getParentScope());
</span><span class='uc' id='L404' title='2|2|2 - Total: 2'>        return newInstance;
</span>    }

    /**
     * Decompile the source information associated with this js
     * function/script back into a string.
     *
     * @param indent How much to indent the decompiled result.
     *
     * @param flags Flags specifying format of decompilation output.
     */
    String decompile(int indent, int flags)
    {
<span class='uc' id='L417' title='4|4|4 - Total: 4'>        StringBuilder sb = new StringBuilder();
</span><span class='upc' id='L418' title='1|1|1 - Total: 2'>        boolean justbody = (0 != (flags & Decompiler.ONLY_BODY_FLAG));
</span><span class='upc' id='L419' title='1|1|1 - Total: 2'>        if (!justbody) {
</span><span class='uc' id='L420' title='4|4|4 - Total: 4'>            sb.append("function ");
</span><span class='uc' id='L421' title='5|5|5 - Total: 5'>            sb.append(getFunctionName());
</span><span class='uc' id='L422' title='4|4|4 - Total: 4'>            sb.append("() {\n\t");
</span>        }
<span class='uc' id='L424' title='4|4|4 - Total: 4'>        sb.append("[native code, arity=");
</span><span class='uc' id='L425' title='5|5|5 - Total: 5'>        sb.append(getArity());
</span><span class='uc' id='L426' title='4|4|4 - Total: 4'>        sb.append("]\n");
</span><span class='upc' id='L427' title='1|1|1 - Total: 2'>        if (!justbody) {
</span><span class='uc' id='L428' title='4|4|4 - Total: 4'>            sb.append("}\n");
</span>        }
<span class='uc' id='L430' title='3|3|3 - Total: 3'>        return sb.toString();
</span>    }

<span class='uc' id='L433' title='2|2|2 - Total: 2'>    public int getArity() { return 0; }
</span>
<span class='uc' id='L435' title='2|2|2 - Total: 2'>    public int getLength() { return 0; }
</span>
    public String getFunctionName() {
<span class='uc' id='L438' title='2|2|2 - Total: 2'>        return "";
</span>    }

    protected boolean hasPrototypeProperty() {
<span class='uc' id='L442' title='4|4|4 - Total: 4'>        return prototypeProperty != null || this instanceof NativeFunction;
</span>    }

    protected Object getPrototypeProperty() {
<span class='uc' id='L446' title='3|3|3 - Total: 3'>        Object result = prototypeProperty;
</span><span class='uc' id='L447' title='2|2|2 - Total: 2'>        if (result == null) {
</span>            // only create default prototype on native JavaScript functions,
            // not on built-in functions, java methods, host objects etc.
<span class='upc' id='L450' title='1|1|1 - Total: 2'>            if (this instanceof NativeFunction) {
</span><span class='uc' id='L451' title='4|4|4 - Total: 4'>                result = setupDefaultPrototype();
</span>            } else {
<span class='nc' id='L453' title='0|0|0 - Total: 3'>                result = Undefined.instance;
</span>            }
<span class='upc' id='L455' title='1|1|1 - Total: 2'>        } else if (result == UniqueTag.NULL_VALUE) {
</span><span class='nc' id='L456' title='0|0|0 - Total: 2'>            result = null;
</span>        }
<span class='uc' id='L458' title='2|2|2 - Total: 2'>        return result;
</span>    }

    private synchronized Object setupDefaultPrototype() {
<span class='upc' id='L462' title='1|1|1 - Total: 2'>        if (prototypeProperty != null) {
</span><span class='nc' id='L463' title='0|0|0 - Total: 3'>            return prototypeProperty;
</span>        }
<span class='uc' id='L465' title='4|4|4 - Total: 4'>        NativeObject obj = new NativeObject();
</span><span class='uc' id='L466' title='2|2|2 - Total: 2'>        final int attr = ScriptableObject.DONTENUM;
</span><span class='uc' id='L467' title='5|5|5 - Total: 5'>        obj.defineProperty("constructor", this, attr);
</span>        // put the prototype property into the object now, then in the
        // wacky case of a user defining a function Object(), we don't
        // get an infinite loop trying to find the prototype.
<span class='uc' id='L471' title='3|3|3 - Total: 3'>        prototypeProperty = obj;
</span><span class='uc' id='L472' title='3|3|3 - Total: 3'>        Scriptable proto = getObjectPrototype(this);
</span><span class='upc' id='L473' title='1|1|1 - Total: 2'>        if (proto != obj) {
</span>            // not the one we just made, it must remain grounded
<span class='uc' id='L475' title='3|3|3 - Total: 3'>            obj.setPrototype(proto);
</span>        }
<span class='uc' id='L477' title='2|2|2 - Total: 2'>        return obj;
</span>    }

    private Object getArguments()
    {
      // <Function name>.arguments is deprecated, so we use a slow
      // way of getting it that doesn't add to the invocation cost.
      // TODO: add warning, error based on version
<span class='upc' id='L485' title='1|1|1 - Total: 2'>      Object value = defaultHas("arguments") ? defaultGet("arguments") : argumentsObj;
</span><span class='upc' id='L486' title='1|1|1 - Total: 2'>      if (value != NOT_FOUND) {
</span>          // Should after changing <Function name>.arguments its
          // activation still be available during Function call?
          // This code assumes it should not:
          // defaultGet("arguments") != NOT_FOUND
          // means assigned arguments
<span class='nc' id='L492' title='0|0|0 - Total: 2'>          return value;
</span>      }
<span class='uc' id='L494' title='2|2|2 - Total: 2'>      Context cx = Context.getContext();
</span><span class='uc' id='L495' title='4|4|4 - Total: 4'>      NativeCall activation = ScriptRuntime.findFunctionActivation(cx, this);
</span><span class='uc' id='L496' title='2|2|2 - Total: 2'>      return (activation == null)
</span>             ? null
<span class='uc' id='L498' title='1|1|1 - Total: 1'>             : activation.get("arguments", activation);
</span>    }

    private static Object jsConstructor(Context cx, Scriptable scope,
                                        Object[] args)
    {
<span class='uc' id='L504' title='3|3|3 - Total: 3'>        int arglen = args.length;
</span><span class='uc' id='L505' title='4|4|4 - Total: 4'>        StringBuilder sourceBuf = new StringBuilder();
</span>
<span class='uc' id='L507' title='4|4|4 - Total: 4'>        sourceBuf.append("function ");
</span>        /* version != 1.2 Function constructor behavior -
         * print 'anonymous' as the function name if the
         * version (under which the function was compiled) is
         * less than 1.2... or if it's greater than 1.2, because
         * we need to be closer to ECMA.
         */
<span class='uc' id='L514' title='2|2|2 - Total: 2'>        if (cx.getLanguageVersion() != Context.VERSION_1_2) {
</span><span class='uc' id='L515' title='4|4|4 - Total: 4'>            sourceBuf.append("anonymous");
</span>        }
<span class='uc' id='L517' title='4|4|4 - Total: 4'>        sourceBuf.append('(');
</span>
        // Append arguments as coma separated strings
<span class='uc' id='L520' title='2|2|2 - Total: 2'>        for (int i = 0; i < arglen - 1; i++) {
</span><span class='uc' id='L521' title='2|2|2 - Total: 2'>            if (i > 0) {
</span><span class='uc' id='L522' title='4|4|4 - Total: 4'>                sourceBuf.append(',');
</span>            }
<span class='uc' id='L524' title='7|7|7 - Total: 7'>            sourceBuf.append(ScriptRuntime.toString(args[i]));
</span>        }
<span class='uc' id='L526' title='4|4|4 - Total: 4'>        sourceBuf.append(") {");
</span><span class='uc' id='L527' title='2|2|2 - Total: 2'>        if (arglen != 0) {
</span>            // append function body
<span class='uc' id='L529' title='7|7|7 - Total: 7'>            String funBody = ScriptRuntime.toString(args[arglen - 1]);
</span><span class='uc' id='L530' title='4|4|4 - Total: 4'>            sourceBuf.append(funBody);
</span>        }
<span class='uc' id='L532' title='4|4|4 - Total: 4'>        sourceBuf.append("\n}");
</span><span class='uc' id='L533' title='3|3|3 - Total: 3'>        String source = sourceBuf.toString();
</span>
<span class='uc' id='L535' title='3|3|3 - Total: 3'>        int[] linep = new int[1];
</span><span class='uc' id='L536' title='3|3|3 - Total: 3'>        String filename = Context.getSourcePositionFromStack(linep);
</span><span class='uc' id='L537' title='2|2|2 - Total: 2'>        if (filename == null) {
</span><span class='uc' id='L538' title='2|2|2 - Total: 2'>            filename = "<eval'ed string>";
</span><span class='uc' id='L539' title='4|4|4 - Total: 4'>            linep[0] = 1;
</span>        }

<span class='uc' id='L542' title='5|5|5 - Total: 5'>        String sourceURI = ScriptRuntime.
</span><span class='uc' id='L543' title='2|2|2 - Total: 2'>            makeUrlForGeneratedScript(false, filename, linep[0]);
</span>
<span class='uc' id='L545' title='3|3|3 - Total: 3'>        Scriptable global = ScriptableObject.getTopLevelScope(scope);
</span>
        ErrorReporter reporter;
<span class='uc' id='L548' title='4|4|4 - Total: 4'>        reporter = DefaultErrorReporter.forEval(cx.getErrorReporter());
</span>
<span class='uc' id='L550' title='2|2|2 - Total: 2'>        Evaluator evaluator = Context.createInterpreter();
</span><span class='upc' id='L551' title='1|1|1 - Total: 2'>        if (evaluator == null) {
</span><span class='nc' id='L552' title='0|0|0 - Total: 9'>            throw new JavaScriptException("Interpreter not present",
</span>                    filename, linep[0]);
        }

        // Compile with explicit interpreter instance to force interpreter
        // mode.
<span class='uc' id='L558' title='10|10|10 - Total: 10'>        return cx.compileFunction(global, source, evaluator, reporter,
</span>                                  sourceURI, 1, null);
    }

    @Override
    protected int findPrototypeId(String s)
    {
        int id;
// #string_id_map#
// #generated# Last update: 2009-07-24 16:00:52 EST
<span class='uc' id='L568' title='4|4|4 - Total: 4'>        L0: { id = 0; String X = null; int c;
</span><span class='uc' id='L569' title='5|5|5 - Total: 5'>            L: switch (s.length()) {
</span><span class='uc' id='L570' title='4|4|4 - Total: 4'>            case 4: c=s.charAt(0);
</span><span class='uc' id='L571' title='2|2|2 - Total: 2'>                if (c=='b') { X="bind";id=Id_bind; }
</span><span class='uc' id='L572' title='2|2|2 - Total: 2'>                else if (c=='c') { X="call";id=Id_call; }
</span>                break L;
<span class='uc' id='L574' title='5|5|5 - Total: 5'>            case 5: X="apply";id=Id_apply; break L;
</span><span class='uc' id='L575' title='4|4|4 - Total: 4'>            case 8: c=s.charAt(3);
</span><span class='uc' id='L576' title='2|2|2 - Total: 2'>                if (c=='o') { X="toSource";id=Id_toSource; }
</span><span class='uc' id='L577' title='2|2|2 - Total: 2'>                else if (c=='t') { X="toString";id=Id_toString; }
</span>                break L;
<span class='uc' id='L579' title='5|5|5 - Total: 5'>            case 11: X="constructor";id=Id_constructor; break L;
</span>            }
<span class='uc' id='L581' title='6|6|6 - Total: 6'>            if (X!=null && X!=s && !X.equals(s)) id = 0;
</span>            break L0;
        }
// #/generated#
<span class='uc' id='L585' title='2|2|2 - Total: 2'>        return id;
</span>    }

    private static final int
        Id_constructor    = 1,
        Id_toString       = 2,
        Id_toSource       = 3,
        Id_apply          = 4,
        Id_call           = 5,
        Id_bind           = 6,

        MAX_PROTOTYPE_ID  = Id_bind;

// #/string_id_map#

    private Object prototypeProperty;
<span class='uc' id='L601' title='6|6|6 - Total: 6'>    private Object argumentsObj = NOT_FOUND;
</span>
    // For function object instances, attributes are
    //  {configurable:false, enumerable:false};
    // see ECMA 15.3.5.2
<span class='uc' id='L606' title='6|6|6 - Total: 6'>    private int prototypePropertyAttributes = PERMANENT|DONTENUM;
</span><span class='uc' id='L607' title='6|6|6 - Total: 6'>    private int argumentsAttributes = PERMANENT|DONTENUM;
</span>}

</pre></body></html><table class='legend'><tr><td class='nc'>Not Covered</td><td class='ac'>Covered by test suite 1</td><td class='bc'>Covered by test suite 2</td><td class='uc'>Covered by the union test suite</td><td class='apc'>Partially Covered by test suite 1</td><td class='bpc'>Partially Covered by test suite 2</td><td class='upc'>Partially Covered by the union test suite</td></tr></table>