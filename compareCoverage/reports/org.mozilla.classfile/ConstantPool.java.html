<?xml version='1.0' encoding='UTF-8'?><!DOCTYPE html PUBLIC '-//W3C//DTD XHTML 1.0 Strict//EN' 'http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd'><html xmlns='http://www.w3.org/1999/xhtml' lang='en'><head><meta http-equiv='Content-Type' content='text/html;charset=UTF-8'/><title>org.mozilla.classfile.ConstantPool.java</title><link rel='stylesheet' href='../.resources/report.css' type='text/css'/><link rel='stylesheet' href='../.resources/prettify.css' type='text/css'/><link rel='stylesheet' href='../.resources/custom.css' type='text/css'/><script type='text/javascript' src='../.resources/prettify.js'></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><h1>org.mozilla.classfile.ConstantPool.java</h1><table class='legend'><tr><td class='nc'>Not Covered</td><td class='ac'>Covered by test suite 1</td><td class='bc'>Covered by test suite 2</td><td class='uc'>Covered by the union test suite</td><td class='apc'>Partially Covered by test suite 1</td><td class='bpc'>Partially Covered by test suite 2</td><td class='upc'>Partially Covered by the union test suite</td></tr></table><pre class='source lang-java linenums'>/* -*- Mode: java; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 4 -*-
 *
 * This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at http://mozilla.org/MPL/2.0/. */

package org.mozilla.classfile;

import org.mozilla.javascript.ObjToIntMap;
import org.mozilla.javascript.UintMap;

final class ConstantPool
{
  ConstantPool(ClassFileWriter cfw)
<span class='uc' id='L15' title='2|2|2 - Total: 2'>  {
</span><span class='uc' id='L16' title='3|3|3 - Total: 3'>    this.cfw = cfw;
</span><span class='uc' id='L17' title='3|3|3 - Total: 3'>    itsTopIndex = 1;       // the zero'th entry is reserved
</span><span class='uc' id='L18' title='4|4|4 - Total: 4'>    itsPool = new byte[ConstantPoolSize];
</span><span class='uc' id='L19' title='3|3|3 - Total: 3'>    itsTop = 0;
</span><span class='uc' id='L20' title='1|1|1 - Total: 1'>  }
</span>
  private static final int ConstantPoolSize = 256;
  static final byte
      CONSTANT_Class = 7,
      CONSTANT_Fieldref = 9,
      CONSTANT_Methodref = 10,
      CONSTANT_InterfaceMethodref = 11,
      CONSTANT_String = 8,
      CONSTANT_Integer = 3,
      CONSTANT_Float = 4,
      CONSTANT_Long = 5,
      CONSTANT_Double = 6,
      CONSTANT_NameAndType = 12,
      CONSTANT_Utf8 = 1,
      CONSTANT_MethodType = 16,
      CONSTANT_MethodHandle = 15,
      CONSTANT_InvokeDynamic = 18;

  int write(byte[] data, int offset)
  {
<span class='uc' id='L41' title='7|7|7 - Total: 7'>    offset = ClassFileWriter.putInt16((short)itsTopIndex, data, offset);
</span><span class='uc' id='L42' title='8|8|8 - Total: 8'>    System.arraycopy(itsPool, 0, data, offset, itsTop);
</span><span class='uc' id='L43' title='5|5|5 - Total: 5'>    offset += itsTop;
</span><span class='uc' id='L44' title='2|2|2 - Total: 2'>    return offset;
</span>  }

  int getWriteSize()
  {
<span class='uc' id='L49' title='5|5|5 - Total: 5'>    return 2 + itsTop;
</span>  }

  int addConstant(int k)
  {
<span class='uc' id='L54' title='3|3|3 - Total: 3'>    ensure(5);
</span><span class='uc' id='L55' title='11|11|11 - Total: 11'>    itsPool[itsTop++] = CONSTANT_Integer;
</span><span class='uc' id='L56' title='8|8|8 - Total: 8'>    itsTop = ClassFileWriter.putInt32(k, itsPool, itsTop);
</span><span class='uc' id='L57' title='6|6|6 - Total: 6'>    itsPoolTypes.put(itsTopIndex, CONSTANT_Integer);
</span><span class='uc' id='L58' title='9|9|9 - Total: 9'>    return (short)(itsTopIndex++);
</span>  }

  int addConstant(long k)
  {
<span class='nc' id='L63' title='0|0|0 - Total: 3'>    ensure(9);
</span><span class='nc' id='L64' title='0|0|0 - Total: 11'>    itsPool[itsTop++] = CONSTANT_Long;
</span><span class='nc' id='L65' title='0|0|0 - Total: 8'>    itsTop = ClassFileWriter.putInt64(k, itsPool, itsTop);
</span><span class='nc' id='L66' title='0|0|0 - Total: 3'>    int index = itsTopIndex;
</span><span class='nc' id='L67' title='0|0|0 - Total: 6'>    itsTopIndex += 2;
</span><span class='nc' id='L68' title='0|0|0 - Total: 5'>    itsPoolTypes.put(index, CONSTANT_Long);
</span><span class='nc' id='L69' title='0|0|0 - Total: 2'>    return index;
</span>  }

  int addConstant(float k)
  {
<span class='nc' id='L74' title='0|0|0 - Total: 3'>    ensure(5);
</span><span class='nc' id='L75' title='0|0|0 - Total: 11'>    itsPool[itsTop++] = CONSTANT_Float;
</span><span class='nc' id='L76' title='0|0|0 - Total: 3'>    int bits = Float.floatToIntBits(k);
</span><span class='nc' id='L77' title='0|0|0 - Total: 8'>    itsTop = ClassFileWriter.putInt32(bits, itsPool, itsTop);
</span><span class='nc' id='L78' title='0|0|0 - Total: 6'>    itsPoolTypes.put(itsTopIndex, CONSTANT_Float);
</span><span class='nc' id='L79' title='0|0|0 - Total: 8'>    return itsTopIndex++;
</span>  }

  int addConstant(double k)
  {
<span class='uc' id='L84' title='3|3|3 - Total: 3'>    ensure(9);
</span><span class='uc' id='L85' title='11|11|11 - Total: 11'>    itsPool[itsTop++] = CONSTANT_Double;
</span><span class='uc' id='L86' title='3|3|3 - Total: 3'>    long bits = Double.doubleToLongBits(k);
</span><span class='uc' id='L87' title='8|8|8 - Total: 8'>    itsTop = ClassFileWriter.putInt64(bits, itsPool, itsTop);
</span><span class='uc' id='L88' title='3|3|3 - Total: 3'>    int index = itsTopIndex;
</span><span class='uc' id='L89' title='6|6|6 - Total: 6'>    itsTopIndex += 2;
</span><span class='uc' id='L90' title='5|5|5 - Total: 5'>    itsPoolTypes.put(index, CONSTANT_Double);
</span><span class='uc' id='L91' title='2|2|2 - Total: 2'>    return index;
</span>  }

  int addConstant(String k)
  {
<span class='uc' id='L96' title='6|6|6 - Total: 6'>    int utf8Index = 0xFFFF & addUtf8(k);
</span><span class='uc' id='L97' title='6|6|6 - Total: 6'>    int theIndex = itsStringConstHash.getInt(utf8Index, -1);
</span><span class='uc' id='L98' title='2|2|2 - Total: 2'>    if (theIndex == -1) {
</span><span class='uc' id='L99' title='8|8|8 - Total: 8'>      theIndex = itsTopIndex++;
</span><span class='uc' id='L100' title='3|3|3 - Total: 3'>      ensure(3);
</span><span class='uc' id='L101' title='11|11|11 - Total: 11'>      itsPool[itsTop++] = CONSTANT_String;
</span><span class='uc' id='L102' title='8|8|8 - Total: 8'>      itsTop = ClassFileWriter.putInt16(utf8Index, itsPool, itsTop);
</span><span class='uc' id='L103' title='5|5|5 - Total: 5'>      itsStringConstHash.put(utf8Index, theIndex);
</span>    }
<span class='uc' id='L105' title='5|5|5 - Total: 5'>    itsPoolTypes.put(theIndex, CONSTANT_String);
</span><span class='uc' id='L106' title='2|2|2 - Total: 2'>    return theIndex;
</span>  }

  int addConstant(Object value) {
<span class='nc' id='L110' title='0|0|0 - Total: 6'>    if (value instanceof Integer || value instanceof Byte
</span>        || value instanceof Short) {
<span class='nc' id='L112' title='0|0|0 - Total: 6'>      return addConstant(((Number) value).intValue());
</span><span class='nc' id='L113' title='0|0|0 - Total: 2'>    } else if (value instanceof Character) {
</span><span class='nc' id='L114' title='0|0|0 - Total: 6'>      return addConstant(((Character) value).charValue());
</span><span class='nc' id='L115' title='0|0|0 - Total: 2'>    } else if (value instanceof Boolean) {
</span><span class='nc' id='L116' title='0|0|0 - Total: 2'>      return addConstant(((Boolean) value).booleanValue() ? 1 : 0);
</span><span class='nc' id='L117' title='0|0|0 - Total: 2'>    } else if (value instanceof Float) {
</span><span class='nc' id='L118' title='0|0|0 - Total: 6'>      return addConstant(((Float) value).floatValue());
</span><span class='nc' id='L119' title='0|0|0 - Total: 2'>    } else if (value instanceof Long) {
</span><span class='nc' id='L120' title='0|0|0 - Total: 6'>      return addConstant(((Long) value).longValue());
</span><span class='nc' id='L121' title='0|0|0 - Total: 2'>    } else if (value instanceof Double) {
</span><span class='nc' id='L122' title='0|0|0 - Total: 6'>      return addConstant(((Double) value).doubleValue());
</span><span class='nc' id='L123' title='0|0|0 - Total: 2'>    } else if (value instanceof String) {
</span><span class='nc' id='L124' title='0|0|0 - Total: 5'>      return addConstant((String) value);
</span>      //} else if (value instanceof ClassFileWriter.MethodType) {
      //    return addMethodType((ClassFileWriter.MethodType) value);
<span class='nc' id='L127' title='0|0|0 - Total: 2'>    } else if (value instanceof ClassFileWriter.MHandle) {
</span><span class='nc' id='L128' title='0|0|0 - Total: 5'>      return addMethodHandle((ClassFileWriter.MHandle) value);
</span>    } else {
<span class='nc' id='L130' title='0|0|0 - Total: 12'>      throw new IllegalArgumentException("value " + value);
</span>    }
  }


  boolean isUnderUtfEncodingLimit(String s)
  {
<span class='nc' id='L137' title='0|0|0 - Total: 3'>    int strLen = s.length();
</span><span class='nc' id='L138' title='0|0|0 - Total: 2'>    if (strLen * 3 <= MAX_UTF_ENCODING_SIZE) {
</span><span class='nc' id='L139' title='0|0|0 - Total: 2'>      return true;
</span><span class='nc' id='L140' title='0|0|0 - Total: 2'>    } else if (strLen > MAX_UTF_ENCODING_SIZE) {
</span><span class='nc' id='L141' title='0|0|0 - Total: 2'>      return false;
</span>    }
<span class='nc' id='L143' title='0|0|0 - Total: 2'>    return strLen == getUtfEncodingLimit(s, 0, strLen);
</span>  }

  /**
   * Get maximum i such that <tt>start <= i <= end</tt> and
   * <tt>s.substring(start, i)</tt> fits JVM UTF string encoding limit.
   */
  int getUtfEncodingLimit(String s, int start, int end)
  {
<span class='uc' id='L152' title='2|2|2 - Total: 2'>    if ((end - start) * 3 <= MAX_UTF_ENCODING_SIZE) {
</span><span class='uc' id='L153' title='2|2|2 - Total: 2'>      return end;
</span>    }
<span class='uc' id='L155' title='2|2|2 - Total: 2'>    int limit = MAX_UTF_ENCODING_SIZE;
</span><span class='uc' id='L156' title='2|2|2 - Total: 2'>    for (int i = start; i != end; i++) {
</span><span class='uc' id='L157' title='4|4|4 - Total: 4'>      int c = s.charAt(i);
</span><span class='uc' id='L158' title='4|4|4 - Total: 4'>      if (0 != c && c <= 0x7F) {
</span><span class='uc' id='L159' title='2|2|2 - Total: 2'>        --limit;
</span><span class='uc' id='L160' title='2|2|2 - Total: 2'>      } else if (c < 0x7FF) {
</span><span class='uc' id='L161' title='2|2|2 - Total: 2'>        limit -= 2;
</span>      } else {
<span class='uc' id='L163' title='1|1|1 - Total: 1'>        limit -= 3;
</span>      }
<span class='uc' id='L165' title='2|2|2 - Total: 2'>      if (limit < 0) {
</span><span class='uc' id='L166' title='2|2|2 - Total: 2'>        return i;
</span>      }
    }
<span class='uc' id='L169' title='2|2|2 - Total: 2'>    return end;
</span>  }

  short addUtf8(String k)
  {
<span class='uc' id='L174' title='6|6|6 - Total: 6'>    int theIndex = itsUtf8Hash.get(k, -1);
</span><span class='uc' id='L175' title='2|2|2 - Total: 2'>    if (theIndex == -1) {
</span><span class='uc' id='L176' title='3|3|3 - Total: 3'>      int strLen = k.length();
</span>      boolean tooBigString;
<span class='upc' id='L178' title='1|1|1 - Total: 2'>      if (strLen > MAX_UTF_ENCODING_SIZE) {
</span><span class='nc' id='L179' title='0|0|0 - Total: 3'>        tooBigString = true;
</span>      } else {
<span class='uc' id='L181' title='2|2|2 - Total: 2'>        tooBigString = false;
</span>        // Ask for worst case scenario buffer when each char takes 3
        // bytes
<span class='uc' id='L184' title='7|7|7 - Total: 7'>        ensure(1 + 2 + strLen * 3);
</span><span class='uc' id='L185' title='3|3|3 - Total: 3'>        int top = itsTop;
</span>
<span class='uc' id='L187' title='6|6|6 - Total: 6'>        itsPool[top++] = CONSTANT_Utf8;
</span><span class='uc' id='L188' title='1|1|1 - Total: 1'>        top += 2; // skip length
</span>
<span class='uc' id='L190' title='5|5|5 - Total: 5'>        char[] chars = cfw.getCharBuffer(strLen);
</span><span class='uc' id='L191' title='6|6|6 - Total: 6'>        k.getChars(0, strLen, chars, 0);
</span>
<span class='uc' id='L193' title='2|2|2 - Total: 2'>        for (int i = 0; i != strLen; i++) {
</span><span class='uc' id='L194' title='4|4|4 - Total: 4'>          int c = chars[i];
</span><span class='uc' id='L195' title='4|4|4 - Total: 4'>          if (c != 0 && c <= 0x7F) {
</span><span class='uc' id='L196' title='8|8|8 - Total: 8'>            itsPool[top++] = (byte)c;
</span><span class='uc' id='L197' title='2|2|2 - Total: 2'>          } else if (c > 0x7FF) {
</span><span class='uc' id='L198' title='11|11|11 - Total: 11'>            itsPool[top++] = (byte)(0xE0 | (c >> 12));
</span><span class='uc' id='L199' title='13|13|13 - Total: 13'>            itsPool[top++] = (byte)(0x80 | ((c >> 6) & 0x3F));
</span><span class='uc' id='L200' title='12|12|12 - Total: 12'>            itsPool[top++] = (byte)(0x80 | (c & 0x3F));
</span>          } else {
<span class='uc' id='L202' title='11|11|11 - Total: 11'>            itsPool[top++] = (byte)(0xC0 | (c >> 6));
</span><span class='uc' id='L203' title='11|11|11 - Total: 11'>            itsPool[top++] = (byte)(0x80 | (c & 0x3F));
</span>          }
        }

<span class='uc' id='L207' title='9|9|9 - Total: 9'>        int utfLen = top - (itsTop + 1 + 2);
</span><span class='upc' id='L208' title='1|1|1 - Total: 2'>        if (utfLen > MAX_UTF_ENCODING_SIZE) {
</span><span class='nc' id='L209' title='0|0|0 - Total: 3'>          tooBigString = true;
</span>        } else {
          // Write back length
<span class='uc' id='L212' title='11|11|11 - Total: 11'>          itsPool[itsTop + 1] = (byte)(utfLen >>> 8);
</span><span class='uc' id='L213' title='9|9|9 - Total: 9'>          itsPool[itsTop + 2] = (byte)utfLen;
</span>
<span class='uc' id='L215' title='3|3|3 - Total: 3'>          itsTop = top;
</span><span class='uc' id='L216' title='8|8|8 - Total: 8'>          theIndex = itsTopIndex++;
</span><span class='uc' id='L217' title='5|5|5 - Total: 5'>          itsUtf8Hash.put(k, theIndex);
</span>        }
      }
<span class='upc' id='L220' title='1|1|1 - Total: 2'>      if (tooBigString) {
</span><span class='nc' id='L221' title='0|0|0 - Total: 5'>        throw new IllegalArgumentException("Too big string");
</span>      }
    }
<span class='uc' id='L224' title='4|4|4 - Total: 4'>    setConstantData(theIndex, k);
</span><span class='uc' id='L225' title='5|5|5 - Total: 5'>    itsPoolTypes.put(theIndex, CONSTANT_Utf8);
</span><span class='uc' id='L226' title='3|3|3 - Total: 3'>    return (short)theIndex;
</span>  }

  private short addNameAndType(String name, String type)
  {
<span class='uc' id='L231' title='4|4|4 - Total: 4'>    short nameIndex = addUtf8(name);
</span><span class='uc' id='L232' title='4|4|4 - Total: 4'>    short typeIndex = addUtf8(type);
</span><span class='uc' id='L233' title='3|3|3 - Total: 3'>    ensure(5);
</span><span class='uc' id='L234' title='11|11|11 - Total: 11'>    itsPool[itsTop++] = CONSTANT_NameAndType;
</span><span class='uc' id='L235' title='8|8|8 - Total: 8'>    itsTop = ClassFileWriter.putInt16(nameIndex, itsPool, itsTop);
</span><span class='uc' id='L236' title='8|8|8 - Total: 8'>    itsTop = ClassFileWriter.putInt16(typeIndex, itsPool, itsTop);
</span><span class='uc' id='L237' title='6|6|6 - Total: 6'>    itsPoolTypes.put(itsTopIndex, CONSTANT_NameAndType);
</span><span class='uc' id='L238' title='9|9|9 - Total: 9'>    return (short)(itsTopIndex++);
</span>  }

  short addClass(String className)
  {
<span class='uc' id='L243' title='6|6|6 - Total: 6'>    int theIndex = itsClassHash.get(className, -1);
</span><span class='uc' id='L244' title='2|2|2 - Total: 2'>    if (theIndex == -1) {
</span><span class='uc' id='L245' title='2|2|2 - Total: 2'>      String slashed = className;
</span><span class='uc' id='L246' title='2|2|2 - Total: 2'>      if (className.indexOf('.') > 0) {
</span><span class='uc' id='L247' title='3|3|3 - Total: 3'>        slashed = ClassFileWriter.getSlashedForm(className);
</span><span class='uc' id='L248' title='6|6|6 - Total: 6'>        theIndex = itsClassHash.get(slashed, -1);
</span><span class='uc' id='L249' title='2|2|2 - Total: 2'>        if (theIndex != -1) {
</span><span class='uc' id='L250' title='5|5|5 - Total: 5'>          itsClassHash.put(className, theIndex);
</span>        }
      }
<span class='uc' id='L253' title='2|2|2 - Total: 2'>      if (theIndex == -1) {
</span><span class='uc' id='L254' title='4|4|4 - Total: 4'>        int utf8Index = addUtf8(slashed);
</span><span class='uc' id='L255' title='3|3|3 - Total: 3'>        ensure(3);
</span><span class='uc' id='L256' title='11|11|11 - Total: 11'>        itsPool[itsTop++] = CONSTANT_Class;
</span><span class='uc' id='L257' title='8|8|8 - Total: 8'>        itsTop = ClassFileWriter.putInt16(utf8Index, itsPool, itsTop);
</span><span class='uc' id='L258' title='8|8|8 - Total: 8'>        theIndex = itsTopIndex++;
</span><span class='uc' id='L259' title='5|5|5 - Total: 5'>        itsClassHash.put(slashed, theIndex);
</span><span class='uc' id='L260' title='2|2|2 - Total: 2'>        if (!className.equals(slashed)) {
</span><span class='uc' id='L261' title='5|5|5 - Total: 5'>          itsClassHash.put(className, theIndex);
</span>        }
      }
    }
<span class='uc' id='L265' title='4|4|4 - Total: 4'>    setConstantData(theIndex, className);
</span><span class='uc' id='L266' title='5|5|5 - Total: 5'>    itsPoolTypes.put(theIndex, CONSTANT_Class);
</span><span class='uc' id='L267' title='3|3|3 - Total: 3'>    return (short)theIndex;
</span>  }

  short addFieldRef(String className, String fieldName, String fieldType)
  {
<span class='uc' id='L272' title='7|7|7 - Total: 7'>    FieldOrMethodRef ref = new FieldOrMethodRef(className, fieldName,
</span>        fieldType);

<span class='uc' id='L275' title='6|6|6 - Total: 6'>    int theIndex = itsFieldRefHash.get(ref, -1);
</span><span class='uc' id='L276' title='2|2|2 - Total: 2'>    if (theIndex == -1) {
</span><span class='uc' id='L277' title='5|5|5 - Total: 5'>      short ntIndex = addNameAndType(fieldName, fieldType);
</span><span class='uc' id='L278' title='4|4|4 - Total: 4'>      short classIndex = addClass(className);
</span><span class='uc' id='L279' title='3|3|3 - Total: 3'>      ensure(5);
</span><span class='uc' id='L280' title='11|11|11 - Total: 11'>      itsPool[itsTop++] = CONSTANT_Fieldref;
</span><span class='uc' id='L281' title='8|8|8 - Total: 8'>      itsTop = ClassFileWriter.putInt16(classIndex, itsPool, itsTop);
</span><span class='uc' id='L282' title='8|8|8 - Total: 8'>      itsTop = ClassFileWriter.putInt16(ntIndex, itsPool, itsTop);
</span><span class='uc' id='L283' title='8|8|8 - Total: 8'>      theIndex = itsTopIndex++;
</span><span class='uc' id='L284' title='5|5|5 - Total: 5'>      itsFieldRefHash.put(ref, theIndex);
</span>    }
<span class='uc' id='L286' title='4|4|4 - Total: 4'>    setConstantData(theIndex, ref);
</span><span class='uc' id='L287' title='5|5|5 - Total: 5'>    itsPoolTypes.put(theIndex, CONSTANT_Fieldref);
</span><span class='uc' id='L288' title='3|3|3 - Total: 3'>    return (short)theIndex;
</span>  }

  short addMethodRef(String className, String methodName,
      String methodType)
  {
<span class='uc' id='L294' title='7|7|7 - Total: 7'>    FieldOrMethodRef ref = new FieldOrMethodRef(className, methodName,
</span>        methodType);

<span class='uc' id='L297' title='6|6|6 - Total: 6'>    int theIndex = itsMethodRefHash.get(ref, -1);
</span><span class='uc' id='L298' title='2|2|2 - Total: 2'>    if (theIndex == -1) {
</span><span class='uc' id='L299' title='5|5|5 - Total: 5'>      short ntIndex = addNameAndType(methodName, methodType);
</span><span class='uc' id='L300' title='4|4|4 - Total: 4'>      short classIndex = addClass(className);
</span><span class='uc' id='L301' title='3|3|3 - Total: 3'>      ensure(5);
</span><span class='uc' id='L302' title='11|11|11 - Total: 11'>      itsPool[itsTop++] = CONSTANT_Methodref;
</span><span class='uc' id='L303' title='8|8|8 - Total: 8'>      itsTop = ClassFileWriter.putInt16(classIndex, itsPool, itsTop);
</span><span class='uc' id='L304' title='8|8|8 - Total: 8'>      itsTop = ClassFileWriter.putInt16(ntIndex, itsPool, itsTop);
</span><span class='uc' id='L305' title='8|8|8 - Total: 8'>      theIndex = itsTopIndex++;
</span><span class='uc' id='L306' title='5|5|5 - Total: 5'>      itsMethodRefHash.put(ref, theIndex);
</span>    }
<span class='uc' id='L308' title='4|4|4 - Total: 4'>    setConstantData(theIndex, ref);
</span><span class='uc' id='L309' title='5|5|5 - Total: 5'>    itsPoolTypes.put(theIndex, CONSTANT_Methodref);
</span><span class='uc' id='L310' title='3|3|3 - Total: 3'>    return (short)theIndex;
</span>  }

  short addInterfaceMethodRef(String className,
      String methodName, String methodType)
  {
<span class='uc' id='L316' title='5|5|5 - Total: 5'>    short ntIndex = addNameAndType(methodName, methodType);
</span><span class='uc' id='L317' title='4|4|4 - Total: 4'>    short classIndex = addClass(className);
</span><span class='uc' id='L318' title='3|3|3 - Total: 3'>    ensure(5);
</span><span class='uc' id='L319' title='11|11|11 - Total: 11'>    itsPool[itsTop++] = CONSTANT_InterfaceMethodref;
</span><span class='uc' id='L320' title='8|8|8 - Total: 8'>    itsTop = ClassFileWriter.putInt16(classIndex, itsPool, itsTop);
</span><span class='uc' id='L321' title='8|8|8 - Total: 8'>    itsTop = ClassFileWriter.putInt16(ntIndex, itsPool, itsTop);
</span><span class='uc' id='L322' title='7|7|7 - Total: 7'>    FieldOrMethodRef r = new FieldOrMethodRef(className, methodName,
</span>        methodType);
<span class='uc' id='L324' title='5|5|5 - Total: 5'>    setConstantData(itsTopIndex, r);
</span><span class='uc' id='L325' title='6|6|6 - Total: 6'>    itsPoolTypes.put(itsTopIndex, CONSTANT_InterfaceMethodref);
</span><span class='uc' id='L326' title='9|9|9 - Total: 9'>    return (short)(itsTopIndex++);
</span>  }

  short addInvokeDynamic(String methodName, String methodType, int bootstrapIndex)
  {
<span class='nc' id='L331' title='0|0|0 - Total: 8'>    ConstantEntry entry = new ConstantEntry(CONSTANT_InvokeDynamic,
</span>        bootstrapIndex, methodName, methodType);
<span class='nc' id='L333' title='0|0|0 - Total: 6'>    int theIndex = itsConstantHash.get(entry, -1);
</span>
<span class='nc' id='L335' title='0|0|0 - Total: 2'>    if (theIndex == -1) {
</span><span class='nc' id='L336' title='0|0|0 - Total: 5'>      short nameTypeIndex = addNameAndType(methodName, methodType);
</span><span class='nc' id='L337' title='0|0|0 - Total: 3'>      ensure(5);
</span><span class='nc' id='L338' title='0|0|0 - Total: 11'>      itsPool[itsTop++] = CONSTANT_InvokeDynamic;
</span><span class='nc' id='L339' title='0|0|0 - Total: 8'>      itsTop = ClassFileWriter.putInt16(bootstrapIndex, itsPool, itsTop);
</span><span class='nc' id='L340' title='0|0|0 - Total: 8'>      itsTop = ClassFileWriter.putInt16(nameTypeIndex, itsPool, itsTop);
</span><span class='nc' id='L341' title='0|0|0 - Total: 8'>      theIndex = itsTopIndex++;
</span><span class='nc' id='L342' title='0|0|0 - Total: 5'>      itsConstantHash.put(entry, theIndex);
</span><span class='nc' id='L343' title='0|0|0 - Total: 4'>      setConstantData(theIndex, methodType);
</span><span class='nc' id='L344' title='0|0|0 - Total: 5'>      itsPoolTypes.put(theIndex, CONSTANT_InvokeDynamic);
</span>    }
<span class='nc' id='L346' title='0|0|0 - Total: 3'>    return (short)(theIndex);
</span>  }

  short addMethodHandle(ClassFileWriter.MHandle mh)
  {
<span class='nc' id='L351' title='0|0|0 - Total: 6'>    int theIndex = itsConstantHash.get(mh, -1);
</span>
<span class='nc' id='L353' title='0|0|0 - Total: 2'>    if (theIndex == -1) {
</span>      short ref;
<span class='nc' id='L355' title='0|0|0 - Total: 2'>      if (mh.tag <= ByteCode.MH_PUTSTATIC) {
</span><span class='nc' id='L356' title='0|0|0 - Total: 10'>        ref = addFieldRef(mh.owner, mh.name, mh.desc);
</span><span class='nc' id='L357' title='0|0|0 - Total: 2'>      } else if (mh.tag == ByteCode.MH_INVOKEINTERFACE) {
</span><span class='nc' id='L358' title='0|0|0 - Total: 10'>        ref = addInterfaceMethodRef(mh.owner, mh.name, mh.desc);
</span>      } else {
<span class='nc' id='L360' title='0|0|0 - Total: 9'>        ref = addMethodRef(mh.owner, mh.name, mh.desc);
</span>      }

<span class='nc' id='L363' title='0|0|0 - Total: 3'>      ensure(4);
</span><span class='nc' id='L364' title='0|0|0 - Total: 11'>      itsPool[itsTop++] = CONSTANT_MethodHandle;
</span><span class='nc' id='L365' title='0|0|0 - Total: 12'>      itsPool[itsTop++] = mh.tag;
</span><span class='nc' id='L366' title='0|0|0 - Total: 8'>      itsTop = ClassFileWriter.putInt16(ref, itsPool, itsTop);
</span><span class='nc' id='L367' title='0|0|0 - Total: 8'>      theIndex = itsTopIndex++;
</span><span class='nc' id='L368' title='0|0|0 - Total: 5'>      itsConstantHash.put(mh, theIndex);
</span><span class='nc' id='L369' title='0|0|0 - Total: 5'>      itsPoolTypes.put(theIndex, CONSTANT_MethodHandle);
</span>    }
<span class='nc' id='L371' title='0|0|0 - Total: 3'>    return (short)(theIndex);
</span>  }

  Object getConstantData(int index)
  {
<span class='uc' id='L376' title='5|5|5 - Total: 5'>    return itsConstantData.getObject(index);
</span>  }

  void setConstantData(int index, Object data)
  {
<span class='uc' id='L381' title='5|5|5 - Total: 5'>    itsConstantData.put(index, data);
</span><span class='uc' id='L382' title='1|1|1 - Total: 1'>  }
</span>
  byte getConstantType(int index)
  {
<span class='uc' id='L386' title='7|7|7 - Total: 7'>    return (byte) itsPoolTypes.getInt(index, 0);
</span>  }

  private void ensure(int howMuch)
  {
<span class='uc' id='L391' title='2|2|2 - Total: 2'>    if (itsTop + howMuch > itsPool.length) {
</span><span class='uc' id='L392' title='6|6|6 - Total: 6'>      int newCapacity = itsPool.length * 2;
</span><span class='uc' id='L393' title='2|2|2 - Total: 2'>      if (itsTop + howMuch > newCapacity) {
</span><span class='uc' id='L394' title='5|5|5 - Total: 5'>        newCapacity = itsTop + howMuch;
</span>      }
<span class='uc' id='L396' title='3|3|3 - Total: 3'>      byte[] tmp = new byte[newCapacity];
</span><span class='uc' id='L397' title='8|8|8 - Total: 8'>      System.arraycopy(itsPool, 0, tmp, 0, itsTop);
</span><span class='uc' id='L398' title='3|3|3 - Total: 3'>      itsPool = tmp;
</span>    }
<span class='uc' id='L400' title='1|1|1 - Total: 1'>  }
</span>
  private ClassFileWriter cfw;

  private static final int MAX_UTF_ENCODING_SIZE = 65535;

<span class='uc' id='L406' title='5|5|5 - Total: 5'>  private UintMap itsStringConstHash = new UintMap();
</span><span class='uc' id='L407' title='5|5|5 - Total: 5'>  private ObjToIntMap itsUtf8Hash = new ObjToIntMap();
</span><span class='uc' id='L408' title='5|5|5 - Total: 5'>  private ObjToIntMap itsFieldRefHash = new ObjToIntMap();
</span><span class='uc' id='L409' title='5|5|5 - Total: 5'>  private ObjToIntMap itsMethodRefHash = new ObjToIntMap();
</span><span class='uc' id='L410' title='5|5|5 - Total: 5'>  private ObjToIntMap itsClassHash = new ObjToIntMap();
</span><span class='uc' id='L411' title='5|5|5 - Total: 5'>  private ObjToIntMap itsConstantHash = new ObjToIntMap();
</span>
  private int itsTop;
  private int itsTopIndex;
<span class='uc' id='L415' title='5|5|5 - Total: 5'>  private UintMap itsConstantData = new UintMap();
</span><span class='uc' id='L416' title='5|5|5 - Total: 5'>  private UintMap itsPoolTypes = new UintMap();
</span>  private byte itsPool[];
}
</pre></body></html><table class='legend'><tr><td class='nc'>Not Covered</td><td class='ac'>Covered by test suite 1</td><td class='bc'>Covered by test suite 2</td><td class='uc'>Covered by the union test suite</td><td class='apc'>Partially Covered by test suite 1</td><td class='bpc'>Partially Covered by test suite 2</td><td class='upc'>Partially Covered by the union test suite</td></tr></table>